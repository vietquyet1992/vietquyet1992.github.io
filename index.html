<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hộp công cụ của tôi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal/dist/bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Apply theme immediately to avoid FOUC (Flash of Unstyled Content)
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* New warm, soft yellow/orange background for light theme */
            background: linear-gradient(120deg, #fffbeb 0%, #fff7ed 100%);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            transition: background 0.5s ease;
        }
        .dark body {
             background: linear-gradient(-45deg, #1f2937, #374151);
             background-size: 400% 400%;
             animation: gradientBG 20s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Enhanced Glassmorphism effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .dark .glass-effect {
            background: rgba(30, 41, 59, 0.4); /* slate-800 with alpha */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tool-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .tool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }
        /* New accent color: Amber (Warm Yellow/Orange) */
        .nav-link.active {
            background-color: #f59e0b; /* amber-500 */
            color: white;
            box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.3);
        }
        textarea {
            resize: vertical;
        }
        
        /* BUG FIX: Stacking context for tool content */
        main {
            display: grid;
        }
        .tool-content {
            grid-area: 1 / 1;
            transition: opacity 0.4s ease-in-out;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(245, 158, 11, 0.5); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(245, 158, 11, 0.5); }

        /* Loader animation */
        .loader {
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid #f59e0b; /* amber-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 min-h-screen">
    
    <div class="flex">
        <!-- Sidebar Navigation -->
        <aside class="w-64 min-h-screen p-4 flex flex-col glass-effect">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400">My Toolbox</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">Công cụ tiện ích</p>
            </div>
            <nav class="flex flex-col space-y-2">
                 <a href="#" class="nav-link active group flex items-center px-4 py-3 rounded-lg transition-all duration-200" data-tool="remove-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 2a3.5 3.5 0 013.163 5.002L13 11.172V15a1 1 0 01-1 1H6a1 1 0 01-1-1v-3.828l4.337-4.17A3.5 3.5 0 115.5 2zM4.5 3.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" /><path d="M11.94 11.513l-1.34-1.29a.75.75 0 00-1.06 1.06l1.5 1.44a.75.75 0 001.12-.001l3.5-3.719a.75.75 0 00-1.08-1.04l-2.64 2.79z" /></svg>
                    <span class="font-medium">Tách nền ảnh</span>
                </a>
                <a href="#" class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="png-to-ico">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                    <span class="font-medium">PNG to ICO</span>
                </a>
                <a href="#" class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="base64">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 3a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1h2a1 1 0 011 1v1h4V6a1 1 0 011-1h2a1 1 0 011 1v1z" clip-rule="evenodd" /></svg>
                    <span class="font-medium">Base64 Multi-layer</span>
                </a>
            </nav>
            <div class="mt-auto p-4">
                <button id="theme-toggle" class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto min-h-screen">
            <!-- Background Remover Tool -->
            <div id="tool-remove-bg" class="tool-content">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-amber-400">Tách nền ảnh</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Tải lên một hình ảnh để tự động xóa nền. Toàn bộ quá trình xử lý diễn ra trên trình duyệt của bạn, đảm bảo riêng tư.</p>
                    <div class="space-y-4">
                        <input type="file" id="bg-remove-input" accept="image/png, image/jpeg" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100/50 dark:file:bg-amber-900/50 file:text-amber-700 dark:file:text-amber-300 hover:file:bg-amber-100/70 dark:hover:file:bg-amber-800/50 cursor-pointer"/>
                        <div id="bg-remove-previews" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div>
                                <p class="text-sm font-medium mb-2">Ảnh gốc:</p>
                                <img id="bg-remove-original" class="w-full rounded-lg border border-gray-200/50 dark:border-gray-700/50"/>
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2">Đã tách nền:</p>
                                <div class="w-full aspect-video rounded-lg border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center bg-gray-100/50 dark:bg-gray-700/50" style="background-image: repeating-conic-gradient(#d1d5db80 0 25%, #e5e7eb80 0 50%); background-size: 16px 16px;">
                                     <img id="bg-remove-result" class="hidden max-w-full max-h-full"/>
                                     <div id="bg-remove-loader" class="loader hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button id="bg-remove-process-btn" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-amber-500/40" disabled>Tách nền</button>
                            <button id="bg-remove-download-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-green-500/50" disabled>Tải xuống kết quả</button>
                        </div>
                        <div id="bg-remove-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5"></div>
                    </div>
                </div>
            </div>

            <!-- PNG to ICO Converter Tool -->
            <div id="tool-png-to-ico" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-amber-400">Chuyển đổi PNG sang ICO</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Tải lên tệp PNG và chọn kích thước để tạo tệp ICO (biểu tượng trang web).</p>
                    <div class="space-y-4">
                        <input type="file" id="png-file-input" accept="image/png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100/50 dark:file:bg-amber-900/50 file:text-amber-700 dark:file:text-amber-300 hover:file:bg-amber-100/70 dark:hover:file:bg-amber-800/50 cursor-pointer"/>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium mb-2">Ảnh xem trước:</p>
                            <img id="image-preview" class="max-w-xs max-h-32 rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                        </div>
                        <div>
                            <label for="ico-size-select" class="block font-medium mb-2">Chọn kích thước:</label>
                            <select id="ico-size-select" class="w-full sm:w-auto p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                                <option value="16">16x16 pixels</option>
                                <option value="32" selected>32x32 pixels</option>
                                <option value="48">48x48 pixels</option>
                                <option value="64">64x64 pixels</option>
                                <option value="128">128x128 pixels</option>
                            </select>
                        </div>
                        <button id="convert-to-ico-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-amber-500/40" disabled>Chuyển đổi & Tải xuống</button>
                        <div id="ico-status" class="text-sm text-green-600 dark:text-green-400 mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Base64 Encoder/Decoder Tool -->
            <div id="tool-base64" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                     <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-amber-400">Mã hóa & Giải mã Base64</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Mã hóa (1 lần) hoặc giải mã (nhiều lớp) chuỗi văn bản của bạn.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="base64-input" class="font-medium">Đầu vào:</label>
                            <textarea id="base64-input" rows="8" class="w-full p-3 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="base64-output" class="font-medium">Kết quả:</label>
                            <textarea id="base64-output" rows="8" readonly class="w-full p-3 bg-gray-100/50 dark:bg-slate-800/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg cursor-not-allowed"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="base64-encode-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">Mã hóa (Encode)</button>
                        <button id="base64-decode-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-blue-500/50">Giải mã (Decode)</button>
                        <button id="base64-copy-btn" class="sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-gray-500/50">Sao chép</button>
                    </div>
                    <div id="base64-status" class="text-sm mt-4"></div>
                </div>
            </div>
            
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Logic Theme Toggle ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');

            // Show correct icon on page load
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }

            themeToggleBtn.addEventListener('click', () => {
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                document.documentElement.classList.toggle('dark');
                if (document.documentElement.classList.contains('dark')) {
                    localStorage.setItem('theme', 'dark');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });

            // --- Logic chuyển đổi tab công cụ ---
            const navLinks = document.querySelectorAll('.nav-link');
            const toolContents = document.querySelectorAll('.tool-content');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const toolId = link.dataset.tool;
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    link.classList.add('active');

                    toolContents.forEach(content => {
                        const isTarget = content.id === `tool-${toolId}`;
                        if (isTarget) {
                            content.classList.remove('hidden');
                            setTimeout(() => content.classList.remove('opacity-0'), 10); // Fade in
                        } else {
                            content.classList.add('opacity-0');
                            setTimeout(() => content.classList.add('hidden'), 400); // Hide after fade out
                        }
                    });
                });
            });

            // --- Logic công cụ PNG to ICO ---
            // (The existing JavaScript logic for all tools remains unchanged)
            const pngFileInput = document.getElementById('png-file-input');
            const convertBtn = document.getElementById('convert-to-ico-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const icoStatus = document.getElementById('ico-status');
            const icoSizeSelect = document.getElementById('ico-size-select');

            pngFileInput.addEventListener('change', () => {
                const file = pngFileInput.files[0];
                if (file) {
                    convertBtn.disabled = false;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    convertBtn.disabled = true;
                    imagePreviewContainer.classList.add('hidden');
                }
            });

            // CORRECT ICO CONVERSION LOGIC
            convertBtn.addEventListener('click', () => {
                const file = pngFileInput.files[0];
                if (!file) return;

                const size = parseInt(icoSizeSelect.value, 10);

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, size, size);

                        // This function now creates a TRUE ICO file blob
                        const icoBlob = await createIcoBlob(canvas);

                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(icoBlob);
                        link.download = 'favicon.ico';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        icoStatus.textContent = `Tệp favicon.ico (${size}x${size}) đã được tải xuống!`;
                        setTimeout(() => { icoStatus.textContent = '' }, 3000);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            async function createIcoBlob(canvas) {
                const pngDataUrl = canvas.toDataURL('image/png');
                const response = await fetch(pngDataUrl);
                const pngData = await response.arrayBuffer();

                const header = new ArrayBuffer(6);
                const headerView = new DataView(header);
                headerView.setUint16(0, 0, true); // Reserved, must be 0
                headerView.setUint16(2, 1, true); // Image type (1 for ICO)
                headerView.setUint16(4, 1, true); // Number of images

                const imageEntry = new ArrayBuffer(16);
                const imageEntryView = new DataView(imageEntry);
                imageEntryView.setUint8(0, canvas.width); // Width
                imageEntryView.setUint8(1, canvas.height); // Height
                imageEntryView.setUint8(2, 0); // Color palette count
                imageEntryView.setUint8(3, 0); // Reserved, should be 0
                imageEntryView.setUint16(4, 1, true); // Color planes
                imageEntryView.setUint16(6, 32, true); // Bits per pixel
                imageEntryView.setUint32(8, pngData.byteLength, true); // Size of image data
                imageEntryView.setUint32(12, 22, true); // Offset of image data (6 for header + 16 for entry)

                return new Blob([header, imageEntry, pngData], { type: 'image/x-icon' });
            }


            // --- Logic công cụ Base64 ---
            const base64Input = document.getElementById('base64-input');
            const base64Output = document.getElementById('base64-output');
            const encodeBtn = document.getElementById('base64-encode-btn');
            const decodeBtn = document.getElementById('base64-decode-btn');
            const copyBtn = document.getElementById('base64-copy-btn');
            const base64Status = document.getElementById('base64-status');
            
            function safeBtoa(str) {
                try { return btoa(unescape(encodeURIComponent(str))); } catch (e) { return null; }
            }
            
            function safeAtob(str) {
                try { return decodeURIComponent(escape(atob(str))); } catch (e) { return null; }
            }

            encodeBtn.addEventListener('click', () => {
                const input = base64Input.value;
                if (!input) { base64Output.value = ''; return; }
                const encoded = safeBtoa(input);
                 if (encoded) {
                    base64Output.value = encoded;
                    base64Status.textContent = 'Mã hóa thành công!';
                } else {
                    base64Output.value = 'Lỗi: Dữ liệu đầu vào không hợp lệ.';
                    base64Status.textContent = 'Mã hóa thất bại.';
                }
                setTimeout(() => { base64Status.textContent = '' }, 3000);
            });

            decodeBtn.addEventListener('click', () => {
                let currentString = base64Input.value;
                if (!currentString) { base64Output.value = ''; return; }
                let decoded;
                let decodeCount = 0;
                let lastValidString = currentString;
                while (true) {
                    decoded = safeAtob(currentString);
                    if (decoded !== null && decoded !== currentString) {
                        currentString = decoded;
                        lastValidString = decoded;
                        decodeCount++;
                    } else { break; }
                }
                base64Output.value = lastValidString;
                if (decodeCount > 0) {
                    base64Status.textContent = `Giải mã thành công qua ${decodeCount} lớp.`;
                } else {
                    base64Status.textContent = 'Không thể giải mã thêm, chuỗi không phải là Base64 hợp lệ.';
                }
                setTimeout(() => { base64Status.textContent = '' }, 4000);
            });
            
            copyBtn.addEventListener('click', () => {
                if (!base64Output.value) return;
                const textarea = document.createElement('textarea');
                textarea.value = base64Output.value;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    base64Status.textContent = 'Đã sao chép kết quả!';
                } catch (err) {
                    base64Status.textContent = 'Không thể sao chép!';
                }
                document.body.removeChild(textarea);
                setTimeout(() => { base64Status.textContent = '' }, 3000);
            });

            // --- Logic công cụ Tách nền ---
            const bgRemoveInput = document.getElementById('bg-remove-input');
            const bgRemovePreviews = document.getElementById('bg-remove-previews');
            const bgRemoveOriginal = document.getElementById('bg-remove-original');
            const bgRemoveResult = document.getElementById('bg-remove-result');
            const bgRemoveLoader = document.getElementById('bg-remove-loader');
            const bgRemoveProcessBtn = document.getElementById('bg-remove-process-btn');
            const bgRemoveDownloadBtn = document.getElementById('bg-remove-download-btn');
            const bgRemoveStatus = document.getElementById('bg-remove-status');
            let resultBlob = null;
            let isBgRemovalLibReady = false;

            // NEW: Smart library loader
            function initializeBgRemover() {
                bgRemoveStatus.textContent = 'Đang khởi tạo thư viện...';
                
                const checkInterval = setInterval(() => {
                    if (typeof window.removeBackground === 'function') {
                        clearInterval(checkInterval);
                        isBgRemovalLibReady = true;
                        // If a file is already selected by the user, update status and enable button
                        if (bgRemoveInput.files.length > 0) {
                            bgRemoveStatus.textContent = 'Sẵn sàng để tách nền.';
                            bgRemoveProcessBtn.disabled = false;
                        } else {
                            bgRemoveStatus.textContent = 'Vui lòng chọn một ảnh để bắt đầu.';
                        }
                    }
                }, 200);

                // Add a timeout to prevent infinite loop if CDN fails
                setTimeout(() => {
                    if (!isBgRemovalLibReady) {
                        clearInterval(checkInterval);
                        bgRemoveStatus.textContent = 'Lỗi: Không thể tải thư viện. Vui lòng làm mới trang.';
                    }
                }, 20000); // 20-second timeout
            }

            initializeBgRemover(); // Start the loader


            bgRemoveInput.addEventListener('change', () => {
                const file = bgRemoveInput.files[0];
                if (file) {
                    resultBlob = null;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        bgRemoveOriginal.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    bgRemovePreviews.classList.remove('hidden');
                    bgRemoveResult.classList.add('hidden');
                    bgRemoveLoader.classList.add('hidden');
                    bgRemoveDownloadBtn.disabled = true;

                    // Only enable the button if the library is ready
                    if (isBgRemovalLibReady) {
                        bgRemoveProcessBtn.disabled = false;
                        bgRemoveStatus.textContent = 'Sẵn sàng để tách nền.';
                    } else {
                        bgRemoveProcessBtn.disabled = true;
                        bgRemoveStatus.textContent = 'Đang tải thư viện, vui lòng đợi...';
                    }
                }
            });

            bgRemoveProcessBtn.addEventListener('click', async () => {
                // The button is only clickable if the library is ready, so no need for the old check
                const file = bgRemoveInput.files[0];
                if (!file) return;

                bgRemoveLoader.classList.remove('hidden');
                bgRemoveResult.classList.add('hidden');
                bgRemoveStatus.textContent = 'Đang khởi tạo...';
                bgRemoveProcessBtn.disabled = true;
                bgRemoveDownloadBtn.disabled = true;

                try {
                    resultBlob = await window.removeBackground(file, {
                        progress: (key, current, total) => {
                            const [action, model] = key.split(':');
                            const progress = ((current / total) * 100).toFixed(0);
                            let statusText = 'Đang xử lý...';
                            if (action === 'compute') statusText = `Đang phân tích ảnh: ${progress}%`;
                            if (action === 'download') statusText = `Đang tải model (${model}): ${progress}%`;
                            bgRemoveStatus.textContent = statusText;
                        }
                    });
                    bgRemoveResult.src = URL.createObjectURL(resultBlob);
                    bgRemoveResult.classList.remove('hidden');
                    bgRemoveDownloadBtn.disabled = false;
                    bgRemoveStatus.textContent = 'Tách nền thành công!';
                } catch (error) {
                    console.error('Background removal error:', error);
                    let errorMessage = 'Đã xảy ra lỗi khi tách nền.';
                    if (error && error.message) {
                        errorMessage = `Lỗi: ${error.message}. Thử lại với ảnh có chủ thể rõ ràng hơn.`;
                    } else {
                        errorMessage += ' Kiểm tra kết nối mạng hoặc thử lại với ảnh khác.';
                    }
                    bgRemoveStatus.textContent = errorMessage;
                } finally {
                    bgRemoveLoader.classList.add('hidden');
                    bgRemoveProcessBtn.disabled = false;
                }
            });

            bgRemoveDownloadBtn.addEventListener('click', () => {
                if (!resultBlob) return;
                const originalFile = bgRemoveInput.files[0];
                const fileName = originalFile.name.replace(/\.[^/.]+$/, "") + '-no-bg.png';

                const link = document.createElement('a');
                link.href = URL.createObjectURL(resultBlob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>

