<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVQ's World</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5/dist/autoNumeric.min.js"></script>
    <script src="tinymce/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=4.0">
    <script>
        if (localStorage.theme === 'dark' || !('theme' in localStorage)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body class="text-black dark:text-gray-100 min-h-screen">
    <audio id="nhac-nen-cua-ba" src="assets/am-thanh.mp3" loop></audio>
    <div class="lg:flex">
        <aside class="lg:w-64 w-full lg:min-h-screen p-4 flex flex-col glass-effect">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400">My Toolbox</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">C├┤ng cр╗Ц & р╗еng dр╗Цng</p>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="nav-link active group flex items-center px-4 py-3 rounded-lg transition-all duration-200 
text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="remove-bg">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5.5 2a3.5 3.5 0 013.163 5.002L13 11.172V15a1 1 0 01-1 1H6a1 1 0 01-1-1v-3.828l4.337-4.17A3.5 3.5 0 115.5 2zM4.5 3.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" />
                        <path
                            d="M11.94 11.513l-1.34-1.29a.75.75 0 00-1.06 1.06l1.5 1.44a.75.75 0 001.12-.001l3.5-3.719a.75.75 0 00-1.08-1.04l-2.64 2.79z" />
                    </svg>
                    <span class="font-medium">T├Аch nр╗Ђn р║Бnh</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="png-to-ico">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">PNG to ICO</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="base64">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 3a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1h2a1 1 0 011 1v1h4V6a1 1 0 011-1h2a1 1 0 011 1v1z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Base64 Multi-layer</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-apps">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span class="font-medium">My Apps</span>
                </a>
                <a href="#" id="nav-my-diary"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="events-public"><svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 15.791c.001-.06.002-.12.002-.181a9.96 9.96 0 0 0-1.89-5.748c-.538-.68-1.15-1.29-1.844-1.796a10.003 10.003 0 0 0-14.24 0C2.33 8.78 1.719 9.39 1.181 10.071a9.96 9.96 0 0 0-1.89 5.748c0 .06.001.121.002.181C.02 17.65 1.7 19.4 4.5 21c2.148 1.2 4.968 1.8 7.5 1.8s5.352-.6 7.5-1.8c2.8-1.6 4.48-3.35 4.5-5.209Z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 15.791c.001-.06.002-.12.002-.181a9.96 9.96 0 0 0-1.89-5.748c-.538-.68-1.15-1.29-1.844-1.796a10.003 10.003 0 0 0-14.24 0C2.33 8.78 1.719 9.39 1.181 10.071a9.96 9.96 0 0 0-1.89 5.748c0 .06.001.121.002.181C.02 17.65 1.7 19.4 4.5 21c2.148 1.2 4.968 1.8 7.5 1.8s5.352-.6 7.5-1.8c2.8-1.6 4.48-3.35 4.5-5.209Zm0 0H.002" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 10.5V12m0 0a1.5 1.5 0 0 0 3 0V10.5m-3 0h3m-3 0a1.5 1.5 0 1 0-3 0m3 0a1.5 1.5 0 1 1 3 0m0 0a1.5 1.5 0 1 0 3 0" />
                    </svg>
                    <span class="font-medium">G├│c Bр║Цt Ngр╗Ю</span></a>
                <svg xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                    viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" />
                </svg>
                </a>
                <a href="#" id="nav-my-research"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-research">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V2.75A.75.75 0 0110 2zM8.5 4.5A.75.75 0 007.75 5.25v1.25a.75.75 0 001.5 0V5.25A.75.75 0 008.5 4.5zM12.25 5.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0V5.25zM10 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V10.75A.75.75 0 0110 10zM8.5 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM12.25 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM5.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75V10.75A.75.75 0 015.5 10zM4 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM6.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM14.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H14.5a.75.75 0 01-.75-.75V10.75A.75.75 0 0114.5 10zM13 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM15.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">My Blog</span>
                </a>
                <a href="#" id="nav-badminton-scheduler"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="badminton-scheduler">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">B Scheduler</span>
                </a>

                <a href="#" id="nav-admin-panel"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="admin-panel">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Admin Panel</span>
                </a>

            </nav>
            <div class="mt-auto">
                <div class="p-4">
                    <button id="theme-toggle"
                        class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div id="guest-view" class="text-center pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                    <p id="admin-login-btn"
                        class="text-base text-gray-500 dark:text-gray-400 cursor-pointer hover:text-amber-500 dark:hover:text-amber-400 transition-colors">
                        &copy; 2025 Ti├фu Viр║┐t Quyр║┐t
                    </p>
                </div>
                <div id="admin-view" class="p-4 border-t border-gray-300/50 dark:border-gray-600/50"
                    style="display: none;">
                    <div class="flex items-center space-x-3">
                        <img id="admin-avatar" src="images/favicon.png" alt="Avatar"
                            class="h-10 w-10 rounded-full border-2 border-amber-500 object-cover">
                        <div class="flex-1">
                            <p id="admin-name" class="font-semibold text-sm text-gray-800 dark:text-gray-100">Ch├аo ba!
                            </p>
                            <a href="#" id="admin-logout-btn"
                                class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">─љ─Ѓng
                                xuр║Цt</a>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto min-h-screen">
            <div id="tool-remove-bg" class="tool-content">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">T├Аch nр╗Ђn р║Бnh</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tр║Бi l├фn mр╗Ўt h├гnh р║Бnh ─Љр╗Ѓ tр╗▒ ─Љр╗Ўng x├│a nр╗Ђn bр║▒ng API
                        cр╗Дa Photoroom.</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="bg-remove-input"
                                class="cursor-pointer bg-gray-300 text-gray-700 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chр╗Їn tр╗Єp...
                            </label>
                            <span id="bg-remove-filename" class="text-sm text-gray-500 dark:text-gray-300">Chк░a chр╗Їn tр╗Єp
                                n├аo.</span>
                            <input type="file" id="bg-remove-input" accept="image/png, image/jpeg" class="hidden" />
                        </div>
                        <div id="bg-remove-previews" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">р║бnh gр╗Љc:</p>
                                <img id="bg-remove-original"
                                    class="w-full rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">─љ├Б t├Аch nр╗Ђn:</p>
                                <div class="w-full aspect-video rounded-lg border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center bg-gray-100/50 dark:bg-gray-700/50"
                                    style="background-image: repeating-conic-gradient(#d1d5db80 0 25%, #e5e7eb80 0 50%); background-size: 16px 16px;">
                                    <img id="bg-remove-result" class="hidden max-w-full max-h-full" />
                                    <div id="bg-remove-loader" class="loader hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button id="bg-remove-process-btn"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>T├Аch nр╗Ђn</button>
                            <button id="bg-remove-download-btn"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>Tр║Бi xuр╗Љng kр║┐t quр║Б</button>
                        </div>
                        <div id="bg-remove-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5"></div>
                    </div>
                </div>
            </div>
            <div id="tool-png-to-ico" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Chuyр╗Ѓn ─Љр╗Ћi PNG sang ICO</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tр║Бi l├фn tр╗Єp PNG v├а chр╗Їn k├Гch thк░р╗Џc ─Љр╗Ѓ tр║Аo tр╗Єp ICO
                        (biр╗Ѓu tк░р╗Бng trang web).</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="png-file-input"
                                class="cursor-pointer bg-gray-300 text-gray-500 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chр╗Їn tр╗Єp...
                            </label>
                            <span id="png-filename" class="text-sm text-gray-500 dark:text-gray-300">Chк░a chр╗Їn tр╗Єp
                                n├аo.</span>
                            <input type="file" id="png-file-input" accept="image/png" class="hidden" />
                        </div>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium mb-2 dark:text-gray-300">р║бnh xem trк░р╗Џc:</p>
                            <img id="image-preview"
                                class="max-w-xs max-h-32 rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                        </div>
                        <div>
                            <label for="ico-size-select" class="block font-medium mb-2 dark:text-gray-300">Chр╗Їn k├Гch
                                thк░р╗Џc:</label>
                            <select id="ico-size-select"
                                class="w-full sm:w-auto p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                                <option value="16">16x16 pixels</option>
                                <option value="32" selected>32x32 pixels</option>
                                <option value="48">48x48 pixels</option>
                                <option value="64">64x64 pixels</option>
                                <option value="128">128x128 pixels</option>
                            </select>
                        </div>
                        <button id="convert-to-ico-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 
disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none 
dark:disabled:bg-gray-600/50 dark:disabled:text-gray-400 
shadow-lg hover:shadow-amber-500/40" disabled>Chuyр╗Ѓn ─Љр╗Ћi & Tр║Бi xuр╗Љng</button>
                        <div id="ico-status" class="text-sm text-green-600 dark:text-green-400 mt-2"></div>
                    </div>
                </div>
            </div>
            <div id="tool-base64" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">M├Б h├│a & Giр║Бi m├Б Base64</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">M├Б h├│a (1 lр║Дn) hoр║иc giр║Бi m├Б (nhiр╗Ђu lр╗Џp) chuр╗Ќi v─Ѓn
                        bр║Бn cр╗Дa bр║Аn.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="base64-input" class="font-medium dark:text-gray-300">─љр║Дu v├аo:</label>
                            <textarea id="base64-input" rows="8"
                                class="w-full p-3 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="base64-output" class="font-medium dark:text-gray-300">Kр║┐t quр║Б:</label>
                            <textarea id="base64-output" rows="8" readonly
                                class="w-full p-3 bg-gray-100/50 dark:bg-slate-800/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg cursor-not-allowed"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="base64-encode-btn"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">M├Б
                            h├│a (Encode)</button>
                        <button id="base64-decode-btn"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-blue-500/50">Giр║Бi
                            m├Б (Decode)</button>
                    </div>
                    <div id="base64-status" class="text-sm mt-4"></div>
                </div>
            </div>
            <div id="tool-my-apps" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">р╗еng dр╗Цng cр╗Дa t├┤i</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tр╗Ћng hр╗Бp c├Аc р╗Еng dр╗Цng Windows do t├┤i ph├Аt triр╗Ѓn.
                        Nhр║Цn ─Љр╗Ѓ tр║Бi vр╗Ђ v├а trр║Бi nghiр╗Єm!</p>
                    <div id="apps-list" class="space-y-6">
                        <div id="apps-loader" class="flex justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <p id="apps-empty-state" class="text-center text-gray-500 py-8 hidden">Chк░a c├│ р╗Еng dр╗Цng n├аo ─Љк░р╗Бc
                            th├фm.</p>
                    </div>
                </div>
            </div>
            <div id="tool-events-public" class="tool-content hidden opacity-0">
                ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="p-8 tool-card glass-effect">
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h2 class="text-2xl font-bold mb-6 text-amber-600 dark:text-gray-50">G├│c Bр║Цt Ngр╗Ю
                    </h2>
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div id="events-public-list" class="space-y-4">
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <p id="events-public-loading" class="text-gray-500">─љang tр║Бi danh s├Аch
                            sр╗▒ kiр╗Єn...</p>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <p id="events-public-empty" class="text-gray-500 hidden">H├┤m nay kh├┤ng
                            c├│ sр╗▒ kiр╗Єn g├г ─Љр║иc biр╗Єt cр║Б.</p>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                ┬а ┬а ┬а ┬а ┬а ┬а </div>
            <div id="tool-my-research" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Mр╗Ўt v├аi b├аi viр║┐t do chр╗Еc n─Ѓng
                        Deep Research cр╗Дa Gemini tр║Аo ra!</h2>
                    <div id="blog-admin-controls" class="hidden">
                        <button id="blog-create-new-btn"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/40 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Tр║Аo b├аi viр║┐t mр╗Џi</span>
                        </button>
                    </div>
                    <div id="blog-posts-list" class="space-y-6">
                        <p id="blog-loading-state" class="text-center text-gray-500 py-8">─љang
                            tр║Бi b├аi viр║┐t...</p>
                        <p id="blog-empty-state" class="text-center text-gray-500 py-8 hidden">
                            Chк░a c├│ b├аi viр║┐t n├аo.</p>
                    </div>

                    <div id="blog-pagination-controls" class="hidden flex items-center justify-between mt-8">
                        <button id="blog-prev-btn"
                            class="font-bold py-2 px-6 rounded-lg transition duration-300 
                                   bg-amber-500 hover:bg-amber-600 text-white shadow-lg hover:shadow-amber-500/40 
                                   disabled:bg-gray-200/50 disabled:dark:bg-gray-700/50 disabled:text-gray-700 disabled:dark:text-gray-300 disabled:shadow-none disabled:cursor-not-allowed disabled:hover:bg-gray-200/50 disabled:dark:hover:bg-gray-600/70">
                            &larr; Trang trк░р╗Џc
                        </button>
                        <span id="blog-page-indicator" class="font-semibold text-gray-700 dark:text-gray-300">Trang 1 /
                            1</span>
                        <button id="blog-next-btn"
                            class="font-bold py-2 px-6 rounded-lg transition duration-300 
                                   bg-amber-500 hover:bg-amber-600 text-white shadow-lg hover:shadow-amber-500/40 
                                   disabled:bg-gray-200/50 disabled:dark:bg-gray-700/50 disabled:text-gray-700 disabled:dark:text-gray-300 disabled:shadow-none disabled:cursor-not-allowed disabled:hover:bg-gray-200/50 disabled:dark:hover:bg-gray-600/70">
                            Trang sau &rarr;
                        </button>
                    </div>

                </div>
            </div>
            <div id="tool-badminton-scheduler" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Badminton Scheduler</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tр╗Ћng tiр╗Ђn ─Љ├Б
                                nр╗Ўp:</label>
                            <p id="badminton-total-deposited"
                                class="text-2xl font-bold text-green-600 dark:text-green-400">0 ─Љ
                            </p>
                            <div class="mt-4 flex gap-2">
                                <input type="text" id="badminton-add-deposit" placeholder="Nр╗Ўp th├фm..."
                                    class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" />
                                <button id="badminton-submit-deposit"
                                    class="p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-all shadow-lg hover:shadow-green-500/50">
                                    [+]
                                </button>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tр╗Ћng sр╗Љ ng├аy
                                ─Љi:</label>
                            <p id="badminton-total-days" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0
                                ng├аy</p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tр╗Ћng sр╗Љ tiр╗Ђn s├бn
                                (th├Аng n├аy):</label>
                            <p id="badminton-total-cost" class="text-2xl font-bold text-red-500 dark:text-red-400">0 ─Љ
                            </p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Sр╗Љ tiр╗Ђn c├▓n
                                lр║Аi:</label>
                            <p id="badminton-remaining-balance"
                                class="text-2xl font-bold text-amber-600 dark:text-amber-400">0
                                ─Љ</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <button id="calendar-prev-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <h3 id="calendar-month-year"
                                class="text-xl font-bold text-center text-amber-600 dark:text-amber-400">Th├Аng 11 / 2025
                            </h3>
                            <button id="calendar-next-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 dark:text-gray-400">
                            <div class="calendar-header">Thр╗Е 2</div>
                            <div class="calendar-header">Thр╗Е 3</div>
                            <div class="calendar-header">Thр╗Е 4</div>
                            <div class="calendar-header">Thр╗Е 5</div>
                            <div class="calendar-header">Thр╗Е 6</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Thр╗Е 7</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Chр╗Д Nhр║Гt</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tool-admin-panel" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">C├аi ─Љр║иt Hiр╗Ѓn thр╗І</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Chр╗Їn nhр╗»ng tab m├а <span
                            class="font-bold text-red-500">Kh├Аch (Guest)</span> c├│ thр╗Ѓ thр║Цy.</p>

                    <div class="space-y-4 max-w-md">
                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="toggle-events-public"
                                class="font-medium text-gray-700 dark:text-gray-200">Hiр╗Єn "G├│c Bр║Цt Ngр╗Ю"</label>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="checkbox" id="toggle-events-public" ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                                ┬а ┬а ┬а ┬а class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-research" class="font-medium text-gray-700 dark:text-gray-200">Hiр╗Єn
                                "My Blog"</label>
                            <input type="checkbox" id="toggle-research"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-badminton" class="font-medium text-gray-700 dark:text-gray-200">Hiр╗Єn
                                "B Scheduler"</label>
                            <input type="checkbox" id="toggle-badminton"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>
                    </div>

                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                    <hr class="my-8 border-gray-300/50 dark:border-gray-600/50">

                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Quр║Бn l├й
                        Sр╗▒ kiр╗Єn</h2>
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <p class="text-gray-800 dark:text-gray-300 mb-6">Tр║Аo, sр╗Гa, x├│a, v├а bр║Гt/tр║»t
                        c├Аc thiр╗Єp ch├║c mр╗Фng.</p>

                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div
                        class="space-y-4 p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg mb-6">
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="event-admin-title"
                                class="block font-medium mb-1 dark:text-gray-300">T├фn Sр╗▒ kiр╗Єn:</label>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="text" id="event-admin-title"
                                placeholder="V├Г dр╗Ц: SN Cр║Гu ├џt" ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                                class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <label for="event-admin-greeting"
                                class="block font-medium mb-1 dark:text-gray-300">Lр╗Юi ch├║c:</label>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <textarea id="event-admin-greeting" rows="4"
                                placeholder="Ch├║c Cр║Гu ├џt lu├┤n..." ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                                class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div class="flex gap-4">
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button id="event-admin-save-btn" ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                                ┬а ┬а ┬а ┬а ┬а
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">Lк░u
                                Sр╗▒ kiр╗Єn Mр╗Џi</button>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button id="event-admin-cancel-btn" ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                                ┬а ┬а ┬а ┬а ┬а ┬а
                                class="hidden bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">Hр╗Дy
                                Sр╗Гa</button>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="hidden" id="event-admin-edit-id">
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>

                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h3
                        class="text-xl font-bold mb-4 text-amber-600 dark:text-gray-50">Danh s├Аch Sр╗▒ kiр╗Єn</h3>
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div id="event-admin-list" class="space-y-3">
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <p id="event-admin-loading" class="text-gray-500">─љang tр║Бi danh
                            s├Аch...</p>
                        ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а </div>
                    ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
                </div>
                ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а
            </div>
    </div>
    </div>
    </main>
    </div>

    </div>
    </main>
    </div>
    <footer class="text-center py-4 mt-8 relative">
        <p class="text-base text-gray-500 dark:text-gray-400">
            Thр╗Юi ─Љр║Аi AI ─Љang ─Љр║┐n!!!! <br>
            Tр║Цt cр║Б mр╗Їi thр╗Е р╗Ъ ─Љ├бy ─Љр╗Ђu ─Љк░р╗Бc tр║Аo bр║▒ng Gemini.
        </p>
        <div class="absolute right-4 bottom-4 hidden sm:block">
            <p id="visit-counter" class="text-xs text-gray-400 dark:text-gray-500 text-right">
                Lк░р╗Бt truy cр║Гp: ─љang tр║Бi...
            </p>
        </div>
    </footer>
    <div id="role-selection-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-sm glass-effect">
            <h3 class="text-3xl font-extrabold text-center mb-6 text-pink-600 dark:text-pink-400">TRр╗юI каI, Bр║аN Tр╗џI Rр╗њI!
                ­ЪјЅ</h3>
            <p class="text-center mb-8 text-gray-100 dark:text-gray-100">Bр║Аn l├а fan Manchester United hay fan ─Љр╗Ўi kh├Аc
                Fan ─Љр╗Ўi kh├Аc?</p>
            <div class="flex flex-col space-y-4">
                <button id="select-role-admin"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40">
                    Manchester United
                </button>
                <button id="select-role-guest"
                    class="w-full bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg transition duration-300">
                    Fan ─Љр╗Ўi kh├Аc???
                </button>
            </div>
        </div>
    </div>
    <div id="blog-editor-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
        <div class="w-full max-w-4xl max-h-[90vh] flex flex-col bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-amber-600 dark:text-amber-400">Soр║Аn thр║Бo b├аi viр║┐t</h3>
            <div class="space-y-4 overflow-y-auto pr-2">
                <div>
                    <label for="blog-editor-title" class="block font-medium mb-1 dark:text-gray-300">Ti├фu ─Љр╗Ђ:</label>
                    <input type="text" id="blog-editor-title"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                </div>
                <div>
                    <label for="blog-editor-tags" class="block font-medium mb-1 dark:text-gray-300">Hashtags:</label>
                    <input type="text" id="blog-editor-tags" placeholder="V├Г dр╗Ц: excel, vba, ai"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">C├Аch nhau bр║▒ng dр║Цu phр║Еy (,)</p>
                </div>
                <div>
                    <label class="block font-medium mb-1 dark:text-gray-300">Nр╗Ўi dung:</label>
                    <textarea id="blog-editor-textarea"></textarea>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                <button id="blog-editor-save-btn"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">Lк░u
                    b├аi viр║┐t</button>
                <button id="blog-editor-cancel-btn"
                    class="flex-1 bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">Hр╗Дy</button>
                <input type="hidden" id="blog-editor-post-id">
            </div>
        </div>
    </div>
    <div id="blog-reader-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 hidden p-4">
        <div id="blog-reader-content"
            class="w-11/12 h-[90vh] flex flex-col bg-white dark:bg-slate-800 rounded-lg shadow-2xl overflow-hidden">
            <header class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700 overflow-y-auto">
                <h2 id="blog-reader-title" class="text-3xl font-bold text-amber-600 dark:text-amber-400">
                    ─љ├бy l├а Ti├фu ─Љр╗Ђ B├аi viр║┐t
                </h2>
                <div id="blog-reader-tags" class="flex flex-wrap gap-2 mt-4">
                </div>
            </header>
            <article class="flex-1 p-6 overflow-y-auto">
                <div id="blog-reader-body" class="prose dark:prose-invert max-w-none">
                </div>
            </article>
            <footer
                class="flex-shrink-0 p-4 bg-gray-50 dark:bg-slate-900 border-t border-gray-200 dark:border-gray-700">
                <button id="blog-reader-close-btn"
                    class="w-full sm:w-auto bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-8 rounded-lg transition duration-300">
                    ─љ├│ng
                </button>
            </footer>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Initialization (C┼е Cр╗дA BA) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCG_OqnwjNTg3kfCUmEkxo-qrJTMMsyhqk",
                authDomain: "my-toolbox-downloads.firebaseapp.com",
                projectId: "my-toolbox-downloads",
                storageBucket: "my-toolbox-downloads.appspot.com",
                messagingSenderId: "723884147235",
                appId: "1:723884147235:web:d08241abfd477d91c2e796"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            let globalTabSettings = { show_events_public: false, show_research: false, show_badminton: false };
            const settingsRef = db.collection("settings").doc("tab_visibility");

            // === BIр║ЙN Mр╗џI CHO Hр╗є THр╗љNG Sр╗░ KIр╗єN ===
            const eventsRef = db.collection("events"); // Bр║Бng 'events' mр╗Џi tr├фn Firestore
            const eventPopupBackdrop = document.getElementById('event-popup-backdrop');
            const eventPopupContent = document.getElementById('event-popup-content');
            const eventPopupTitle = document.getElementById('event-popup-title');
            const eventPopupGreeting = document.getElementById('event-popup-greeting');
            const eventPopupCloseBtn = document.getElementById('event-popup-close-btn');
            const birthdaySong = document.getElementById('birthday-song');
            if (birthdaySong) {
                birthdaySong.preload = 'auto'; // Y├фu cр║Дu tr├гnh duyр╗Єt tр║Бi to├аn bр╗Ў file
                birthdaySong.load();  // K├Гch hoр║Аt viр╗Єc tр║Бi file ngay khi trang tр║Бi xong
            }
            // ========================================================
            const bgMusic = document.getElementById('nhac-nen-cua-ba');
            let publicEventsUnsubscribe = null; // Biр║┐n giр╗» listener cр╗Дa Guest
            let adminEventsUnsubscribe = null; // Biр║┐n giр╗» listener cр╗Дa Admin
            // === Hр║ЙT BIр║ЙN Mр╗џI ===

            const storage = firebase.storage();
            // Gр║«N LISTENER CHO N├џT ─љ├ЊNG POPUP Sр╗░ KIр╗єN
            if (eventPopupCloseBtn) {
                eventPopupCloseBtn.addEventListener('click', closeEventPopup);
                eventPopupBackdrop.addEventListener('click', closeEventPopup);
            }
            // === CODE AUTH Cр╗дA Mр╗а (Bр║бO Mр║гT + Sр╗гA Lр╗ќI) ===
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); // <<< D├њNG Mр╗а TH├іM V├ђO ─љ├ѓY
            const modal = document.getElementById('role-selection-modal');
            const selectGuestBtn = document.getElementById('select-role-guest');
            const selectAdminBtn = document.getElementById('select-role-admin');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            // (Tр╗▒ ─Љр╗Ўng lр║»ng nghe thay ─Љр╗Ћi tр╗Ф Firestore)
            settingsRef.onSnapshot((doc) => {
                if (doc.exists) {
                    globalTabSettings = doc.data();
                    listenForPublicEvents(); // <-- TH├іM D├њNG N├ђY (─Љр╗Ѓ tр║Бi sр╗▒ kiр╗Єn)
                } else {
                    // Nр║┐u chк░a c├│, tр╗▒ tр║Аo file c├аi ─Љр║иt mр║иc ─Љр╗Іnh (р║Еn hр║┐t)
                    settingsRef.set(globalTabSettings).catch(e => console.error("Lр╗Ќi tр║Аo settings:", e));
                }
                console.log("C├аi ─Љр║иt tab ─Љ├Б cр║Гp nhр║Гt:", globalTabSettings);

                // Chр║Аy lр║Аi h├аm updateUI ─Љр╗Ѓ ├Аp dр╗Цng c├аi ─Љр║иt mр╗Џi cho Guest
                const user = auth.currentUser;
                checkAdminStatus(user);
            }, (error) => {
                console.error("Lр╗Ќi tр║Бi c├аi ─Љр║иt tab:", error);
            });
            // === H├ђM "SI├іU TR├ѓU B├њ" (style.display) + N├ѓNG Cр║цP AUTONUMERIC + Bр║бO Mр║гT ===
            // === H├ђM "SI├іU TR├ѓU B├њ" (style.display) + N├ѓNG Cр║цP AUTONUMERIC + Bр║бO Mр║гT ===
            // === H├ђM Mр╗џI: CHUY├іN GIA KH├ЊA/Mр╗ъ Lр╗іCH ===
            function setCalendarInputsReadOnly(isReadOnly) {
                // 1. Kh├│a/Mр╗Ъ c├Аc ├┤ g├х tiр╗Ђn
                const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                inputs.forEach(input => {
                    if (input.autoNumericInstance) {
                        input.autoNumericInstance.options.readOnly(isReadOnly);
                    } else {
                        input.readOnly = isReadOnly;
                    }
                });

                // 2. Kh├│a/Mр╗Ъ c├Аc n├║t 'РЌЈ'
                const toggles = calendarGrid.querySelectorAll('.day-toggle');
                toggles.forEach(toggle => {
                    toggle.disabled = isReadOnly;
                });
            }

            // === H├ђM "SI├іU TR├ѓU B├њ" (style.display) + N├ѓNG Cр║цP AUTONUMERIC + Bр║бO Mр║гT ===
            function updateUI(user, isAdmin) {
                // === Mр╗а Bр╗ћ SUNG 1: ─љр║иt "biр╗Ѓn b├Аo" Admin to├аn cр╗Цc ===
                window.isAdmin = (user && isAdmin);
                // ===============================================
                const gView = document.getElementById('guest-view');
                const aView = document.getElementById('admin-view');
                const navD = document.getElementById('nav-my-diary');
                const navR = document.getElementById('nav-my-research');
                const navB = document.getElementById('nav-badminton-scheduler');
                const navAdmin = document.getElementById('nav-admin-panel');
                const addDepositInput = document.getElementById('badminton-add-deposit'); // Lр║Цy ├┤ Nр╗Ўp tiр╗Ђn
                const submitDepositBtn = document.getElementById('badminton-submit-deposit'); // <<< Mр╗а Lр║цY TH├іM N├џT

                // (Bр║Бn v├А ─Љр║Дy ─Љр╗Д)
                if (!gView || !aView || !navD || !navR || !navB || !navAdmin || !addDepositInput || !submitDepositBtn) { // <<< Mр╗а TH├іM N├џT V├ђO CHECK
                    console.error("Lр╗Ќi nghi├фm trр╗Їng: Kh├┤ng t├гm thр║Цy 1 trong c├Аc View UI!");
                    return;
                }

                // === Mр╗а "T├ЂI Cр║цU TR├џC" H├ђM N├ђY ===

                // 1. Khр╗Ъi tр║Аo AutoNumeric cho ├┤ "Nр╗Ўp th├фm" (1 Lр║дN DUY NHр║цT)
                // (H├аm n├аy sр║й tр╗▒ chр║Аy 1 lр║Дn khi tр║Бi trang)
                if (addDepositInput && !addDepositInput.autoNumericInstance) {
                    const anInput = new AutoNumeric(addDepositInput, {
                        decimalCharacter: ',',
                        digitGroupSeparator: '.',
                        decimalPlaces: 0,
                        minimumValue: '-999999999',
                        maximumValue: '999999999',
                        // Kh├┤ng set readOnly р╗Ъ ─Љ├бy, set р╗Ъ dк░р╗Џi
                    });
                    addDepositInput.autoNumericInstance = anInput;
                }


                if (user && isAdmin) {
                    // 1. L├ђ ADMIN
                    gView.style.display = 'none';
                    aView.style.display = 'block';
                    navD.classList.remove('hidden');
                    navR.classList.remove('hidden');
                    navB.classList.remove('hidden');
                    navAdmin.classList.remove('hidden');
                    initializeAdminBlogFeatures();
                    initializeEventAdmin(); // <-- TH├іM D├њNG N├ђY
                    setCalendarInputsReadOnly(false);

                    // 2. Bр║Гt ├┤ nр╗Ўp tiр╗Ђn
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(false); // <<< Cho ph├Еp g├х
                    }
                    addDepositInput.placeholder = 'Nр╗Ўp th├фm...';
                    submitDepositBtn.disabled = false; // <<< Bр║Гt n├║t [+]

                    // 3. Tр║Бi lр╗Іch (nр║┐u chк░a)
                    // (Code n├аy ─Љ├Б bр╗І chuyр╗Ѓn qua h├аm showTool, nhк░ng Admin vр║Фn cр║Дn khр╗Ъi tр║Аo lр║Дn ─Љр║Дu)
                    if (!window.calendarInitialized) {
                        loadFundData();
                        renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                        window.calendarInitialized = true;
                    }

                    // 4. Set Avatar
                    const adminAvatar = document.getElementById('admin-avatar');
                    const adminName = document.getElementById('admin-name');
                    if (adminAvatar) adminAvatar.src = user.photoURL || 'images/favicon.png';
                    if (adminName) adminName.textContent = user.displayName || "Ch├аo Admin!";

                } else {
                    // 1. L├ђ GUEST
                    gView.style.display = 'block';
                    cleanupEventAdminListeners(); // <-- TH├іM D├њNG N├ђY (─Љр╗Ѓ dр╗Їn dр║╣p)
                    aView.style.display = 'none';
                    setCalendarInputsReadOnly(true); // <<< D├њNG Mр╗џI (KH├ЊA Lр╗іCH)

                    // 2. Tр║»t ├┤ nр╗Ўp tiр╗Ђn
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(true); // <<< Kh├│a g├х
                        addDepositInput.autoNumericInstance.clear(); // X├│a sр╗Љ (nр║┐u lр╗А g├х)
                    }
                    addDepositInput.placeholder = "Money doesn't grow on trees!"; // <<< ─љр╗Ћi chр╗»
                    submitDepositBtn.disabled = true; // <<< Tр║»t n├║t [+]

                    // 3. р║еn/Hiр╗Єn Nav theo c├аi ─Љр║иt (Giр╗» nguy├фn)
                    navAdmin.classList.add('hidden');
                    if (globalTabSettings.show_events_public) { // <-- Sр╗гA T├іN
                        navD.classList.remove('hidden');
                    } else {
                        navD.classList.add('hidden');
                    }

                    if (globalTabSettings.show_research) {
                        navR.classList.remove('hidden');
                    } else {
                        navR.classList.add('hidden');
                    }

                    if (globalTabSettings.show_badminton) {
                        navB.classList.remove('hidden');
                    } else {
                        navB.classList.add('hidden');
                    }
                    if (user && !isAdmin) {
                        signOut();
                        alert("T├аi khoр║Бn n├аy kh├┤ng c├│ quyр╗Ђn Admin!");
                    }

                    // === Sр╗гA Lр╗ќI LOGIC "QU├ЅT PH├њNG" Nр║░M р╗ъ ─љ├ѓY ===

                    const currentHash = window.location.hash.substring(1);
                    const defaultTool = 'remove-bg'; // Trang an to├аn

                    // 1. Tр║Аo 1 danh s├Аch c├Аc trang Bр╗і Cр║цM (tр╗Еc l├а ─Љang р║еN)
                    let forbiddenTools = ['admin-panel']; // 'admin-panel' lu├┤n cр║Цm
                    if (!globalTabSettings.show_diary) {
                        forbiddenTools.push('my-diary');
                    }
                    if (!globalTabSettings.show_research) {
                        forbiddenTools.push('my-research');
                    }
                    if (!globalTabSettings.show_badminton) {
                        forbiddenTools.push('badminton-scheduler');
                    }

                    // 2. Chр╗Ѕ "─Љ├А" vр╗Ђ trang chр╗Д Nр║ЙU user ─Љang р╗Ъ 1 trang Bр╗і Cр║цM
                    if (forbiddenTools.includes(currentHash)) {
                        console.warn("User ─Љang р╗Ъ trang bр╗І cр║Цm (" + currentHash + "). ─љ├А vр╗Ђ trang chр╗Д...");
                        // Chuyр╗Ѓn link vр╗Ђ trang an to├аn
                        history.pushState({ toolId: defaultTool }, '', `#${defaultTool}`);
                        // Gр╗Їi h├аm showTool ─Љр╗Ѓ "vр║й" lр║Аi trang an to├аn
                        showTool(defaultTool);
                    }
                    // === Hр║ЙT PHр║дN Sр╗гA Lр╗ќI ===
                }
            }


            // === TH├іM H├ђM Mр╗џI N├ђY ===
            function initializeAdminPanelToggles() {
                // Lр║Цy 3 c├Аi n├║t gр║Аt
                const toggleDiary = document.getElementById('toggle-diary');
                const toggleResearch = document.getElementById('toggle-research');
                const toggleBadminton = document.getElementById('toggle-badminton');
                // === TH├іM BIр║ЙN Mр╗џI ===
                const toggleEventsPublic = document.getElementById('toggle-diary'); // ID cр╗Дa n├║t gр║Аt c┼Е

                // (Tho├Аt nр║┐u lр╗А gр╗Їi h├аm m├а chк░a р╗Ъ ─Љ├║ng tab)
                if (!toggleDiary) return;

                console.log("Khр╗Ъi tр║Аo Admin Panel Toggles...");

                // 1. ─љр║иt trр║Аng th├Аi 'checked' theo c├аi ─Љр║иt ─Љ├Б tр║Бi
                toggleDiary.checked = globalTabSettings.show_diary;
                toggleResearch.checked = globalTabSettings.show_research;
                toggleBadminton.checked = globalTabSettings.show_badminton;
                if (toggleEventsPublic) toggleEventsPublic.checked = globalTabSettings.show_events_public;



                // 2. Gр║»n sр╗▒ kiр╗Єn 'change' ─Љр╗Ѓ lк░u l├фn Firestore
                // (D├╣ng .hasListener ─Љр╗Ѓ tr├Аnh gр║»n 2-3 lр║Дn)
                if (toggleEventsPublic && !toggleEventsPublic.hasListener) {
                    toggleEventsPublic.addEventListener('change', () => {
                        settingsRef.update({ show_events_public: toggleEventsPublic.checked })
                            .catch(e => alert("Lр╗Ќi cр║Гp nhр║Гt G├│c Bр║Цt Ngр╗Ю: " + e.message));
                    });
                    toggleEventsPublic.hasListener = true;
                }
                // (Giр╗» nguy├фn listener cр╗Дa toggleResearch v├а toggleBadminton)

                if (!toggleResearch.hasListener) {
                    toggleResearch.addEventListener('change', () => {
                        settingsRef.update({ show_research: toggleResearch.checked })
                            .catch(e => alert("Lр╗Ќi cр║Гp nhр║Гt Research: " + e.message));
                    });
                    toggleResearch.hasListener = true;
                }

                if (!toggleBadminton.hasListener) {
                    toggleBadminton.addEventListener('change', () => {
                        settingsRef.update({ show_badminton: toggleBadminton.checked })
                            .catch(e => alert("Lр╗Ќi cр║Гp nhр║Гt Badminton: " + e.message));
                    });
                    toggleBadminton.hasListener = true;
                }
            }
            // === Hр║ЙT H├ђM Mр╗џI ===
            // === H├ђM CHECK ADMIN (Hр╗јI FIRESTORE) ===
            async function checkAdminStatus(user) {
                if (!user) {
                    updateUI(null, false);
                    return;
                }
                try {
                    const adminDocRef = db.collection("admins").doc(user.email);
                    const adminDoc = await adminDocRef.get();
                    if (adminDoc.exists) {
                        console.log("Admin ─Љ├Б ─Љ─Ѓng nhр║Гp:", user.email);
                        updateUI(user, true);
                    } else {
                        console.log("User lр║А ─Љ─Ѓng nhр║Гp, kh├┤ng c├│ quyр╗Ђn:", user.email);
                        updateUI(user, false);
                    }
                } catch (error) {
                    console.error("Lр╗Ќi khi check admin:", error);
                    updateUI(user, false);
                }
            }
            // === C├ЂC H├ђM Xр╗г L├Ю AUTH (GIр╗« NGUY├іN) ===
            auth.onAuthStateChanged((user) => {
                const role = localStorage.getItem('userRole');
                if (user) {
                    checkAdminStatus(user);
                } else {
                    updateUI(null, false);
                    if (!role) {
                        modal.classList.add('show');
                    }
                }
            });
            function signInWithGoogle() {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        localStorage.setItem('userRole', 'admin');
                    })
                    .catch((error) => {
                        console.error("Lр╗Ќi ─Љ─Ѓng nhр║Гp:", error);
                        if (error.code === 'auth/popup-blocked-by-browser') {
                            alert("Tr├гnh duyр╗Єt ─Љ├Б chр║иn cр╗Гa sр╗Ћ ─Љ─Ѓng nhр║Гp. Ba vui l├▓ng cho ph├Еp pop-up cho trang n├аy nha!");
                        } else if (error.code === 'auth/unauthorized-domain') {
                            alert("Lр╗Ќi: T├фn miр╗Ђn n├аy chк░a ─Љк░р╗Бc ─Љ─Ѓng k├й vр╗Џi Firebase!");
                        }
                    });
            }
            function signOut() {
                auth.signOut()
                    .then(() => {
                        console.log("─љ├Б ─Љ─Ѓng xuр║Цt.");
                        localStorage.setItem('userRole', 'guest');
                    })
                    .catch((error) => {
                        console.error("Lр╗Ќi ─Љ─Ѓng xuр║Цt:", error);
                    });
            }
            // === G├ЂN Sр╗░ KIр╗єN CHO C├ЂC N├џT AUTH ===
            selectGuestBtn.addEventListener('click', () => {
                localStorage.setItem('userRole', 'guest');
                modal.classList.remove('show');
            });
            selectAdminBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                signInWithGoogle();
            });
            adminLoginBtn.addEventListener('click', () => {
                signInWithGoogle();
            });
            adminLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut();
            });






            /* ============================================================
            === Bр╗ў N├ЃO BLOG "MY RESEARCH" (G─љ 6 - "Kр║Й TO├ЂN" PRO) ===
            ===       (Bр║Бn "Tр╗ћNG Vр╗є SINH" - Fix mр╗Їi lр╗Ќi)               ===
            ============================================================
            */
            // --- 1. Khai b├Аo biр║┐n to├аn cр╗Цc cho Blog ---
            const blogPostsRef = db.collection("blog_posts");
            // "Sр╗ћ Kр║Й TO├ЂN" Cр╗дA BA CON M├їNH
            const blogMetadataRef = db.collection("blog_metadata").doc("stats");

            const blogAdminControls = document.getElementById('blog-admin-controls');
            const blogCreateNewBtn = document.getElementById('blog-create-new-btn');
            const blogPostsList = document.getElementById('blog-posts-list');
            const blogLoadingState = document.getElementById('blog-loading-state');
            const blogEmptyState = document.getElementById('blog-empty-state');
            const blogEditorModal = document.getElementById('blog-editor-modal');
            const blogEditorTitle = document.getElementById('blog-editor-title');
            const blogEditorTags = document.getElementById('blog-editor-tags');
            const blogEditorTextarea = document.getElementById('blog-editor-textarea');
            const blogEditorSaveBtn = document.getElementById('blog-editor-save-btn');
            const blogEditorCancelBtn = document.getElementById('blog-editor-cancel-btn');
            const blogEditorPostId = document.getElementById('blog-editor-post-id');
            // Biр║┐n cho Cр╗гA Sр╗ћ ─љр╗їC (READER MODAL)
            const blogReaderModal = document.getElementById('blog-reader-modal');
            const blogReaderBody = document.getElementById('blog-reader-body');
            // === Mр╗а TH├іM 3 "TAY" Mр╗џI ===
            const blogReaderArticle = document.querySelector('#blog-reader-content article'); // "TAY" Gр║«N N├џT
            let stickyCloseButton = null; // "TAY" ─љIр╗ђU KHIр╗ѓN N├џT
            let blogObserver = null; // "Mр║«T THр║дN"
            // === Hр║ЙT ===
            const blogReaderCloseBtn = document.getElementById('blog-reader-close-btn');
            let isBlogInitialized = false;
            // BIр║ЙN TO├ђN Cр╗цC CHO PH├ѓN TRANG (PAGINATION)
            const blogPaginationControls = document.getElementById('blog-pagination-controls');
            const blogPrevBtn = document.getElementById('blog-prev-btn');
            const blogNextBtn = document.getElementById('blog-next-btn');
            const blogPageIndicator = document.getElementById('blog-page-indicator');
            let blogPageSize = 5; // Ba muр╗Љn 5 hay 10 th├г sр╗Гa sр╗Љ n├аy
            let blogCurrentPage = 1;
            let blogTotalPages = 1;
            let blogTotalPosts = 0;
            let blogPageMocks = [null]; // Mр║Бng "mр╗Љc" (dр║Цu trang)
            let isLoadingBlog = false;
            // === "Bр╗ў N├ЃO M├ђU" Cр╗дA Mр╗а (D├ЎNG CHO HASHTAG) ===
            // 1. "Bр║Бng M├аu" 10 m├аu (Ba к░ng m├аu n├аo th├г sр╗Гa code Tailwind р╗Ъ ─Љ├бy)
            // 1. "Bр║Бng M├аu" 10 m├аu (Ba к░ng m├аu n├аo th├г sр╗Гa code Tailwind р╗Ъ ─Љ├бy)
            // 1. "Bр║Бng M├аu" 10 m├аu (Ba к░ng m├аu n├аo th├г sр╗Гa code Tailwind р╗Ъ ─Љ├бy)
            // 1. "Bр║Бng M├аu" 10 m├аu (Ba к░ng m├аu n├аo th├г sр╗Гa code Tailwind р╗Ъ ─Љ├бy)
            const tagColorPalette = [
                // [Nр╗Ђn S├Аng, Chр╗» S├Аng], [Nр╗Ђn Tр╗Љi (700), Chр╗» Tр╗Љi (200)] - ─љ├Ѓ Sр╗гA Dр╗іU Mр║«T
                ['bg-red-200', 'text-red-900', 'dark:bg-red-700', 'dark:text-red-200'],
                ['bg-amber-200', 'text-amber-900', 'dark:bg-amber-700', 'dark:text-amber-200'],
                ['bg-green-200', 'text-green-900', 'dark:bg-green-700', 'dark:text-green-200'],
                ['bg-blue-200', 'text-blue-900', 'dark:bg-blue-700', 'dark:text-blue-200'],
                ['bg-indigo-200', 'text-indigo-900', 'dark:bg-indigo-700', 'dark:text-indigo-200'],
                ['bg-purple-200', 'text-purple-900', 'dark:bg-purple-700', 'dark:text-purple-200'],
                ['bg-pink-200', 'text-pink-900', 'dark:bg-pink-700', 'dark:text-pink-200'],
                ['bg-sky-200', 'text-sky-900', 'dark:bg-sky-700', 'dark:text-sky-200'],
                ['bg-teal-200', 'text-teal-900', 'dark:bg-teal-700', 'dark:text-teal-200'],
                ['bg-orange-200', 'text-orange-900', 'dark:bg-orange-700', 'dark:text-orange-200']
            ];
            // 2. "Bр╗Ў n├Бo" "b─Ѓm" chр╗» th├аnh sр╗Љ (─Љр╗Ѓ bр╗Љc m├аu)
            function getStringHash(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash); // Trр║Б vр╗Ђ sр╗Љ dк░кАng
            }
            // 3. H├аm "bр╗Љc" m├аu (trр║Б vр╗Ђ 4 class)
            function getTagColorClasses(tagName) {
                const hash = getStringHash(tagName);
                const index = hash % tagColorPalette.length; // Lр║Цy sр╗Љ dк░ (0-9)
                const colors = tagColorPalette[index];
                return `${colors[0]} ${colors[1]} ${colors[2]} ${colors[3]}`; // Trр║Б vр╗Ђ 4 class, v├Г dр╗Ц: "bg-red-200 text-red-900 dark:bg-red-700 dark:text-red-100"
            }
            // === Hр║ЙT "Bр╗ў N├ЃO M├ђU" ===

            // --- H├ђM "─љр║дU T├ђU": Lр║гT "Sр╗ћ Kр║Й TO├ЂN" (Hр║ЙT Lр╗ќI .count()) ---
            async function loadBlogPosts() {
                if (isLoadingBlog) return;
                isLoadingBlog = true;
                blogLoadingState.classList.remove('hidden');
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    // 1. Lр║Гt "Sр╗Ћ Kр║┐ to├Аn"
                    const metaDoc = await blogMetadataRef.get();
                    if (metaDoc.exists) {
                        blogTotalPosts = metaDoc.data().totalPosts || 0;
                    } else {
                        blogTotalPosts = 0; // Nр║┐u sр╗Ћ kh├┤ng c├│, coi nhк░ l├а 0
                    }

                    if (blogTotalPosts === 0) {
                        blogLoadingState.classList.add('hidden');
                        blogEmptyState.classList.remove('hidden');
                        isLoadingBlog = false;
                        return;
                    }
                    // 2. T├Гnh to├Аn
                    blogTotalPages = Math.ceil(blogTotalPosts / blogPageSize);
                    blogCurrentPage = 1;
                    blogPageMocks = [null]; // Reset mр║Бng "mр╗Љc"
                    // 3. Tр║Бi trang ─Љр║Дu ti├фn
                    await fetchBlogPage(); // Tр║Бi trang 1
                } catch (error) {
                    console.error("Lр╗Ќi khi lр║Гt 'Sр╗Ћ Kр║┐ to├Аn':", error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = "<p class='text-center text-red-500'>\"Kh├┤ng thр╗Ѓ ─Љр╗Їc 'Sр╗Ћ Kр║┐ to├Аn'. ─љ├Б c├│ lр╗Ќi.\"</p>";
                } finally {
                    isLoadingBlog = false;
                }
            }

            // --- H├ђM "Cр╗љT L├ЋI" 1: Tр║бI B├ђI VIр║ЙT THEO TRANG ---
            async function fetchBlogPage() {
                blogLoadingState.classList.remove('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    const startAfterMoc = blogPageMocks[blogCurrentPage - 1];
                    let query = blogPostsRef.orderBy("createdAt", "desc");
                    if (startAfterMoc) {
                        query = query.startAfter(startAfterMoc);
                    }
                    query = query.limit(blogPageSize);
                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden');
                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        return;
                    }
                    // "Vр║й" 5 b├аi viр║┐t
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'B├аi viр║┐t kh├┤ng c├│ ti├фu ─Љр╗Ђ';
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN');
                        postCard.appendChild(dateEl);
                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(B├аi viр║┐t n├аy chк░a c├│ t├│m tр║»t...)';
                        postCard.appendChild(summaryEl);
                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "Bр╗љC M├ђU H├ђNG HIр╗єU" Cр╗дA Mр╗а!
                                const colorClasses = getTagColorClasses(tag);
                                // "Mк░р╗Бn" th├фm mр║Цy c├Аi class cкА bр║Бn
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trр╗Ўn" lр║Аi!
                                return `<span class="${baseClasses} ${colorClasses}">
        ${tag}
    </span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }
                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                            <div class="mt-4 flex gap-2">
                                <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sр╗Гa]</button>
                                <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[X├│a]</button>
                            </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });
                    // Lк»U "Mр╗љC" (dр║Цu trang)
                    const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    blogPageMocks[blogCurrentPage] = lastDoc;
                    updatePaginationUI();
                } catch (error) {
                    console.error("Lр╗Ќi khi tр║Бi trang " + blogCurrentPage, error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = '<p class="text-center text-red-500">Tр║Бi trang thр║Цt bр║Аi.</p>';
                } finally {
                    blogPaginationControls.classList.remove('hidden');
                }
            }

            // --- H├ђM "Cр╗љT L├ЋI" 2: Cр║гP NHр║гT N├џT Bр║цM (UI) ---
            function updatePaginationUI() {
                blogPageIndicator.textContent = `Trang ${blogCurrentPage} / ${blogTotalPages}`;
                blogPrevBtn.disabled = (blogCurrentPage === 1);
                blogNextBtn.disabled = (blogCurrentPage === blogTotalPages);
            }

            // --- H├ђM Mр╗ъ "PH├њNG SOр║аN THр║бO" (TinyMCE) ---
            function openBlogEditor(postData = null) {
                blogEditorTitle.value = '';
                blogEditorTags.value = '';
                blogEditorPostId.value = '';
                if (tinymce.get('blog-editor-textarea')) {
                    tinymce.get('blog-editor-textarea').destroy();
                }
                tinymce.init({
                    selector: '#blog-editor-textarea',
                    license_key: 'gpl',
                    plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount fullscreen',
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat | fullscreen',
                    // === M├Ѓ Mр╗џI: ├ЅP THEME KINDLE E-INK ===
                    skin: 'oxide', // 1. ├Ѕp giao diр╗Єn (toolbar) lu├┤n l├а S├Аng
                    content_css: false, // 2. V├┤ hiр╗Єu h├│a CSS "dark"/"default" cр╗Дa TinyMCE
                    content_style: `
                        /* 3. Tр║Бi Google Font (giр╗Љng hр╗Єt file index.html) */
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                        
                        /* 4. ├Ђp dр╗Цng nр╗Ђn giр║Цy v├а chр╗» x├Аm ─Љen */
                        body {
                            background-color: #FBF8F0 !important; /* Nр╗Ђn giр║Цy E-Ink */
                            color: #333333 !important; /* Chр╗» x├Аm ─Љen mр╗Ђm */
                            font-family: 'Inter', sans-serif !important; 
                            line-height: 1.8 !important; /* D├Бn d├▓ng 1.8 cho dр╗Ё viр║┐t */
                        }

                        /* 5. Sр╗Гa m├аu link cho ─Љр╗Њng bр╗Ў */
                        a {
                            color: #0056b3 !important;
                            text-decoration: underline !important;
                        }
                    `,
                    // === Hр║ЙT M├Ѓ Mр╗џI ===
                    height: 400,
                    file_picker_types: 'image media',
                    file_picker_callback: (cb, value, meta) => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        if (meta.filetype === 'image') { input.setAttribute('accept', 'image/*'); }
                        else if (meta.filetype === 'media') { input.setAttribute('accept', 'audio/*,video/*'); }
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const storageRef = storage.ref();
                            const fileName = `blog_assets/${new Date().getTime()}_${file.name}`;
                            const fileRef = storageRef.child(fileName);
                            const uploadTask = fileRef.put(file);
                            uploadTask.on('state_changed',
                                (snapshot) => { console.log('─љang tр║Бi l├фn: ' + snapshot.bytesTransferred + ' / ' + snapshot.totalBytes); },
                                (error) => { console.error("Lр╗Ќi tр║Бi file l├фn Storage:", error); alert("Tр║Бi file thр║Цt bр║Аi: " + error.message); },
                                () => {
                                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                        console.log('Tр║Бi file th├аnh c├┤ng:', downloadURL);
                                        cb(downloadURL, { title: file.name });
                                    });
                                }
                            );
                        });
                        input.click();
                    }
                }).then(() => {
                    if (postData) {
                        blogEditorTitle.value = postData.title;
                        blogEditorTags.value = postData.tags ? postData.tags.join(', ') : '';
                        tinymce.get('blog-editor-textarea').setContent(postData.content);
                        blogEditorPostId.value = postData.id;
                    } else {
                        tinymce.get('blog-editor-textarea').setContent('<p>Ba g├х nр╗Ўi dung v├аo ─Љ├бy...</p>');
                    }
                });
                blogEditorModal.classList.remove('hidden');
            }

            // --- H├ђM Lк»U B├ђI (GHI V├ђO "Sр╗ћ Kр║Й TO├ЂN") ---
            async function saveBlogPost() {
                const title = blogEditorTitle.value.trim();
                const content = tinymce.get('blog-editor-textarea').getContent();
                const tagsString = blogEditorTags.value.trim();
                const postId = blogEditorPostId.value;
                if (!title || !content) {
                    alert("Ba кАi, ba phр║Бi g├х Ti├фu ─Љр╗Ђ v├а Nр╗Ўi dung chр╗Е!");
                    return;
                }
                // Tр║Аo T├│m tр║»t
                let summary = tinymce.get('blog-editor-textarea').getContent({ format: 'text' });
                summary = summary.replace(/\s+/g, ' ').trim();
                if (summary.length > 200) {
                    summary = summary.substring(0, 200) + '...';
                } else if (summary.length === 0 && content.length > 0) {
                    summary = '[B├аi viр║┐t chр╗Еa nр╗Ўi dung ─Љa phк░кАng tiр╗Єn...]';
                }
                const tagsArray = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                blogEditorSaveBtn.disabled = true;
                blogEditorSaveBtn.textContent = '─љang lк░u...';
                try {
                    const postData = {
                        title: title,
                        content: content,
                        summary: summary,
                        tags: tagsArray,
                    };

                    // Bр║»t ─Љр║Дu "Giao dр╗Іch" (batch)
                    const batch = db.batch();

                    if (postId) {
                        // Sр╗гA B├ђI (Kh├┤ng ─Љр╗Цng tр╗Џi sр╗Ћ Kр║┐ to├Аn)
                        postData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        const postRef = blogPostsRef.doc(postId);
                        batch.update(postRef, postData);
                        console.log("─љ├Б cр║Гp nhр║Гt b├аi viр║┐t:", postId);
                    } else {
                        // Tр║аO B├ђI Mр╗џI (Phр║Бi +1 v├┤ sр╗Ћ)
                        postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        postData.authorId = auth.currentUser.uid;
                        const newPostRef = blogPostsRef.doc(); // Tр║Аo 1 ref mр╗Џi
                        batch.set(newPostRef, postData); // 1. Lк░u b├аi viр║┐t
                        // 2. "Ghi sр╗Ћ" (+1)
                        batch.set(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                        console.log("─љ├Б tр║Аo b├аi viр║┐t mр╗Џi!");
                    }

                    await batch.commit(); // Chр║Аy "Giao dр╗Іch"

                    blogEditorModal.classList.add('hidden');
                    tinymce.get('blog-editor-textarea').destroy();
                    loadBlogPosts(); // Tр║Бi lр║Аi (Reset)
                } catch (error) {
                    console.error("Lр╗Ќi khi lк░u b├аi viр║┐t:", error);
                    alert("Lк░u b├аi thр║Цt bр║Аi: " + error.message);
                } finally {
                    blogEditorSaveBtn.disabled = false;
                    blogEditorSaveBtn.textContent = 'Lк░u b├аi viр║┐t';
                }
            }

            // --- H├ђM X├ЊA B├ђI (TRр╗ф "Sр╗ћ Kр║Й TO├ЂN") ---
            async function deleteBlogPost(postId, postTitle) {
                if (!confirm(`Ba c├│ chр║»c chр║»n muр╗Љn X├ЊA b├аi viр║┐t "${postTitle}" kh├┤ng?`)) {
                    return;
                }
                try {
                    // Bр║»t ─Љр║Дu "Giao dр╗Іch"
                    const batch = db.batch();
                    // 1. X├│a b├аi
                    const postRef = blogPostsRef.doc(postId);
                    batch.delete(postRef);
                    // 2. "Ghi sр╗Ћ" (-1)
                    batch.update(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(-1) });

                    await batch.commit(); // Chр║Аy "Giao dр╗Іch"

                    console.log("─љ├Б x├│a b├аi viр║┐t v├а cр║Гp nhр║Гt sр╗Ћ:", postId);
                    loadBlogPosts(); // Tр║Бi lр║Аi (Reset)
                } catch (error) {
                    console.error("Lр╗Ќi khi x├│a b├аi viр║┐t:", error);
                    alert("X├│a b├аi thр║Цt bр║Аi: " + error.message);
                }
            }

            // === H├ђM "─љр║аI PHр║фU THUр║гT" V5 ("Mр║«T THр║дN") ===
            function openReaderModal(postData) {
                if (!blogReaderModal || !blogReaderBody || !blogReaderArticle) {
                    console.error("Lр╗Ќi: Mр║Цt bр╗Ў phр║Гn Cр╗Гa sр╗Ћ ─Љр╗Їc (V5)!");
                    return;
                }

                // 1. "Gр╗ўP" Ti├фu ─Љр╗Ђ v├а Tags (Giр╗» nguy├фn)
                let tagsHTML = '';
                if (postData.tags && postData.tags.length > 0) {
                    tagsHTML = postData.tags.map(tag => {
                        // "Bр╗љC M├ђU H├ђNG HIр╗єU" Cр╗дA Mр╗а!
                        const colorClasses = getTagColorClasses(tag);
                        // "Mк░р╗Бn" th├фm mр║Цy c├Аi class cкА bр║Бn
                        const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                        // "Trр╗Ўn" lр║Аi!
                        return `<span class="${baseClasses} ${colorClasses}">
                ${tag}
            </span>`;
                    }).join(' ');
                }
                const headerHTML = `
        <div class="in-article-header">
            <h2 class="in-article-title">${postData.title || 'B├аi viр║┐t kh├┤ng c├│ ti├фu ─Љр╗Ђ'}</h2>
            <div class="in-article-tags">
                ${tagsHTML || 'Chк░a gр║»n tag'}
            </div>
        </div>
    `;

                // 2. "BкаM" (Gр╗Ўp header + nр╗Ўi dung + "Mр║«T THр║дN")
                blogReaderBody.innerHTML = headerHTML +
                    (postData.content || '<p>Nр╗Ўi dung ─Љang cр║Гp nhр║Гt...</p>') +
                    '<div class="article-end-sentinel"></div>'; // Gр║»n "Mр║»t thр║Дn" р╗Ъ ─Љ├Аy

                // 3. Tр║аO N├џT "─љ├ЊNG" (Chр╗Ѕ 1 lр║Дn duy nhр║Цt)
                if (!stickyCloseButton) {
                    console.log("Tр║Аo n├║t '─љ├│ng' lкА lр╗Гng (1 lр║Дn)");
                    stickyCloseButton = document.createElement('button');
                    stickyCloseButton.className = 'sticky-close-btn-injected'; // Gр╗Їi CSS "V5"
                    stickyCloseButton.textContent = '─љ├│ng';

                    // "Gр║»n" n├║t "─љ├│ng" v├аo khu vр╗▒c cuр╗Ўn (Article)
                    blogReaderArticle.appendChild(stickyCloseButton);

                    // Gр║»n "d├бy ─Љiр╗Єn" Hр╗дY DIр╗єT cho n├║t
                    stickyCloseButton.addEventListener('click', () => {
                        blogReaderModal.classList.add('hidden'); // ─љ├│ng cр╗Гa sр╗Ћ
                        stickyCloseButton.classList.remove('show'); // Tр╗▒ "t├аng h├гnh"
                        if (blogObserver) blogObserver.disconnect(); // Tр║»t "mр║»t thр║Дn"
                        blogReaderBody.innerHTML = ''; // X├│a b├аi viр║┐t
                    });
                }

                // 4. RESET (Bр║»t buр╗Ўc phр║Бi reset)
                // D├╣ng setTimeout(..., 0) ─Љр╗Ѓ "├Еp" lр╗Єnh cuр╗Ўn chр║Аy SAU KHI
                // tr├гnh duyр╗Єt ─Љ├Б "vр║й" xong nр╗Ўi dung b├аi viр║┐t mр╗Џi.
                setTimeout(() => {
                    blogReaderArticle.scrollTop = 0;
                }, 0);

                stickyCloseButton.classList.remove('show'); // р║еn n├║t "─љ├│ng"

                // 5. Gр║«N D├ѓY ─љIр╗єN "Mр║«T THр║дN" (Chр╗Ѕ 1 lр║Дn)
                if (!blogObserver) {
                    console.log("Khр╗Ъi ─Љр╗Ўng 'Mр║»t thр║Дn' (1 lр║Дn)");
                    const options = {
                        root: blogReaderArticle, // "Mр║»t thр║Дn" nh├гn b├фn trong khu "Article"
                        rootMargin: '0px 0px 0px 0px',
                        threshold: 0.1 // Thр║Цy 10% l├а "la l├аng"
                    };
                    blogObserver = new IntersectionObserver(handleObserver, options);
                }
                // (Bр║»t "Mр║»t thр║Дn" "canh" c├Аi ─Љ├Аy b├аi)
                const sentinel = blogReaderBody.querySelector('.article-end-sentinel');
                if (sentinel) blogObserver.observe(sentinel);

                // 6. Gр║«N D├ѓY ─љIр╗єN TAG (Giр╗» nguy├фn)
                if (!blogReaderBody.hasTagListener) {
                    blogReaderBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('blog-tag-link')) {
                            const tagName = e.target.textContent.trim();
                            blogReaderModal.classList.add('hidden');
                            stickyCloseButton.classList.remove('show');
                            if (blogObserver) blogObserver.disconnect();
                            fetchBlogPostsByTag(tagName); // Lр╗Їc
                        }
                    });
                    blogReaderBody.hasTagListener = true;
                }

                // 7. Mр╗Ъ Cр╗Гa sр╗Ћ!
                blogReaderModal.classList.remove('hidden');
            }




            // === H├ђM Mр╗џI (Lр╗їC THEO TAG - Cр║дN INDEX!) ===
            async function fetchBlogPostsByTag(tagName) {
                console.log(`─љang lр╗Їc b├аi viр║┐t theo tag: "${tagName}"...`);

                // 1. Dр╗Їn dр║╣p giao diр╗Єn
                blogLoadingState.classList.remove('hidden'); // Bр║Гt "─љang tр║Бi..."
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden'); // р║еn ph├бn trang

                // 2. Tр║Аo giao diр╗Єn "─љang lр╗Їc"
                const filterStatusEl = document.createElement('div');
                filterStatusEl.id = 'blog-filter-status'; // (Mр╗А th├фm ID ─Љр╗Ѓ x├│a)
                filterStatusEl.className = 'p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg mb-6 flex justify-between items-center';
                filterStatusEl.innerHTML = `
        <span class="font-medium text-amber-800 dark:text-amber-200">
            ─љang lр╗Їc theo tag: <strong class="text-lg">${tagName}</strong>
        </span>
        <button id="blog-clear-filter-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
            &times; X├│a bр╗Ў lр╗Їc
        </button>
    `;
                // Ch├еn v├аo *trк░р╗Џc* danh s├Аch b├аi viр║┐t
                blogPostsList.before(filterStatusEl);

                // Gр║»n sр╗▒ kiр╗Єn cho n├║t "X├│a bр╗Ў lр╗Їc"
                document.getElementById('blog-clear-filter-btn').addEventListener('click', () => {
                    filterStatusEl.remove(); // X├│a c├Аi thanh "─љang lр╗Їc"
                    blogEmptyState.textContent = 'Chк░a c├│ b├аi viр║┐t n├аo.'; // (Trр║Б lр║Аi chр╗» c┼Е)
                    loadBlogPosts(); // Tр║Бi lр║Аi nhк░ c┼Е
                });

                // 3. Truy vр║Цn Firestore (Cр║Дn Index!)
                try {
                    const query = blogPostsRef
                        .where("tags", "array-contains", tagName) // <-- CHI├іU "PRO" L├ђ ─љ├ѓY!
                        .orderBy("createdAt", "desc");

                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden'); // Tр║»t "─љang tр║Бi..."

                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        // (─љр╗Ћi chр╗» cho ba dр╗Ё biр║┐t)
                        blogEmptyState.textContent = `Kh├┤ng t├гm thр║Цy b├аi viр║┐t n├аo c├│ tag "${tagName}".`;
                        return;
                    }

                    // 4. "Vр║й" kр║┐t quр║Б (Copy y chang h├аm fetchBlogPage)
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';


                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'B├аi viр║┐t kh├┤ng c├│ ti├фu ─Љр╗Ђ';
                        // (Gр╗Їi h├аm ─Љ├Б thр╗Љng nhр║Цt)
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);

                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN') : '...';
                        postCard.appendChild(dateEl);

                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(B├аi viр║┐t n├аy chк░a c├│ t├│m tр║»t...)';
                        postCard.appendChild(summaryEl);

                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "Bр╗љC M├ђU H├ђNG HIр╗єU" Cр╗дA Mр╗а!
                                const colorClasses = getTagColorClasses(tag);
                                // "Mк░р╗Бn" th├фm mр║Цy c├Аi class cкА bр║Бn
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trр╗Ўn" lр║Аi!
                                return `<span class="${baseClasses} ${colorClasses}">${tag}</span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }

                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                <div class="mt-4 flex gap-2">
                    <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sр╗Гa]</button>
                    <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[X├│a]</button>
                </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });

                } catch (error) {
                    console.error("Lр╗Ќi khi lр╗Їc tag:", error);
                    blogLoadingState.classList.add('hidden');

                    // ─љ├ѓY L├ђ "THр║дN CH├џ" B├ЂO Lр╗ќI INDEX
                    if (error.code === 'failed-precondition') {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500 p-4 bg-red-100 dark:bg-red-900/50 rounded-lg">
                <b>Lр╗Ќi "─Љр╗Цng n├│c" Firestore!</b><br>
                Ba кАi, ba cр║Дn tр║Аo "Chр╗Ѕ mр╗Цc" (Index) th├г mр╗Џi lр╗Їc tag ─Љк░р╗Бc! <br>
                <span class="text-xs">(Lр╗Ќi: ${error.message})</span>
            </p>`;
                    } else {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500">Lр╗Їc tag thр║Цt bр║Аi.</p>`;
                    }
                }
            }


            // === H├ђM "Mр║«T THр║дN" (V5) ===
            function handleObserver(entries) {
                if (!stickyCloseButton) return; // Nр║┐u chк░a c├│ n├║t th├г th├┤i

                const entry = entries[0];
                if (entry.isIntersecting) {
                    // "Mр║»t thр║Дn" THр║цY ─Љ├Аy b├аi -> Hiр╗Єn n├║t
                    stickyCloseButton.classList.add('show');
                } else {
                    // "Mр║»t thр║Дn" Mр║цT Dр║цU ─Љ├Аy b├аi -> р║еn n├║t
                    stickyCloseButton.classList.remove('show');
                }
            }

            // === H├ђM "Mр║цT T├ЇCH" Mр╗а VIр║ЙT B├Ў CHO BA ===
            // (Gр║»n d├бy ─Љiр╗Єn cho c├Аc n├║t cр╗Дa Admin)
            function initializeAdminBlogFeatures() {
                console.log("K├Гch hoр║Аt t├Гnh n─Ѓng Admin Blog (Tр║Аo/Sр╗Гa/X├│a)...");

                // 1. Hiр╗Єn n├║t "Tр║Аo b├аi viр║┐t mр╗Џi"
                if (blogAdminControls) {
                    blogAdminControls.classList.remove('hidden');
                }

                // 2. Gр║»n sр╗▒ kiр╗Єn cho n├║t "Tр║Аo b├аi viр║┐t mр╗Џi"
                // (Con th├фm .hasListener ─Љр╗Ѓ n├│ kh├┤ng bр╗І gр║»n 2 lр║Дn)
                if (blogCreateNewBtn && !blogCreateNewBtn.hasListener) {
                    blogCreateNewBtn.addEventListener('click', () => {
                        openBlogEditor(null); // Mр╗Ъ editor rр╗Ќng
                    });
                    blogCreateNewBtn.hasListener = true;
                }

                // 3. Gр║»n sр╗▒ kiр╗Єn "cha" cho Sр╗Гa/X├│a (Event Delegation)
                if (blogPostsList && !blogPostsList.hasAdminListener) {
                    blogPostsList.addEventListener('click', async (e) => {
                        const target = e.target;
                        const postId = target.dataset.id;

                        // === Mр╗а TH├іM "D├ѓY ─љIр╗єN TAG" V├ђO ─љ├ѓY ===
                        if (target.classList.contains('blog-tag-link')) {
                            e.preventDefault(); // Ng─Ѓn h├аnh vi lр║А
                            const tagName = target.textContent.trim();
                            console.log("Ba click v├аo tag:", tagName);

                            // X├│a c├Аc thanh "─љang lр╗Їc" c┼Е nр║┐u c├│
                            document.querySelectorAll('#blog-filter-status').forEach(el => el.remove());

                            fetchBlogPostsByTag(tagName); // Gр╗Їi h├аm lр╗Їc mр╗Џi
                            return; // Click tag th├г th├┤i, kh├┤ng l├аm g├г nр╗»a
                        }
                        // === Hр║ЙT D├ѓY ─љIр╗єN TAG ===

                        // Bр║Цm n├║t [Sр╗Гa]
                        if (target.classList.contains('blog-edit-btn') && postId) {
                            try {
                                const postDoc = await blogPostsRef.doc(postId).get();
                                if (postDoc.exists) {
                                    const postData = { id: postDoc.id, ...postDoc.data() };
                                    openBlogEditor(postData); // Mр╗Ъ editor vр╗Џi data
                                } else {
                                    alert("Lр╗Ќi: Kh├┤ng t├гm thр║Цy b├аi viр║┐t n├аy!");
                                }
                            } catch (error) {
                                console.error("Lр╗Ќi khi lр║Цy b├аi viр║┐t ─Љр╗Ѓ sр╗Гa:", error);
                                alert("Lр╗Ќi khi tр║Бi b├аi viр║┐t!");
                            }
                        }

                        // Bр║Цm n├║t [X├│a]
                        if (target.classList.contains('blog-delete-btn') && postId) {
                            const postCard = target.closest('.blog-post-card');
                            const titleEl = postCard ? postCard.querySelector('h3') : null;
                            const title = titleEl ? titleEl.textContent : 'b├аi viр║┐t n├аy';
                            deleteBlogPost(postId, title);
                        }
                    });
                    blogPostsList.hasAdminListener = true;
                }
            }

            // ============================================================
            // === Bр╗ў N├ЃO Hр╗є THр╗љNG Sр╗░ KIр╗єN (EVENT SYSTEM) ===
            // ============================================================

            // --- 1. H├ђM D├ђNH CHO KH├ЂCH (GUEST) ---

            // H├аm "vр║й" danh s├Аch link sр╗▒ kiр╗Єn c├┤ng khai
            function renderPublicEventsList(eventsData) {
                const listEl = document.getElementById('events-public-list');
                const loadingEl = document.getElementById('events-public-loading');
                const emptyEl = document.getElementById('events-public-empty');
                if (!listEl || !loadingEl || !emptyEl) return;

                loadingEl.classList.add('hidden');
                listEl.innerHTML = ''; // X├│a sр║Аch danh s├Аch c┼Е

                if (eventsData.length === 0) {
                    emptyEl.classList.remove('hidden');
                } else {
                    emptyEl.classList.add('hidden');
                    eventsData.forEach(event => {
                        const linkEl = document.createElement('a');
                        linkEl.href = '#';
                        linkEl.className = 'block p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg hover:bg-pink-100 dark:hover:bg-pink-900/50 transition-colors text-lg font-semibold text-pink-600 dark:text-pink-400';
                        linkEl.textContent = `­ЪјЂ ${event.title}`;
                        linkEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            showEventPopup(event);
                        });
                        listEl.appendChild(linkEl);
                    });
                }
            }

            // H├аm hiр╗Ѓn thр╗І Popup "Bр║Цt Ngр╗Ю"
            function showEventPopup(event) {
                eventPopupTitle.textContent = event.title;
                eventPopupGreeting.textContent = event.greeting;

                // Hiр╗Ѓn thр╗І popup
                eventPopupBackdrop.classList.add('show');
                eventPopupContent.classList.add('show');

                // Tр║»t nhр║Аc nр╗Ђn
                if (bgMusic) bgMusic.pause();

                // Ph├Аt nhр║Аc sinh nhр║Гt
                if (birthdaySong) {
                    birthdaySong.currentTime = 0;
                    birthdaySong.play();
                }

                // Bр║»n ph├Аo hoa
                confetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 }
                });
            }

            // H├аm ─Љ├│ng Popup "Bр║Цt Ngр╗Ю"
            function closeEventPopup() {
                eventPopupBackdrop.classList.remove('show');
                eventPopupContent.classList.remove('show');

                // Tр║»t nhр║Аc sinh nhр║Гt
                if (birthdaySong) birthdaySong.pause();
                // Bр║Гt lр║Аi nhр║Аc nр╗Ђn (nр║┐u n├│ ─Љang ph├Аt)
                if (window.daPhatNhacLanDau) {
                    if (bgMusic) bgMusic.play();
                }
            }

            // H├аm lр║»ng nghe c├Аc sр╗▒ kiр╗Єn C├ћNG KHAI (cho Guest)
            function listenForPublicEvents() {
                // Tр║»t listener c┼Е (nр║┐u c├│)
                if (publicEventsUnsubscribe) publicEventsUnsubscribe();

                // Chр╗Ѕ lр║Цy c├Аc sр╗▒ kiр╗Єn ─Љang ─Љк░р╗Бc Bр║гT (isEnabled == true)
                publicEventsUnsubscribe = eventsRef
                    .where("isEnabled", "==", true)
                    .orderBy("createdAt", "desc")
                    .onSnapshot(snapshot => {
                        const eventsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderPublicEventsList(eventsData);
                    }, error => {
                        console.error("Lр╗Ќi tр║Бi sр╗▒ kiр╗Єn c├┤ng khai:", error);
                        document.getElementById('events-public-loading').textContent = 'Lр╗Ќi tр║Бi sр╗▒ kiр╗Єn.';
                    });
            }

            // --- 2. H├ђM D├ђNH CHO QUр║бN TRр╗і (ADMIN) ---

            // H├аm "vр║й" danh s├Аch quр║Бn l├й sр╗▒ kiр╗Єn (cho Admin)
            function renderEventAdminList(eventsData) {
                const listEl = document.getElementById('event-admin-list');
                const loadingEl = document.getElementById('event-admin-loading');
                if (!listEl || !loadingEl) return;

                loadingEl.classList.add('hidden');
                listEl.innerHTML = ''; // X├│a sр║Аch

                if (eventsData.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">Chк░a c├│ sр╗▒ kiр╗Єn n├аo. H├Бy tр║Аo mр╗Џi!</p>';
                } else {
                    eventsData.forEach(event => {
                        const card = document.createElement('div');
                        card.className = 'flex items-center justify-between p-3 bg-white/50 dark:bg-gray-800/50 rounded-lg';
                        const checked = event.isEnabled ? 'checked' : '';
                        card.innerHTML = `
┬а ┬а ┬а <div class="flex-1">
┬а ┬а ┬а ┬а <span class="font-medium text-gray-700 dark:text-gray-200">${event.title}</span>
┬а ┬а ┬а </div>
┬а ┬а ┬а <div class="flex items-center gap-3">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <input type="checkbox" data-id="${event.id}" class="event-toggle-btn form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" ${checked}>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button data-id="${event.id}" class="event-edit-btn text-sm font-medium text-blue-500 hover:text-blue-700">[Sр╗Гa]</button>
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button data-id="${event.id}" class="event-delete-btn text-sm font-medium text-red-500 hover:text-red-700">[X├│a]</button>
┬а ┬а ┬а </div>
┬а ┬а `;
                        listEl.appendChild(card);
                    });
                }
            }

            // H├аm khр╗Ъi ─Љр╗Ўng to├аn bр╗Ў chр╗Еc n─Ѓng Admin
            function initializeEventAdmin() {
                // Lр║Цy c├Аc n├║t trong form
                const titleInput = document.getElementById('event-admin-title');
                const greetingInput = document.getElementById('event-admin-greeting');
                const saveBtn = document.getElementById('event-admin-save-btn');
                const cancelBtn = document.getElementById('event-admin-cancel-btn');
                const editIdInput = document.getElementById('event-admin-edit-id');
                const listEl = document.getElementById('event-admin-list');

                // 1. Lр║»ng nghe to├аn bр╗Ў danh s├Аch (cho Admin)
                // Tр║»t listener c┼Е (nр║┐u c├│)
                if (adminEventsUnsubscribe) adminEventsUnsubscribe();
                adminEventsUnsubscribe = eventsRef
                    .orderBy("createdAt", "desc")
                    .onSnapshot(snapshot => {
                        const eventsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderEventAdminList(eventsData);
                    }, error => {
                        console.error("Lр╗Ќi tр║Бi danh s├Аch sр╗▒ kiр╗Єn admin:", error);
                        document.getElementById('event-admin-loading').textContent = 'Lр╗Ќi tр║Бi danh s├Аch.';
                    });

                // 2. Xр╗Г l├й n├║t Lк»U / Cр║гP NHр║гT
                saveBtn.onclick = async () => {
                    const title = titleInput.value.trim();
                    const greeting = greetingInput.value.trim();
                    const editId = editIdInput.value;

                    if (!title || !greeting) {
                        alert('Ba phр║Бi g├х T├фn v├а Lр╗Юi ch├║c!');
                        return;
                    }

                    saveBtn.disabled = true;
                    try {
                        if (editId) {
                            // Chр║┐ ─Љр╗Ў Cр║гP NHр║гT
                            await eventsRef.doc(editId).update({ title, greeting, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                        } else {
                            // Chр║┐ ─Љр╗Ў Tр║аO Mр╗џI
                            await eventsRef.add({
                                title,
                                greeting,
                                isEnabled: false, // Mр║иc ─Љр╗Іnh l├а Tр║«T
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                        // X├│a sр║Аch form
                        cancelBtn.click();
                    } catch (e) {
                        console.error("Lр╗Ќi lк░u sр╗▒ kiр╗Єn:", e);
                        alert('Lр╗Ќi: ' + e.message);
                    } finally {
                        saveBtn.disabled = false;
                    }
                };

                // 3. Xр╗Г l├й n├║t Hр╗дY (─Љр╗Ѓ reset form)
                cancelBtn.onclick = () => {
                    titleInput.value = '';
                    greetingInput.value = '';
                    editIdInput.value = '';
                    saveBtn.textContent = 'Lк░u Sр╗▒ kiр╗Єn Mр╗Џi';
                    cancelBtn.classList.add('hidden');
                };

                // 4. Xр╗Г l├й Sр╗Гa/X├│a/Bр║Гt-Tр║»t (Event Delegation)
                listEl.onclick = async (e) => {
                    const target = e.target;
                    const id = target.dataset.id;
                    if (!id) return;

                    const eventRef = eventsRef.doc(id);

                    // Bр║Цm n├║t Bр║гT/Tр║«T
                    if (target.classList.contains('event-toggle-btn')) {
                        const isEnabled = target.checked;
                        try {
                            await eventRef.update({ isEnabled: isEnabled });
                        } catch (e) {
                            console.error("Lр╗Ќi bр║Гt/tр║»t:", e);
                            target.checked = !isEnabled; // Trр║Б lр║Аi
                        }
                    }

                    // Bр║Цm n├║t X├ЊA
                    if (target.classList.contains('event-delete-btn')) {
                        if (confirm('Ba c├│ chр║»c muр╗Љn X├ЊA sр╗▒ kiр╗Єn n├аy kh├┤ng?')) {
                            try {
                                await eventRef.delete();
                            } catch (e) {
                                console.error("Lр╗Ќi x├│a:", e);
                                alert('Lр╗Ќi: ' + e.message);
                            }
                        }
                    }

                    // Bр║Цm n├║t Sр╗гA
                    if (target.classList.contains('event-edit-btn')) {
                        try {
                            const doc = await eventRef.get();
                            if (doc.exists) {
                                const data = doc.data();
                                titleInput.value = data.title;
                                greetingInput.value = data.greeting;
                                editIdInput.value = id;
                                saveBtn.textContent = 'Cр║Гp nhр║Гt Sр╗▒ kiр╗Єn';
                                cancelBtn.classList.remove('hidden');
                                titleInput.focus(); // ─љк░a con trр╗Ј l├фn
                            }
                        } catch (e) {
                            console.error("Lр╗Ќi tр║Бi ─Љр╗Ѓ sр╗Гa:", e);
                        }
                    }
                };
            }

            // H├аm Dр╗їN Dр║ИP listener (tr├Аnh chр║Аy 2-3 lр║Дn)
            function cleanupEventAdminListeners() {
                if (adminEventsUnsubscribe) {
                    adminEventsUnsubscribe();
                    adminEventsUnsubscribe = null;
                }
                // Tр║»t c├Аc listener c┼Е
                const saveBtn = document.getElementById('event-admin-save-btn');
                if (saveBtn) saveBtn.onclick = null;
                const listEl = document.getElementById('event-admin-list');
                if (listEl) listEl.onclick = null;
                // (C├Аc n├║t kh├Аc tр╗▒ reset khi h├аm initialize chр║Аy lр║Аi)
            }

            // ============================================================
            // === Hр║ЙT Bр╗ў N├ЃO Sр╗░ KIр╗єN ===
            // ============================================================

            /* ============================================================
            === Bр╗ў N├ЃO BADMINTON SCHEDULER (Bр║бN N├ѓNG Cр║цP AUTONUMERIC) ===
            ============================================================
            */
            // --- 1. Khai b├Аo biр║┐n to├аn cр╗Цc cho lр╗Іch ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('calendar-prev-month');
            const nextMonthBtn = document.getElementById('calendar-next-month');
            const totalDepositedEl = document.getElementById('badminton-total-deposited');
            const addDepositInput = document.getElementById('badminton-add-deposit');
            const submitDepositBtn = document.getElementById('badminton-submit-deposit');
            const totalDaysEl = document.getElementById('badminton-total-days');
            const totalCostEl = document.getElementById('badminton-total-cost');
            const remainingBalanceEl = document.getElementById('badminton-remaining-balance');
            let currentDate = new Date();
            let currentMonthData = {};
            let currentFund = {
                totalDeposited: 0,
                totalCostEver: 0,
                totalDaysEver: 0
            };
            // --- 2. H├аm "Vр║й Lр╗Іch" (N├ѓNG Cр║цP AUTONUMERIC) ---
            // --- 2. H├аm "Vр║й Lр╗Іch" (Bр║бN V├Ђ Lр╗ќI CRASH CUр╗љI C├ЎNG) ---
            async function renderCalendar(month, year) {
                console.log(`─љang vр║й lр╗Іch cho: ${month + 1}/${year}`);

                // === Bк»р╗џC 1: Tр║бI DATA TRк»р╗џC ===
                await loadMonthData(month, year);

                monthYearHeader.textContent = `Th├Аng ${month + 1} / ${year}`;

                let firstDayOfMonth = new Date(year, month, 1).getDay();
                let startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                let daysInMonth = new Date(year, month + 1, 0).getDate();

                // === Bк»р╗џC 2: Tр║аO CHUр╗ќI HTML (Tр║аO 1 Lр║дN) ===
                let calendarHtml = ''; // Tр║Аo 1 chuр╗Ќi rр╗Ќng

                // A. Vр║й c├Аc ├┤ "mр╗Ю" cр╗Дa th├Аng trк░р╗Џc
                for (let i = 0; i < startDay; i++) {
                    calendarHtml += `<div class="calendar-day not-in-month"></div>`; // Nр╗Љi v├аo chuр╗Ќi
                }

                // B. Vр║й c├Аc ├┤ ng├аy cр╗Дa th├Аng n├аy
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = currentMonthData[dateString] || {};
                    const isPresent = dayData.present || false;
                    const cost = dayData.cost || '';

                    // (─љ├Б x├│a placeholder="_" р╗Ъ ─Љ├бy)
                    calendarHtml += `
<div class="calendar-day">
<span class="day-number">${day}</span>
<button 
class="day-toggle ${isPresent ? 'active' : ''}" 
data-date="${dateString}"
data-old-present="${isPresent}">
РЌЈ
</button>
<input 
type="text"  
class="day-cost-input" 
placeholder="_" 
value="${cost}"
data-date="${dateString}"
data-old-cost="${cost || 0}">
</div>
`; // Nр╗Љi v├аo chuр╗Ќi
                }

                // === Bк»р╗џC 3: "BкаM" HTML V├ђO Lр╗іCH (CHр╗ѕ 1 Lр║дN) ===
                calendarGrid.innerHTML = calendarHtml;

                // === Bк»р╗џC 4: "Hр╗њI Sр╗еC" (setTimeout) TRк»р╗џC KHI Gр╗їI AUTONUMERIC ===
                // Chi├фu n├аy ─Љр║Бm bр║Бo DOM ─Љ├Б "thр╗Ъ" xong
                setTimeout(() => {
                    try {
                        // C. Khр╗Ъi ─Љр╗Ўng "H├аng hiр╗Єu"
                        const anInputs = new AutoNumeric.multiple('.day-cost-input', {
                            decimalCharacter: ',',
                            digitGroupSeparator: '.',
                            decimalPlaces: 0,
                            minimumValue: '-999999999',
                            maximumValue: '999999999'
                        });

                        // Lк░u instance v├аo tр╗Фng input
                        const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                        inputs.forEach(input => {
                            input.autoNumericInstance = AutoNumeric.getAutoNumericElement(input);

                        });

                        // === Bк»р╗џC 5: SAU KHI KHр╗ъI Tр║аO XONG, Mр╗џI KH├ЊA/Mр╗ъ ===
                        setCalendarInputsReadOnly(!window.isAdmin);

                        // === Bк»р╗џC 6: T├ЇNH TO├ЂN Lр║аI TIр╗ђN (V├ї H├ђM N├ђY Nр║░M CUр╗љI C├ЎNG) ===
                        calculateThisMonthCost();


                    } catch (e) {
                        console.error("Lр╗ќI AUTONUMERIC NGHI├іM TRр╗їNG:", e);
                        calendarGrid.innerHTML = `<p class="text-red-500 text-center">Lр╗Ќi nghi├фm trр╗Їng khi khр╗Ъi tр║Аo AutoNumeric. Kh├┤ng thр╗Ѓ vр║й lр╗Іch.</p>`;
                    }
                }, 0); // Chр╗Ѕ cр║Дn 0ms ─Љр╗Ѓ ─Љр║Еy n├│ ra sau
            }
            // --- 3. H├аm "T├Гnh to├Аn" ---
            function calculateThisMonthCost() {
                let thisMonthCost = 0;
                Object.values(currentMonthData).forEach(data => {
                    thisMonthCost += Number(data.cost || 0);
                });
                totalCostEl.textContent = `${thisMonthCost.toLocaleString('vi-VN')} ─Љ`;
            }
            function updateSummaryUI() {
                const remaining = currentFund.totalDeposited - currentFund.totalCostEver;
                totalDepositedEl.textContent = `${currentFund.totalDeposited.toLocaleString('vi-VN')} ─Љ`;
                totalDaysEl.textContent = `${currentFund.totalDaysEver} ng├аy`;
                remainingBalanceEl.textContent = `${remaining.toLocaleString('vi-VN')} ─Љ`;
            }
            // --- 4. H├аm "N├│i chuyр╗Єn vр╗Џi Firestore" ---
            function loadFundData() {
                const fundRef = db.collection("badminton_fund").doc("global");
                fundRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        currentFund = doc.data();
                        console.log("─љ├Б tр║Бi Quр╗╣:", currentFund);
                    } else {
                        console.log("Chк░a c├│ Quр╗╣, ─Љang tр║Аo mр╗Џi...");
                        fundRef.set(currentFund);
                    }
                    updateSummaryUI();
                }, (error) => {
                    console.error("Lр╗Ќi khi tр║Бi Quр╗╣:", error);
                });
            }
            async function loadMonthData(month, year) {
                const monthString = String(month + 1).padStart(2, '0');
                const queryKey = `${year}-${monthString}`;
                const scheduleRef = db.collection("badminton_schedule");
                const snapshot = await scheduleRef
                    .where(firebase.firestore.FieldPath.documentId(), '>=', queryKey)
                    .where(firebase.firestore.FieldPath.documentId(), '<', `${queryKey}-32`)
                    .get();
                currentMonthData = {};
                snapshot.forEach(doc => {
                    currentMonthData[doc.id] = doc.data();
                });
                console.log(`─љ├Б tр║Бi data cho ${queryKey}:`, currentMonthData);
            }
            // H├аm Lк░u data (Bр║бN Sр╗гA Lр╗ќI LOGIC "Lр║аC QUAN" CUр╗љI C├ЎNG)
            // H├аm Lк░u data (Bр║бN Sр╗гA Lр╗ќI LOGIC "Lр║аC QUAN" CUр╗љI C├ЎNG)
            async function saveData(dateString, isPresent, newCost, oldIsPresent, oldCost) { // <<< Sр╗гA 1: Nhр║Гn newCost (dр║Аng Sр╗љ)
                const dayRef = db.collection("badminton_schedule").doc(dateString);
                const fundRef = db.collection("badminton_fund").doc("global");
                // === Bк»р╗џC 1: T├ЇNH TO├ЂN TRк»р╗џC ===
                // const newCost = AutoNumeric.getNumber(costString); // <<< Sр╗гA 2: Bр╗Ј d├▓ng lр╗Ќi n├аy ─Љi
                const costDiff = newCost - Number(oldCost || 0);
                let dayDiff = 0;
                if (isPresent && !oldIsPresent) {
                    dayDiff = 1;
                } else if (!isPresent && oldIsPresent) {
                    dayDiff = -1;
                }
                // === Bк»р╗џC 2: Cр║гP NHр║гT GIAO DIр╗єN "Lр║аC QUAN" ===
                // (Phр║Дn n├аy ─Љ├Б ─Љ├║ng, n├│ gр╗Їi updateSummaryUI)
                if (costDiff !== 0 || dayDiff !== 0) {
                    // 1. Cр║Гp nhр║Гt "bр╗Ў nhр╗Џ ─Љр╗Єm" (cache)
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                    currentFund.totalCostEver += costDiff;
                    currentFund.totalDaysEver += dayDiff;
                    // 2. "Vр║й" lр║Аi UI NGAY Lр║гP Tр╗еC
                    updateSummaryUI();
                    calculateThisMonthCost(); // <<< TH├іM D├њNG N├ђY ─љр╗ѓ ADMIN Cр║гP NHр║гT
                } else {
                    // Nр║┐u k sр╗Гa g├г, chр╗Ѕ cр║Гp nhр║Гt cache
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                }
                // === Bк»р╗џC 3: Gр╗гI Lр╗єNH Lк»U L├іN FIREBASE (CHр║аY NGр║дM) ===
                const batch = db.batch();
                batch.set(dayRef, { present: isPresent, cost: newCost }, { merge: true });
                if (costDiff !== 0 || dayDiff !== 0) {
                    batch.update(fundRef, {
                        totalCostEver: firebase.firestore.FieldValue.increment(costDiff),
                        totalDaysEver: firebase.firestore.FieldValue.increment(dayDiff)
                    });
                }
                try {
                    await batch.commit();
                    console.log(`─љ├Б lк░u data (chр║Аy ngр║Дm) ng├аy ${dateString} v├а cр║Гp nhр║Гt Quр╗╣!`);
                } catch (error) {
                    console.error("Lр╗Ќi khi lк░u data (chр║Аy ngр║Дm):", error);
                }
            }
            // H├аm Nр╗Ўp Quр╗╣ (Bр║бN "Lр║аC QUAN" CHUр║еN + Sр╗љ ├ѓM)
            // H├аm Nр╗Ўp Quр╗╣ (Bр║бN "Lр║аC QUAN" CHUр║еN + Sр╗љ ├ѓM)
            async function submitDeposit() {
                const amount = addDepositInput.autoNumericInstance.getNumber();
                if (isNaN(amount) || amount === 0) {
                    alert("Ba g├х sр╗Љ tiр╗Ђn (├бm hoр║иc dк░кАng) v├аo ─Љi р║А!");
                    return;
                }
                // === Bк»р╗џC 1: Cр║гP NHр║гT GIAO DIр╗єN "Lр║аC QUAN" ===
                currentFund.totalDeposited += amount;
                updateSummaryUI(); // D├њNG N├ђY Cр║гP NHр║гT 4 ├ћ Tр╗ћNG Kр║ЙT
                // === Bк»р╗џC 2: X├│a ├┤ input ===
                addDepositInput.autoNumericInstance.clear();
                // === Bк»р╗џC 3: Gр╗гI Lр╗єNH Lк»U L├іN FIREBASE (CHр║аY NGр║дM) ===
                const fundRef = db.collection("badminton_fund").doc("global");
                try {
                    await fundRef.update({
                        totalDeposited: firebase.firestore.FieldValue.increment(amount)
                    });
                    if (amount > 0) {
                        console.log(`Nр╗Ўp quр╗╣ (chр║Аy ngр║Дm) th├аnh c├┤ng: ${amount}`);
                    } else {
                        console.log(`R├║t quр╗╣ (chр║Аy ngр║Дm) th├аnh c├┤ng: ${amount}`);
                    }
                } catch (error) {
                    console.error("Lр╗Ќi khi nр╗Ўp quр╗╣ (chр║Аy ngр║Дm):", error);
                }
            }
            // --- 5. G├Аn Sр╗▒ kiр╗Єn (Event Listeners) ---
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            submitDepositBtn.addEventListener('click', submitDeposit);
            // D├ѓY ─љIр╗єN N├ѓNG Cр║цP 1 (CLICK РЌЈ)
            // D├ѓY ─љIр╗єN N├ѓNG Cр║цP 1 (CLICK РЌЈ)
            calendarGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('day-toggle')) {
                    if (!window.isAdmin) return; // <<< Bр║бO Vр╗є CHр╗љNG GUEST
                    const button = e.target;
                    const dateString = button.dataset.date;
                    const input = document.querySelector(`.day-cost-input[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    button.classList.toggle('active');
                    const newIsPresent = button.classList.contains('active');
                    // === Sр╗гA Lр╗ќI Nр║░M р╗ъ ─љ├ѓY ===
                    // Phр║Бi lр║Цy Sр╗љ tр╗Ф instance AutoNumeric, kh├┤ng lр║Цy CHр╗« (string)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    button.dataset.oldPresent = newIsPresent;
                    // Truyр╗Ђn con Sр╗љ (newCostNumber) v├аo h├аm saveData
                    saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                }
            });
            // D├ѓY ─љIр╗єN N├ѓNG Cр║цP 2 (G├Ћ TIр╗ђN)
            calendarGrid.addEventListener('focusout', (e) => {

                if (e.target.classList.contains('day-cost-input')) {
                    if (!window.isAdmin) return;
                    const input = e.target;
                    const dateString = input.dataset.date;
                    const button = document.querySelector(`.day-toggle[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    const newIsPresent = button.classList.contains('active');
                    // === Sр╗гA Lр╗ќI Nр║░M р╗ъ ─љ├ѓY ===
                    // Lр║Цy Sр╗љ (giр╗Љng nhк░ h├аm tr├фn)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    if (newCostNumber !== oldCost) {
                        input.dataset.oldCost = newCostNumber;
                        // Truyр╗Ђn con Sр╗љ (newCostNumber) v├аo h├аm saveData
                        saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                    }
                }
            });
            /* ============================================================
            === Hр║ЙT Bр╗ў N├ЃO BADMINTON ===
            ============================================================
            */
            // === CODE C┼е Cр╗дA BA (Mр╗а Gр╗ўP V├ђO ─љ├ѓY) ===
            // --- Bр╗ў ─љр║ЙM TRUY Cр║гP (C┼е Cр╗дA BA) ---
            async function updateVisitCount() {
                const counterElement = document.getElementById('visit-counter');
                if (!counterElement) return;
                const docRef = db.collection("stats").doc("global");
                docRef.update({
                    visits: firebase.firestore.FieldValue.increment(1)
                }).catch(error => {
                    if (error.code === 'not-found') {
                        docRef.set({ visits: 1 }).catch(err => console.error("Lр╗Ќi tр║Аo Document lр║Дn ─Љр║Дu:", err));
                    } else {
                        console.error("Lр╗Ќi t─Ѓng lк░р╗Бt truy cр║Гp:", error);
                    }
                });
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const count = doc.data().visits;
                        counterElement.innerHTML = `Lк░р╗Бt truy cр║Гp: <strong>${count.toLocaleString('vi-VN')}</strong>`;
                    }
                }, (error) => {
                    console.error("Lр╗Ќi ─Љр╗Їc lк░р╗Бt truy cр║Гp (listener):", error);
                    counterElement.textContent = 'Lк░р╗Бt truy cр║Гp: Kh├┤ng thр╗Ѓ tр║Бi.';
                });
            }
            updateVisitCount();
            // --- Theme Toggle Logic (C┼е Cр╗дA BA) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }
            themeToggleBtn.addEventListener('click', () => {
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });
            // --- Navigation Logic (C┼е Cр╗дA BA) ---
            const navLinks = document.querySelectorAll('.nav-link');
            const toolContents = document.querySelectorAll('.tool-content');
            function showTool(toolId) {
                navLinks.forEach(nav => nav.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-tool="${toolId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                let targetFound = false;
                toolContents.forEach(content => {
                    if (content.id === `tool-${toolId}`) {
                        targetFound = true;
                        content.classList.remove('hidden');
                        setTimeout(() => content.classList.remove('opacity-0'), 10);
                        // === THр║дN CH├џ Cр╗дA Mр╗а (Gр╗їI H├ђM BLOG) ===
                        // (M├гnh chр╗Ѕ tр║Бi 1 lр║Дn ─Љр║Дu ti├фn th├┤i nha ba)
                        if (toolId === 'my-research' && !window.isBlogInitialized) {
                            console.log("Lр║Дn ─Љр║Дu v├аo 'My Research', tр║Бi blog...");
                            loadBlogPosts(); // Tр║Бi blog lр║Дn ─Љр║Дu
                            window.isBlogInitialized = true; // ─љ├Аnh dр║Цu ─Љ├Б tр║Бi
                        }
                        // === Hр║ЙT THр║дN CH├џ ===

                        // === Mр╗а TH├іM: CHO GUEST XEM Lр╗іCH ===
                        if (toolId === 'badminton-scheduler' && !window.calendarInitialized) {
                            console.log("Lр║Дn ─Љр║Дu v├аo 'B Scheduler', tр║Бi lр╗Іch (cho cр║Б Guest)...");
                            // Guest kh├┤ng cр║Дn AutoNumeric cho ├┤ "Nр╗Ўp th├фm", chр╗Ѕ cр║Дn tр║Бi data
                            loadFundData(); // Tр║Бi Quр╗╣
                            renderCalendar(currentDate.getMonth(), currentDate.getFullYear()); // Vр║й lр╗Іch
                            window.calendarInitialized = true; // ─љ├Аnh dр║Цu ─Љ├Б tр║Бi
                        }
                        // === Hр║ЙT PHр║дN TH├іM ===

                    } else {
                        content.classList.add('opacity-0');
                        setTimeout(() => {
                            content.classList.add('hidden');
                        }, 400);
                    }
                    if (toolId === 'admin-panel' && window.isAdmin) {
                        initializeAdminPanelToggles();
                    }
                });
                if (!targetFound && navLinks.length > 0) {
                    const defaultToolId = navLinks[0].dataset.tool;
                    if (toolId !== defaultToolId) {
                        showTool(defaultToolId);
                    }
                }
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const toolId = link.dataset.tool;
                    history.pushState({ toolId: toolId }, '', `#${toolId}`);
                    showTool(toolId);
                });
            });
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.toolId) {
                    showTool(e.state.toolId);
                } else {
                    showTool(navLinks[0].dataset.tool);
                }
            });
            const initialToolId = window.location.hash.substring(1) || navLinks[0].dataset.tool;
            showTool(initialToolId);
            // --- BG Removal Logic (C┼е Cр╗дA BA) ---
            const bgRemoveInput = document.getElementById('bg-remove-input');
            const bgRemoveFilename = document.getElementById('bg-remove-filename');
            const bgRemovePreviews = document.getElementById('bg-remove-previews');
            const bgRemoveOriginal = document.getElementById('bg-remove-original');
            const bgRemoveResult = document.getElementById('bg-remove-result');
            const bgRemoveLoader = document.getElementById('bg-remove-loader');
            const bgRemoveProcessBtn = document.getElementById('bg-remove-process-btn');
            const bgRemoveDownloadBtn = document.getElementById('bg-remove-download-btn');
            const bgRemoveStatus = document.getElementById('bg-remove-status');
            let resultBlob = null;
            if (bgRemoveInput) {
                bgRemoveInput.addEventListener('change', () => {
                    const file = bgRemoveInput.files[0];
                    if (file) {
                        bgRemoveFilename.textContent = file.name;
                        resultBlob = null;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            bgRemoveOriginal.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        bgRemovePreviews.classList.remove('hidden');
                        bgRemoveResult.classList.add('hidden');
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveDownloadBtn.disabled = true;
                        bgRemoveStatus.textContent = 'Sр║хn s├аng ─Љр╗Ѓ t├Аch nр╗Ђn.';
                        bgRemoveProcessBtn.disabled = false;
                    } else {
                        bgRemoveFilename.textContent = 'Chк░a chр╗Їn tр╗Єp n├аo.';
                    }
                });
                bgRemoveProcessBtn.addEventListener('click', async () => {
                    const file = bgRemoveInput.files[0];
                    if (!file) return;
                    bgRemoveLoader.classList.remove('hidden');
                    bgRemoveResult.classList.add('hidden');
                    bgRemoveStatus.textContent = '─љang tр║Бi р║Бnh l├фn v├а xр╗Г l├й...';
                    bgRemoveProcessBtn.disabled = true;
                    bgRemoveDownloadBtn.disabled = true;
                    const formData = new FormData();
                    formData.append('image_file', file);
                    try {
                        const response = await fetch('/api/photoroom', {
                            method: 'POST',
                            body: formData,
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `Lр╗Ќi HTTP: ${response.status}`);
                        }
                        // === M├Ѓ Mр╗џI Bр║«T ─љр║дU ===
                        // 1. ─љр╗Їc sр╗Љ lк░р╗Бt c├▓n lр║Аi tр╗Ф header m├а server gр╗Гi vр╗Ђ
                        const quotaRemaining = response.headers.get('X-My-Quota-Remaining');
                        // === M├Ѓ Mр╗џI Kр║ЙT TH├џC ===

                        resultBlob = await response.blob();
                        const url = URL.createObjectURL(resultBlob);
                        bgRemoveResult.src = url;
                        bgRemoveResult.classList.remove('hidden');

                        // === M├Ѓ Mр╗џI Bр║«T ─љр║дU ===
                        // 2. Hiр╗Ѓn thр╗І th├┤ng b├Аo k├еm sр╗Љ lк░р╗Бt
                        if (quotaRemaining) {
                            bgRemoveStatus.textContent = `T├Аch nр╗Ђn th├аnh c├┤ng! (Sр╗Љ lк░р╗Бt API c├▓n lр║Аi: ${quotaRemaining})`;
                        } else {
                            bgRemoveStatus.textContent = 'T├Аch nр╗Ђn th├аnh c├┤ng!';
                        }
                        // === M├Ѓ Mр╗џI Kр║ЙT TH├џC ===

                        bgRemoveDownloadBtn.disabled = false;
                    } catch (error) {
                        console.error("Photoroom API error:", error);
                        bgRemoveStatus.textContent = `Lр╗Ќi: ${error.message}`;
                    } finally {
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveProcessBtn.disabled = false;
                    }
                });
                bgRemoveDownloadBtn.addEventListener('click', () => {
                    if (resultBlob) {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(resultBlob);
                        const originalFileName = bgRemoveInput.files[0].name.split('.').slice(0, -1).join('.');
                        link.download = `${originalFileName}-removed-bg.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
            }
            // --- PNG to ICO Logic (C┼е Cр╗дA BA) ---
            const pngFileInput = document.getElementById('png-file-input');
            const pngFilename = document.getElementById('png-filename');
            const convertBtn = document.getElementById('convert-to-ico-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const icoStatus = document.getElementById('ico-status');
            const icoSizeSelect = document.getElementById('ico-size-select');
            if (pngFileInput) {
                pngFileInput.addEventListener('change', () => {
                    const file = pngFileInput.files[0];
                    if (file) {
                        pngFilename.textContent = file.name;
                        convertBtn.disabled = false;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        pngFilename.textContent = 'Chк░a chр╗Їn tр╗Єp n├аo.';
                        convertBtn.disabled = true;
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
                convertBtn.addEventListener('click', () => {
                    const file = pngFileInput.files[0];
                    if (!file) return;
                    const size = parseInt(icoSizeSelect.value, 10);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            const icoData = createIco(ctx, size);
                            const blob = new Blob([icoData], { type: 'image/x-icon' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'favicon.ico';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            icoStatus.textContent = `Tр╗Єp favicon.ico (${size}x${size}) ─Љ├Б ─Љк░р╗Бc tр║Бi xuр╗Љng!`;
                            setTimeout(() => { icoStatus.textContent = '' }, 3000);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                function createIco(ctx, size) {
                    const imageData = ctx.getImageData(0, 0, size, size).data;
                    const buffer = new ArrayBuffer(22 + 40 + (size * size * 4));
                    const view = new DataView(buffer);
                    view.setUint16(0, 0, true); view.setUint16(2, 1, true); view.setUint16(4, 1, true);
                    view.setUint8(6, size); view.setUint8(7, size); view.setUint8(8, 0); view.setUint8(9, 0);
                    view.setUint16(10, 1, true); view.setUint16(12, 32, true);
                    view.setUint32(14, 40 + (size * size * 4), true); view.setUint32(18, 22, true);
                    let offset = 22;
                    view.setUint32(offset, 40, true); offset += 4;
                    view.setUint32(offset, size, true); offset += 4;
                    view.setUint32(offset, size * 2, true); offset += 4;
                    view.setUint16(offset, 1, true); offset += 2;
                    view.setUint16(offset, 32, true); offset += 2;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, size * size * 4, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    for (let y = size - 1; y >= 0; y--) {
                        for (let x = 0; x < size; x++) {
                            const i = (y * size + x) * 4;
                            view.setUint8(offset++, imageData[i + 2]); view.setUint8(offset++, imageData[i + 1]);
                            view.setUint8(offset++, imageData[i]); view.setUint8(offset++, imageData[i + 3]);
                        }
                    }
                    return new Uint8Array(buffer);
                }
            }
            // --- Base64 Logic (C┼е Cр╗дA BA) ---
            const base64Input = document.getElementById('base64-input');
            const base64Output = document.getElementById('base64-output');
            const encodeBtn = document.getElementById('base64-encode-btn');
            const decodeBtn = document.getElementById('base64-decode-btn');
            const base64Status = document.getElementById('base64-status');
            if (base64Input) {
                function safeBtoa(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch (e) { return null; } }
                function safeAtob(str) { try { return decodeURIComponent(escape(atob(str))); } catch (e) { return null; } }
                encodeBtn.addEventListener('click', () => {
                    const input = base64Input.value;
                    if (!input) { base64Output.value = ''; return; }
                    const encoded = safeBtoa(input);
                    base64Output.value = encoded ? encoded : 'Lр╗Ќi: Dр╗» liр╗Єu ─Љр║Дu v├аo kh├┤ng hр╗Бp lр╗Є.';
                    base64Status.textContent = encoded ? 'M├Б h├│a th├аnh c├┤ng!' : 'M├Б h├│a thр║Цt bр║Аi.';
                    setTimeout(() => { base64Status.textContent = '' }, 3000);
                });
                decodeBtn.addEventListener('click', () => {
                    let currentString = base64Input.value;
                    if (!currentString) { base64Output.value = ''; return; }
                    let decodeCount = 0;
                    let lastValidString = currentString;
                    while (true) {
                        const decoded = safeAtob(currentString);
                        if (decoded !== null && decoded !== currentString) {
                            currentString = decoded;
                            lastValidString = decoded;
                            decodeCount++;
                        } else { break; }
                    }
                    base64Output.value = lastValidString;
                    base64Status.textContent = decodeCount > 0 ? `Giр║Бi m├Б th├аnh c├┤ng qua ${decodeCount} lр╗Џp.` : 'Kh├┤ng thр╗Ѓ giр║Бi m├Б th├фm, chuр╗Ќi kh├┤ng phр║Бi l├а Base64 hр╗Бp lр╗Є.';
                    setTimeout(() => { base64Status.textContent = '' }, 4000);
                });
            }
            // --- My Apps Logic (C┼е Cр╗дA BA) ---
            const appsListContainer = document.getElementById('apps-list');
            const appsLoader = document.getElementById('apps-loader');
            const appsEmptyState = document.getElementById('apps-empty-state');
            if (appsListContainer) {
                db.collection("my_apps").onSnapshot((querySnapshot) => {
                    appsLoader.classList.add('hidden');
                    const appCards = appsListContainer.querySelectorAll('.app-card');
                    appCards.forEach(card => card.remove());
                    if (querySnapshot.empty) {
                        appsEmptyState.classList.remove('hidden');
                    } else {
                        appsEmptyState.classList.add('hidden');
                        querySnapshot.forEach((doc) => {
                            const app = doc.data();
                            const appId = doc.id;
                            let iconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`;
                            if (app.iconUrl && app.iconUrl.trim() !== '') {
                                iconHTML = `<img src="${app.iconUrl}" class="h-full w-full object-contain" alt="${app.appName || 'App'} icon">`;
                            }
                            const appCardHTML = `
<div class="app-card glass-effect p-6 rounded-xl shadow-md transition-all duration-300 flex flex-col sm:flex-row items-start sm:items-center gap-6">
<div class="flex-shrink-0 w-32 h-32 bg-white/70 dark:bg-white/10 rounded-lg flex items-center justify-center overflow-hidden">
${iconHTML}
</div>
<div class="flex-grow">
<h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${app.appName || 'Kh├┤ng c├│ t├фn'}</h3>
<p class="text-gray-600 dark:text-gray-200 mt-1">${app.description || 'Kh├┤ng c├│ m├┤ tр║Б.'}</p>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
<span>Sр╗Љ lк░р╗Бt tр║Бi: </span>
<span class="font-semibold" id="count-${appId}">${app.downloadCount || 0}</span>
</div>
</div>
<div class="w-full sm:w-auto flex-shrink-0">
<button class="download-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 flex items-center justify-center gap-2" data-doc-id="${appId}" data-url="${app.downloadUrl || '#'}">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
<span>Tр║Бi vр╗Ђ</span>
</button>
</div>
</div>`;
                            appsListContainer.insertAdjacentHTML('beforeend', appCardHTML);
                        });
                    }
                }, (error) => {
                    console.error("Error getting documents: ", error);
                    appsLoader.classList.add('hidden');
                    appsListContainer.innerHTML = '<p class="text-center text-red-500">─љ├Б xр║Бy ra lр╗Ќi khi tр║Бi danh s├Аch р╗Еng dр╗Цng.</p>';
                });
                appsListContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.download-btn');
                    if (button) {
                        const docId = button.dataset.docId;
                        const url = button.dataset.url;
                        if (!docId || url === '#') {
                            console.error('Lр╗Ќi: Kh├┤ng t├гm thр║Цy ─Љк░р╗Юng link tр║Бi vр╗Ђ cho р╗Еng dр╗Цng n├аy.');
                            return;
                        }
                        const appRef = db.collection('my_apps').doc(docId);
                        appRef.update({
                            downloadCount: firebase.firestore.FieldValue.increment(1)
                        }).then(() => {
                            console.log("Download count updated!");
                            window.open(url, '_blank');
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                            window.open(url, '_blank');
                        });
                    }
                });
            }
            // === Mр╗а Gр║«N D├ѓY ─љIр╗єN CHO C├ЂC N├џT CHUNG (BLOG) ===

            // 1. N├║t Ph├бn Trang (Pagination)
            if (blogPrevBtn) {
                blogPrevBtn.addEventListener('click', () => {
                    if (blogCurrentPage > 1) {
                        blogCurrentPage--;
                        fetchBlogPage();
                    }
                });
            }
            if (blogNextBtn) {
                blogNextBtn.addEventListener('click', () => {
                    if (blogCurrentPage < blogTotalPages) {
                        blogCurrentPage++;
                        fetchBlogPage();
                    }
                });
            }

            // 2. N├║t trong Editor (Lк░u / Hр╗Дy)
            if (blogEditorSaveBtn) {
                blogEditorSaveBtn.addEventListener('click', saveBlogPost);
            }
            if (blogEditorCancelBtn) {
                blogEditorCancelBtn.addEventListener('click', () => {
                    blogEditorModal.classList.add('hidden');
                    if (tinymce.get('blog-editor-textarea')) {
                        tinymce.get('blog-editor-textarea').destroy();
                    }
                });
            }



        }); // Hр║┐t DOMContentLoaded
    </script>
    <script>
        let daPhatNhacLanDau = false;
        document.addEventListener('click', function () {
            if (!daPhatNhacLanDau) {
                let fileNhac = document.getElementById('nhac-nen-cua-ba');
                if (fileNhac) {
                    fileNhac.volume = 0.15;
                    fileNhac.play().catch(error => {
                        console.log("Tr├гnh duyр╗Єt chр║иn tр╗▒ ─Љр╗Ўng ph├Аt nhр║Аc:", error);
                    });
                    daPhatNhacLanDau = true;
                }
            }
        });
    </script>
    <div id="event-popup-backdrop" class="event-popup-backdrop"></div>
    ┬а ┬а <div id="event-popup-content" class="event-popup-content">
        ┬а ┬а ┬а ┬а <div class="p-8 tool-card glass-effect text-center relative max-w-lg">
            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <button id="event-popup-close-btn" class="event-popup-close-btn">&times;</button>
            ┬а ┬а ┬а ┬а ┬а ┬а
            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <audio id="birthday-song" src="assets/birthday-song.mp3" loop></audio>

            ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <h2 id="event-popup-title"
                class="text-4xl font-bold mb-4 text-pink-600 dark:text-pink-400"></h2>
            ┬а ┬а ┬а ┬а ┬а ┬а <p id="event-popup-greeting"
                class="text-lg text-gray-800 dark:text-gray-300 mb-6 whitespace-pre-line"></p>

            ┬а ┬а ┬а ┬а ┬а ┬а <img
                src="https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3d2Y5dWU4c3l1OWZleGYyN2RlNm1zNmYzaGNna2E3d2ZrNHN4c3J2bCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/l41Ys1fQky5raqvMQ/giphy.gif"
                ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а alt="Ch├║c mр╗Фng" class="mx-auto rounded-lg shadow-lg">
            ┬а ┬а ┬а ┬а </div>
        ┬а ┬а </div>
</body>

</html>