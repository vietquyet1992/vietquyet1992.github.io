<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVQ's World</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5/dist/autoNumeric.min.js"></script>
    <script src="tinymce/tinymce.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=4.0">
    <script>
        if (localStorage.theme === 'dark' || !('theme' in localStorage)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body class="text-black dark:text-gray-100 min-h-screen">
    <audio id="nhac-nen-cua-ba" src="assets/am-thanh.mp3" loop></audio>
    <div class="lg:flex">
        <aside class="lg:w-64 w-full lg:min-h-screen p-4 flex flex-col glass-effect">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400">My Toolbox</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">Công cụ & Ứng dụng</p>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="nav-link active group flex items-center px-4 py-3 rounded-lg transition-all duration-200 
text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="remove-bg">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5.5 2a3.5 3.5 0 013.163 5.002L13 11.172V15a1 1 0 01-1 1H6a1 1 0 01-1-1v-3.828l4.337-4.17A3.5 3.5 0 115.5 2zM4.5 3.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" />
                        <path
                            d="M11.94 11.513l-1.34-1.29a.75.75 0 00-1.06 1.06l1.5 1.44a.75.75 0 001.12-.001l3.5-3.719a.75.75 0 00-1.08-1.04l-2.64 2.79z" />
                    </svg>
                    <span class="font-medium">Tách nền ảnh</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="png-to-ico">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">PNG to ICO</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="base64">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 3a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1h2a1 1 0 011 1v1h4V6a1 1 0 011-1h2a1 1 0 011 1v1z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Base64 Multi-layer</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-apps">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span class="font-medium">My Apps</span>
                </a>
                <a href="#" id="nav-my-diary"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-diary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" />
                    </svg>
                    <span class="font-medium">My Diary</span>
                </a>
                <a href="#" id="nav-my-research"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-research">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V2.75A.75.75 0 0110 2zM8.5 4.5A.75.75 0 007.75 5.25v1.25a.75.75 0 001.5 0V5.25A.75.75 0 008.5 4.5zM12.25 5.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0V5.25zM10 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V10.75A.75.75 0 0110 10zM8.5 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM12.25 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM5.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75V10.75A.75.75 0 015.5 10zM4 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM6.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM14.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H14.5a.75.75 0 01-.75-.75V10.75A.75.75 0 0114.5 10zM13 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM15.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">My Blog</span>
                </a>
                <a href="#" id="nav-badminton-scheduler"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="badminton-scheduler">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">B Scheduler</span>
                </a>

                <a href="#" id="nav-admin-panel"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="admin-panel">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Admin Panel</span>
                </a>

            </nav>
            <div class="mt-auto">
                <div class="p-4">
                    <button id="theme-toggle"
                        class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div id="guest-view" class="text-center pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                    <p id="admin-login-btn"
                        class="text-base text-gray-500 dark:text-gray-400 cursor-pointer hover:text-amber-500 dark:hover:text-amber-400 transition-colors">
                        &copy; 2025 Tiêu Viết Quyết
                    </p>
                </div>
                <div id="admin-view" class="p-4 border-t border-gray-300/50 dark:border-gray-600/50"
                    style="display: none;">
                    <div class="flex items-center space-x-3">
                        <img id="admin-avatar" src="images/favicon.png" alt="Avatar"
                            class="h-10 w-10 rounded-full border-2 border-amber-500 object-cover">
                        <div class="flex-1">
                            <p id="admin-name" class="font-semibold text-sm text-gray-800 dark:text-gray-100">Chào ba!
                            </p>
                            <a href="#" id="admin-logout-btn"
                                class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">Đăng
                                xuất</a>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto min-h-screen">
            <div id="tool-remove-bg" class="tool-content">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Tách nền ảnh</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tải lên một hình ảnh để tự động xóa nền bằng API
                        của Photoroom.</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="bg-remove-input"
                                class="cursor-pointer bg-gray-300 text-gray-700 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chọn tệp...
                            </label>
                            <span id="bg-remove-filename" class="text-sm text-gray-500 dark:text-gray-300">Chưa chọn tệp
                                nào.</span>
                            <input type="file" id="bg-remove-input" accept="image/png, image/jpeg" class="hidden" />
                        </div>
                        <div id="bg-remove-previews" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">Ảnh gốc:</p>
                                <img id="bg-remove-original"
                                    class="w-full rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">Đã tách nền:</p>
                                <div class="w-full aspect-video rounded-lg border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center bg-gray-100/50 dark:bg-gray-700/50"
                                    style="background-image: repeating-conic-gradient(#d1d5db80 0 25%, #e5e7eb80 0 50%); background-size: 16px 16px;">
                                    <img id="bg-remove-result" class="hidden max-w-full max-h-full" />
                                    <div id="bg-remove-loader" class="loader hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button id="bg-remove-process-btn"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>Tách nền</button>
                            <button id="bg-remove-download-btn"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>Tải xuống kết quả</button>
                        </div>
                        <div id="bg-remove-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5"></div>
                    </div>
                </div>
            </div>
            <div id="tool-png-to-ico" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Chuyển đổi PNG sang ICO</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tải lên tệp PNG và chọn kích thước để tạo tệp ICO
                        (biểu tượng trang web).</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="png-file-input"
                                class="cursor-pointer bg-gray-300 text-gray-500 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chọn tệp...
                            </label>
                            <span id="png-filename" class="text-sm text-gray-500 dark:text-gray-300">Chưa chọn tệp
                                nào.</span>
                            <input type="file" id="png-file-input" accept="image/png" class="hidden" />
                        </div>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium mb-2 dark:text-gray-300">Ảnh xem trước:</p>
                            <img id="image-preview"
                                class="max-w-xs max-h-32 rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                        </div>
                        <div>
                            <label for="ico-size-select" class="block font-medium mb-2 dark:text-gray-300">Chọn kích
                                thước:</label>
                            <select id="ico-size-select"
                                class="w-full sm:w-auto p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                                <option value="16">16x16 pixels</option>
                                <option value="32" selected>32x32 pixels</option>
                                <option value="48">48x48 pixels</option>
                                <option value="64">64x64 pixels</option>
                                <option value="128">128x128 pixels</option>
                            </select>
                        </div>
                        <button id="convert-to-ico-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 
disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none 
dark:disabled:bg-gray-600/50 dark:disabled:text-gray-400 
shadow-lg hover:shadow-amber-500/40" disabled>Chuyển đổi & Tải xuống</button>
                        <div id="ico-status" class="text-sm text-green-600 dark:text-green-400 mt-2"></div>
                    </div>
                </div>
            </div>
            <div id="tool-base64" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Mã hóa & Giải mã Base64</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Mã hóa (1 lần) hoặc giải mã (nhiều lớp) chuỗi văn
                        bản của bạn.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="base64-input" class="font-medium dark:text-gray-300">Đầu vào:</label>
                            <textarea id="base64-input" rows="8"
                                class="w-full p-3 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="base64-output" class="font-medium dark:text-gray-300">Kết quả:</label>
                            <textarea id="base64-output" rows="8" readonly
                                class="w-full p-3 bg-gray-100/50 dark:bg-slate-800/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg cursor-not-allowed"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="base64-encode-btn"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">Mã
                            hóa (Encode)</button>
                        <button id="base64-decode-btn"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-blue-500/50">Giải
                            mã (Decode)</button>
                    </div>
                    <div id="base64-status" class="text-sm mt-4"></div>
                </div>
            </div>
            <div id="tool-my-apps" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Ứng dụng của tôi</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tổng hợp các ứng dụng Windows do tôi phát triển.
                        Nhấn để tải về và trải nghiệm!</p>
                    <div id="apps-list" class="space-y-6">
                        <div id="apps-loader" class="flex justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <p id="apps-empty-state" class="text-center text-gray-500 py-8 hidden">Chưa có ứng dụng nào được
                            thêm.</p>
                    </div>
                </div>
            </div>
            <div id="tool-my-diary" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">My Diary</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Đây là khu vực nhật ký của ba...</p>
                </div>
            </div>
            <div id="tool-my-research" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Một vài bài viết do chức năng
                        Deep Research của Gemini tạo ra!</h2>
                    <div id="blog-admin-controls" class="hidden">
                        <button id="blog-create-new-btn"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/40 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Tạo bài viết mới</span>
                        </button>
                    </div>
                    <div id="blog-posts-list" class="space-y-6">
                        <p id="blog-loading-state" class="text-center text-gray-500 py-8">Đang
                            tải bài viết...</p>
                        <p id="blog-empty-state" class="text-center text-gray-500 py-8 hidden">
                            Chưa có bài viết nào.</p>
                    </div>

                    <div id="blog-pagination-controls" class="hidden flex items-center justify-between mt-8">
                        <button id="blog-prev-btn"
                            class="bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            &larr; Trang trước
                        </button>
                        <span id="blog-page-indicator" class="font-semibold text-gray-700 dark:text-gray-300">Trang 1 /
                            1</span>
                        <button id="blog-next-btn"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 disabled:opacity-50 disabled:cursor-not-allowed">
                            Trang sau &rarr;
                        </button>
                    </div>

                </div>
            </div>
            <div id="tool-badminton-scheduler" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Badminton Scheduler</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tổng tiền đã
                                nộp:</label>
                            <p id="badminton-total-deposited"
                                class="text-2xl font-bold text-green-600 dark:text-green-400">0 đ</p>
                            <div class="mt-4 flex gap-2">
                                <input type="text" id="badminton-add-deposit" placeholder="Nộp thêm..."
                                    class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" />
                                <button id="badminton-submit-deposit"
                                    class="p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-all shadow-lg hover:shadow-green-500/50">
                                    [+]
                                </button>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tổng số ngày
                                đi:</label>
                            <p id="badminton-total-days" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0
                                ngày</p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tổng số tiền sân
                                (tháng này):</label>
                            <p id="badminton-total-cost" class="text-2xl font-bold text-red-500 dark:text-red-400">0 đ
                            </p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Số tiền còn
                                lại:</label>
                            <p id="badminton-remaining-balance"
                                class="text-2xl font-bold text-amber-600 dark:text-amber-400">0 đ</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <button id="calendar-prev-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <h3 id="calendar-month-year"
                                class="text-xl font-bold text-center text-amber-600 dark:text-amber-400">Tháng 11 / 2025
                            </h3>
                            <button id="calendar-next-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 dark:text-gray-400">
                            <div class="calendar-header">Thứ 2</div>
                            <div class="calendar-header">Thứ 3</div>
                            <div class="calendar-header">Thứ 4</div>
                            <div class="calendar-header">Thứ 5</div>
                            <div class="calendar-header">Thứ 6</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Thứ 7</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Chủ Nhật</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tool-admin-panel" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Cài đặt Hiển thị</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Chọn những tab mà <span
                            class="font-bold text-red-500">Khách (Guest)</span> có thể thấy.</p>

                    <div class="space-y-4 max-w-md">
                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-diary" class="font-medium text-gray-700 dark:text-gray-200">Hiện "My
                                Diary"</label>
                            <input type="checkbox" id="toggle-diary"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-research" class="font-medium text-gray-700 dark:text-gray-200">Hiện
                                "My Blog"</label>
                            <input type="checkbox" id="toggle-research"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-badminton" class="font-medium text-gray-700 dark:text-gray-200">Hiện
                                "B Scheduler"</label>
                            <input type="checkbox" id="toggle-badminton"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>
                    </div>
                </div>
        </main>
    </div>

    </div>
    </main>
    </div>
    <footer class="text-center py-4 mt-8 relative">
        <p class="text-base text-gray-500 dark:text-gray-400">
            Thời đại AI đang đến!!!! <br>
            Tất cả mọi thứ ở đây đều được tạo bằng Gemini.
        </p>
        <div class="absolute right-4 bottom-4 hidden sm:block">
            <p id="visit-counter" class="text-xs text-gray-400 dark:text-gray-500 text-right">
                Lượt truy cập: Đang tải...
            </p>
        </div>
    </footer>
    <div id="role-selection-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-sm glass-effect">
            <h3 class="text-3xl font-extrabold text-center mb-6 text-green-500 dark:text-green-400">OK, LÃO ĐẠI, XONG
                RỒI!</h3>
            <p class="text-center mb-8 text-gray-700 dark:text-gray-300">Nhảy vào với cái vai nào đây?</p>
            <div class="flex flex-col space-y-4">
                <button id="select-role-admin"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40">
                    Lão đại
                </button>
                <button id="select-role-guest"
                    class="w-full bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg transition duration-300">
                    Khách Vip
                </button>
            </div>
        </div>
    </div>
    <div id="blog-editor-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
        <div class="w-full max-w-4xl max-h-[90vh] flex flex-col bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-amber-600 dark:text-amber-400">Soạn thảo bài viết</h3>
            <div class="space-y-4 overflow-y-auto pr-2">
                <div>
                    <label for="blog-editor-title" class="block font-medium mb-1 dark:text-gray-300">Tiêu đề:</label>
                    <input type="text" id="blog-editor-title"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                </div>
                <div>
                    <label for="blog-editor-tags" class="block font-medium mb-1 dark:text-gray-300">Hashtags:</label>
                    <input type="text" id="blog-editor-tags" placeholder="Ví dụ: excel, vba, ai"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Cách nhau bằng dấu phẩy (,)</p>
                </div>
                <div>
                    <label class="block font-medium mb-1 dark:text-gray-300">Nội dung:</label>
                    <textarea id="blog-editor-textarea"></textarea>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                <button id="blog-editor-save-btn"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">Lưu
                    bài viết</button>
                <button id="blog-editor-cancel-btn"
                    class="flex-1 bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">Hủy</button>
                <input type="hidden" id="blog-editor-post-id">
            </div>
        </div>
    </div>
    <div id="blog-reader-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 hidden p-4">
        <div id="blog-reader-content"
            class="w-11/12 h-[90vh] flex flex-col bg-white dark:bg-slate-800 rounded-lg shadow-2xl overflow-hidden">
            <header class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700 overflow-y-auto">
                <h2 id="blog-reader-title" class="text-3xl font-bold text-amber-600 dark:text-amber-400">
                    Đây là Tiêu đề Bài viết
                </h2>
                <div id="blog-reader-tags" class="flex flex-wrap gap-2 mt-4">
                </div>
            </header>
            <article class="flex-1 p-6 overflow-y-auto">
                <div id="blog-reader-body" class="prose dark:prose-invert max-w-none">
                </div>
            </article>
            <footer
                class="flex-shrink-0 p-4 bg-gray-50 dark:bg-slate-900 border-t border-gray-200 dark:border-gray-700">
                <button id="blog-reader-close-btn"
                    class="w-full sm:w-auto bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-8 rounded-lg transition duration-300">
                    Đóng
                </button>
            </footer>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Initialization (CŨ CỦA BA) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCG_OqnwjNTg3kfCUmEkxo-qrJTMMsyhqk",
                authDomain: "my-toolbox-downloads.firebaseapp.com",
                projectId: "my-toolbox-downloads",
                storageBucket: "my-toolbox-downloads.appspot.com",
                messagingSenderId: "723884147235",
                appId: "1:723884147235:web:d08241abfd477d91c2e796"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            let globalTabSettings = { show_diary: false, show_research: false, show_badminton: false };
            const settingsRef = db.collection("settings").doc("tab_visibility");

            const storage = firebase.storage();
            // === CODE AUTH CỦA MỠ (BẢO MẬT + SỬA LỖI) ===
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); // <<< DÒNG MỠ THÊM VÀO ĐÂY
            const modal = document.getElementById('role-selection-modal');
            const selectGuestBtn = document.getElementById('select-role-guest');
            const selectAdminBtn = document.getElementById('select-role-admin');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            // (Tự động lắng nghe thay đổi từ Firestore)
            settingsRef.onSnapshot((doc) => {
                if (doc.exists) {
                    globalTabSettings = doc.data();
                } else {
                    // Nếu chưa có, tự tạo file cài đặt mặc định (ẩn hết)
                    settingsRef.set(globalTabSettings).catch(e => console.error("Lỗi tạo settings:", e));
                }
                console.log("Cài đặt tab đã cập nhật:", globalTabSettings);

                // Chạy lại hàm updateUI để áp dụng cài đặt mới cho Guest
                const user = auth.currentUser;
                checkAdminStatus(user);
            }, (error) => {
                console.error("Lỗi tải cài đặt tab:", error);
            });
            // === HÀM "SIÊU TRÂU BÒ" (style.display) + NÂNG CẤP AUTONUMERIC + BẢO MẬT ===
            // === HÀM "SIÊU TRÂU BÒ" (style.display) + NÂNG CẤP AUTONUMERIC + BẢO MẬT ===
            // === HÀM MỚI: CHUYÊN GIA KHÓA/MỞ LỊCH ===
            function setCalendarInputsReadOnly(isReadOnly) {
                // 1. Khóa/Mở các ô gõ tiền
                const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                inputs.forEach(input => {
                    if (input.autoNumericInstance) {
                        input.autoNumericInstance.options.readOnly(isReadOnly);
                    } else {
                        input.readOnly = isReadOnly;
                    }
                });

                // 2. Khóa/Mở các nút '●'
                const toggles = calendarGrid.querySelectorAll('.day-toggle');
                toggles.forEach(toggle => {
                    toggle.disabled = isReadOnly;
                });
            }

            // === HÀM "SIÊU TRÂU BÒ" (style.display) + NÂNG CẤP AUTONUMERIC + BẢO MẬT ===
            function updateUI(user, isAdmin) {
                // === MỠ BỔ SUNG 1: Đặt "biển báo" Admin toàn cục ===
                window.isAdmin = (user && isAdmin);
                // ===============================================
                const gView = document.getElementById('guest-view');
                const aView = document.getElementById('admin-view');
                const navD = document.getElementById('nav-my-diary');
                const navR = document.getElementById('nav-my-research');
                const navB = document.getElementById('nav-badminton-scheduler');
                const navAdmin = document.getElementById('nav-admin-panel');
                const addDepositInput = document.getElementById('badminton-add-deposit'); // Lấy ô Nộp tiền
                const submitDepositBtn = document.getElementById('badminton-submit-deposit'); // <<< MỠ LẤY THÊM NÚT

                // (Bản vá đầy đủ)
                if (!gView || !aView || !navD || !navR || !navB || !navAdmin || !addDepositInput || !submitDepositBtn) { // <<< MỠ THÊM NÚT VÀO CHECK
                    console.error("Lỗi nghiêm trọng: Không tìm thấy 1 trong các View UI!");
                    return;
                }

                // === MỠ "TÁI CẤU TRÚC" HÀM NÀY ===

                // 1. Khởi tạo AutoNumeric cho ô "Nộp thêm" (1 LẦN DUY NHẤT)
                // (Hàm này sẽ tự chạy 1 lần khi tải trang)
                if (addDepositInput && !addDepositInput.autoNumericInstance) {
                    const anInput = new AutoNumeric(addDepositInput, {
                        decimalCharacter: ',',
                        digitGroupSeparator: '.',
                        decimalPlaces: 0,
                        minimumValue: '-999999999',
                        maximumValue: '999999999',
                        // Không set readOnly ở đây, set ở dưới
                    });
                    addDepositInput.autoNumericInstance = anInput;
                }


                if (user && isAdmin) {
                    // 1. LÀ ADMIN
                    gView.style.display = 'none';
                    aView.style.display = 'block';
                    navD.classList.remove('hidden');
                    navR.classList.remove('hidden');
                    navB.classList.remove('hidden');
                    navAdmin.classList.remove('hidden');
                    initializeAdminBlogFeatures();
                    setCalendarInputsReadOnly(false);

                    // 2. Bật ô nộp tiền
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(false); // <<< Cho phép gõ
                    }
                    addDepositInput.placeholder = 'Nộp thêm...';
                    submitDepositBtn.disabled = false; // <<< Bật nút [+]

                    // 3. Tải lịch (nếu chưa)
                    // (Code này đã bị chuyển qua hàm showTool, nhưng Admin vẫn cần khởi tạo lần đầu)
                    if (!window.calendarInitialized) {
                        loadFundData();
                        renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                        window.calendarInitialized = true;
                    }

                    // 4. Set Avatar
                    const adminAvatar = document.getElementById('admin-avatar');
                    const adminName = document.getElementById('admin-name');
                    if (adminAvatar) adminAvatar.src = user.photoURL || 'images/favicon.png';
                    if (adminName) adminName.textContent = user.displayName || "Chào Admin!";

                } else {
                    // 1. LÀ GUEST
                    gView.style.display = 'block';
                    aView.style.display = 'none';
                    setCalendarInputsReadOnly(true); // <<< DÒNG MỚI (KHÓA LỊCH)

                    // 2. Tắt ô nộp tiền
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(true); // <<< Khóa gõ
                        addDepositInput.autoNumericInstance.clear(); // Xóa số (nếu lỡ gõ)
                    }
                    addDepositInput.placeholder = 'Chỉ Admin mới nộp quỹ'; // <<< Đổi chữ
                    submitDepositBtn.disabled = true; // <<< Tắt nút [+]

                    // 3. Ẩn/Hiện Nav theo cài đặt (Giữ nguyên)
                    navAdmin.classList.add('hidden');
                    if (globalTabSettings.show_diary) {
                        navD.classList.remove('hidden');
                    } else {
                        navD.classList.add('hidden');
                    }

                    if (globalTabSettings.show_research) {
                        navR.classList.remove('hidden');
                    } else {
                        navR.classList.add('hidden');
                    }

                    if (globalTabSettings.show_badminton) {
                        navB.classList.remove('hidden');
                    } else {
                        navB.classList.add('hidden');
                    }
                    if (user && !isAdmin) {
                        signOut();
                        alert("Tài khoản này không có quyền Admin!");
                    }

                    // === SỬA LỖI LOGIC "QUÉT PHÒNG" NẰM Ở ĐÂY ===

                    const currentHash = window.location.hash.substring(1);
                    const defaultTool = 'remove-bg'; // Trang an toàn

                    // 1. Tạo 1 danh sách các trang BỊ CẤM (tức là đang ẨN)
                    let forbiddenTools = ['admin-panel']; // 'admin-panel' luôn cấm
                    if (!globalTabSettings.show_diary) {
                        forbiddenTools.push('my-diary');
                    }
                    if (!globalTabSettings.show_research) {
                        forbiddenTools.push('my-research');
                    }
                    if (!globalTabSettings.show_badminton) {
                        forbiddenTools.push('badminton-scheduler');
                    }

                    // 2. Chỉ "đá" về trang chủ NẾU user đang ở 1 trang BỊ CẤM
                    if (forbiddenTools.includes(currentHash)) {
                        console.warn("User đang ở trang bị cấm (" + currentHash + "). Đá về trang chủ...");
                        // Chuyển link về trang an toàn
                        history.pushState({ toolId: defaultTool }, '', `#${defaultTool}`);
                        // Gọi hàm showTool để "vẽ" lại trang an toàn
                        showTool(defaultTool);
                    }
                    // === HẾT PHẦN SỬA LỖI ===
                }
            }


            // === THÊM HÀM MỚI NÀY ===
            function initializeAdminPanelToggles() {
                // Lấy 3 cái nút gạt
                const toggleDiary = document.getElementById('toggle-diary');
                const toggleResearch = document.getElementById('toggle-research');
                const toggleBadminton = document.getElementById('toggle-badminton');

                // (Thoát nếu lỡ gọi hàm mà chưa ở đúng tab)
                if (!toggleDiary) return;

                console.log("Khởi tạo Admin Panel Toggles...");

                // 1. Đặt trạng thái 'checked' theo cài đặt đã tải
                toggleDiary.checked = globalTabSettings.show_diary;
                toggleResearch.checked = globalTabSettings.show_research;
                toggleBadminton.checked = globalTabSettings.show_badminton;

                // 2. Gắn sự kiện 'change' để lưu lên Firestore
                // (Dùng .hasListener để tránh gắn 2-3 lần)
                if (!toggleDiary.hasListener) {
                    toggleDiary.addEventListener('change', () => {
                        settingsRef.update({ show_diary: toggleDiary.checked })
                            .catch(e => alert("Lỗi cập nhật Diary: " + e.message));
                    });
                    toggleDiary.hasListener = true;
                }

                if (!toggleResearch.hasListener) {
                    toggleResearch.addEventListener('change', () => {
                        settingsRef.update({ show_research: toggleResearch.checked })
                            .catch(e => alert("Lỗi cập nhật Research: " + e.message));
                    });
                    toggleResearch.hasListener = true;
                }

                if (!toggleBadminton.hasListener) {
                    toggleBadminton.addEventListener('change', () => {
                        settingsRef.update({ show_badminton: toggleBadminton.checked })
                            .catch(e => alert("Lỗi cập nhật Badminton: " + e.message));
                    });
                    toggleBadminton.hasListener = true;
                }
            }
            // === HẾT HÀM MỚI ===
            // === HÀM CHECK ADMIN (HỎI FIRESTORE) ===
            async function checkAdminStatus(user) {
                if (!user) {
                    updateUI(null, false);
                    return;
                }
                try {
                    const adminDocRef = db.collection("admins").doc(user.email);
                    const adminDoc = await adminDocRef.get();
                    if (adminDoc.exists) {
                        console.log("Admin đã đăng nhập:", user.email);
                        updateUI(user, true);
                    } else {
                        console.log("User lạ đăng nhập, không có quyền:", user.email);
                        updateUI(user, false);
                    }
                } catch (error) {
                    console.error("Lỗi khi check admin:", error);
                    updateUI(user, false);
                }
            }
            // === CÁC HÀM XỬ LÝ AUTH (GIỮ NGUYÊN) ===
            auth.onAuthStateChanged((user) => {
                const role = localStorage.getItem('userRole');
                if (user) {
                    checkAdminStatus(user);
                } else {
                    updateUI(null, false);
                    if (!role) {
                        modal.classList.add('show');
                    }
                }
            });
            function signInWithGoogle() {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        localStorage.setItem('userRole', 'admin');
                    })
                    .catch((error) => {
                        console.error("Lỗi đăng nhập:", error);
                        if (error.code === 'auth/popup-blocked-by-browser') {
                            alert("Trình duyệt đã chặn cửa sổ đăng nhập. Ba vui lòng cho phép pop-up cho trang này nha!");
                        } else if (error.code === 'auth/unauthorized-domain') {
                            alert("Lỗi: Tên miền này chưa được đăng ký với Firebase!");
                        }
                    });
            }
            function signOut() {
                auth.signOut()
                    .then(() => {
                        console.log("Đã đăng xuất.");
                        localStorage.setItem('userRole', 'guest');
                    })
                    .catch((error) => {
                        console.error("Lỗi đăng xuất:", error);
                    });
            }
            // === GÁN SỰ KIỆN CHO CÁC NÚT AUTH ===
            selectGuestBtn.addEventListener('click', () => {
                localStorage.setItem('userRole', 'guest');
                modal.classList.remove('show');
            });
            selectAdminBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                signInWithGoogle();
            });
            adminLoginBtn.addEventListener('click', () => {
                signInWithGoogle();
            });
            adminLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut();
            });






            /* ============================================================
            === BỘ NÃO BLOG "MY RESEARCH" (GĐ 6 - "KẾ TOÁN" PRO) ===
            ===       (Bản "TỔNG VỆ SINH" - Fix mọi lỗi)               ===
            ============================================================
            */
            // --- 1. Khai báo biến toàn cục cho Blog ---
            const blogPostsRef = db.collection("blog_posts");
            // "SỔ KẾ TOÁN" CỦA BA CON MÌNH
            const blogMetadataRef = db.collection("blog_metadata").doc("stats");

            const blogAdminControls = document.getElementById('blog-admin-controls');
            const blogCreateNewBtn = document.getElementById('blog-create-new-btn');
            const blogPostsList = document.getElementById('blog-posts-list');
            const blogLoadingState = document.getElementById('blog-loading-state');
            const blogEmptyState = document.getElementById('blog-empty-state');
            const blogEditorModal = document.getElementById('blog-editor-modal');
            const blogEditorTitle = document.getElementById('blog-editor-title');
            const blogEditorTags = document.getElementById('blog-editor-tags');
            const blogEditorTextarea = document.getElementById('blog-editor-textarea');
            const blogEditorSaveBtn = document.getElementById('blog-editor-save-btn');
            const blogEditorCancelBtn = document.getElementById('blog-editor-cancel-btn');
            const blogEditorPostId = document.getElementById('blog-editor-post-id');
            // Biến cho CỬA SỔ ĐỌC (READER MODAL)
            const blogReaderModal = document.getElementById('blog-reader-modal');
            const blogReaderBody = document.getElementById('blog-reader-body');
            // === MỠ THÊM 3 "TAY" MỚI ===
            const blogReaderArticle = document.querySelector('#blog-reader-content article'); // "TAY" GẮN NÚT
            let stickyCloseButton = null; // "TAY" ĐIỀU KHIỂN NÚT
            let blogObserver = null; // "MẮT THẦN"
            // === HẾT ===
            const blogReaderCloseBtn = document.getElementById('blog-reader-close-btn');
            let isBlogInitialized = false;
            // BIẾN TOÀN CỤC CHO PHÂN TRANG (PAGINATION)
            const blogPaginationControls = document.getElementById('blog-pagination-controls');
            const blogPrevBtn = document.getElementById('blog-prev-btn');
            const blogNextBtn = document.getElementById('blog-next-btn');
            const blogPageIndicator = document.getElementById('blog-page-indicator');
            let blogPageSize = 5; // Ba muốn 5 hay 10 thì sửa số này
            let blogCurrentPage = 1;
            let blogTotalPages = 1;
            let blogTotalPosts = 0;
            let blogPageMocks = [null]; // Mảng "mốc" (dấu trang)
            let isLoadingBlog = false;
            // === "BỘ NÃO MÀU" CỦA MỠ (DÙNG CHO HASHTAG) ===
            // 1. "Bảng Màu" 10 màu (Ba ưng màu nào thì sửa code Tailwind ở đây)
            // 1. "Bảng Màu" 10 màu (Ba ưng màu nào thì sửa code Tailwind ở đây)
            // 1. "Bảng Màu" 10 màu (Ba ưng màu nào thì sửa code Tailwind ở đây)
            // 1. "Bảng Màu" 10 màu (Ba ưng màu nào thì sửa code Tailwind ở đây)
            const tagColorPalette = [
                // [Nền Sáng, Chữ Sáng], [Nền Tối (700), Chữ Tối (200)] - ĐÃ SỬA DỊU MẮT
                ['bg-red-200', 'text-red-900', 'dark:bg-red-700', 'dark:text-red-200'],
                ['bg-amber-200', 'text-amber-900', 'dark:bg-amber-700', 'dark:text-amber-200'],
                ['bg-green-200', 'text-green-900', 'dark:bg-green-700', 'dark:text-green-200'],
                ['bg-blue-200', 'text-blue-900', 'dark:bg-blue-700', 'dark:text-blue-200'],
                ['bg-indigo-200', 'text-indigo-900', 'dark:bg-indigo-700', 'dark:text-indigo-200'],
                ['bg-purple-200', 'text-purple-900', 'dark:bg-purple-700', 'dark:text-purple-200'],
                ['bg-pink-200', 'text-pink-900', 'dark:bg-pink-700', 'dark:text-pink-200'],
                ['bg-sky-200', 'text-sky-900', 'dark:bg-sky-700', 'dark:text-sky-200'],
                ['bg-teal-200', 'text-teal-900', 'dark:bg-teal-700', 'dark:text-teal-200'],
                ['bg-orange-200', 'text-orange-900', 'dark:bg-orange-700', 'dark:text-orange-200']
            ];
            // 2. "Bộ não" "băm" chữ thành số (để bốc màu)
            function getStringHash(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash); // Trả về số dương
            }
            // 3. Hàm "bốc" màu (trả về 4 class)
            function getTagColorClasses(tagName) {
                const hash = getStringHash(tagName);
                const index = hash % tagColorPalette.length; // Lấy số dư (0-9)
                const colors = tagColorPalette[index];
                return `${colors[0]} ${colors[1]} ${colors[2]} ${colors[3]}`; // Trả về 4 class, ví dụ: "bg-red-200 text-red-900 dark:bg-red-700 dark:text-red-100"
            }
            // === HẾT "BỘ NÃO MÀU" ===

            // --- HÀM "ĐẦU TÀU": LẬT "SỔ KẾ TOÁN" (HẾT LỖI .count()) ---
            async function loadBlogPosts() {
                if (isLoadingBlog) return;
                isLoadingBlog = true;
                blogLoadingState.classList.remove('hidden');
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    // 1. Lật "Sổ Kế toán"
                    const metaDoc = await blogMetadataRef.get();
                    if (metaDoc.exists) {
                        blogTotalPosts = metaDoc.data().totalPosts || 0;
                    } else {
                        blogTotalPosts = 0; // Nếu sổ không có, coi như là 0
                    }

                    if (blogTotalPosts === 0) {
                        blogLoadingState.classList.add('hidden');
                        blogEmptyState.classList.remove('hidden');
                        isLoadingBlog = false;
                        return;
                    }
                    // 2. Tính toán
                    blogTotalPages = Math.ceil(blogTotalPosts / blogPageSize);
                    blogCurrentPage = 1;
                    blogPageMocks = [null]; // Reset mảng "mốc"
                    // 3. Tải trang đầu tiên
                    await fetchBlogPage(); // Tải trang 1
                } catch (error) {
                    console.error("Lỗi khi lật 'Sổ Kế toán':", error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = "<p class='text-center text-red-500'>\"Không thể đọc 'Sổ Kế toán'. Đã có lỗi.\"</p>";
                } finally {
                    isLoadingBlog = false;
                }
            }

            // --- HÀM "CỐT LÕI" 1: TẢI BÀI VIẾT THEO TRANG ---
            async function fetchBlogPage() {
                blogLoadingState.classList.remove('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    const startAfterMoc = blogPageMocks[blogCurrentPage - 1];
                    let query = blogPostsRef.orderBy("createdAt", "desc");
                    if (startAfterMoc) {
                        query = query.startAfter(startAfterMoc);
                    }
                    query = query.limit(blogPageSize);
                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden');
                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        return;
                    }
                    // "Vẽ" 5 bài viết
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'Bài viết không có tiêu đề';
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN');
                        postCard.appendChild(dateEl);
                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(Bài viết này chưa có tóm tắt...)';
                        postCard.appendChild(summaryEl);
                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "BỐC MÀU HÀNG HIỆU" CỦA MỠ!
                                const colorClasses = getTagColorClasses(tag);
                                // "Mượn" thêm mấy cái class cơ bản
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trộn" lại!
                                return `<span class="${baseClasses} ${colorClasses}">
        ${tag}
    </span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }
                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                            <div class="mt-4 flex gap-2">
                                <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sửa]</button>
                                <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[Xóa]</button>
                            </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });
                    // LƯU "MỐC" (dấu trang)
                    const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    blogPageMocks[blogCurrentPage] = lastDoc;
                    updatePaginationUI();
                } catch (error) {
                    console.error("Lỗi khi tải trang " + blogCurrentPage, error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = '<p class="text-center text-red-500">Tải trang thất bại.</p>';
                } finally {
                    blogPaginationControls.classList.remove('hidden');
                }
            }

            // --- HÀM "CỐT LÕI" 2: CẬP NHẬT NÚT BẤM (UI) ---
            function updatePaginationUI() {
                blogPageIndicator.textContent = `Trang ${blogCurrentPage} / ${blogTotalPages}`;
                blogPrevBtn.disabled = (blogCurrentPage === 1);
                blogNextBtn.disabled = (blogCurrentPage === blogTotalPages);
            }

            // --- HÀM MỞ "PHÒNG SOẠN THẢO" (TinyMCE) ---
            function openBlogEditor(postData = null) {
                blogEditorTitle.value = '';
                blogEditorTags.value = '';
                blogEditorPostId.value = '';
                if (tinymce.get('blog-editor-textarea')) {
                    tinymce.get('blog-editor-textarea').destroy();
                }
                tinymce.init({
                    selector: '#blog-editor-textarea',
                    license_key: 'gpl',
                    plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount fullscreen',
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat | fullscreen',
                    skin: (window.matchMedia('(prefers-color-scheme: dark)').matches || document.documentElement.classList.contains('dark')) ? "oxide-dark" : "oxide",
                    content_css: (window.matchMedia('(prefers-color-scheme: dark)').matches || document.documentElement.classList.contains('dark')) ? "dark" : "default",
                    height: 400,
                    file_picker_types: 'image media',
                    file_picker_callback: (cb, value, meta) => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        if (meta.filetype === 'image') { input.setAttribute('accept', 'image/*'); }
                        else if (meta.filetype === 'media') { input.setAttribute('accept', 'audio/*,video/*'); }
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const storageRef = storage.ref();
                            const fileName = `blog_assets/${new Date().getTime()}_${file.name}`;
                            const fileRef = storageRef.child(fileName);
                            const uploadTask = fileRef.put(file);
                            uploadTask.on('state_changed',
                                (snapshot) => { console.log('Đang tải lên: ' + snapshot.bytesTransferred + ' / ' + snapshot.totalBytes); },
                                (error) => { console.error("Lỗi tải file lên Storage:", error); alert("Tải file thất bại: " + error.message); },
                                () => {
                                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                        console.log('Tải file thành công:', downloadURL);
                                        cb(downloadURL, { title: file.name });
                                    });
                                }
                            );
                        });
                        input.click();
                    }
                }).then(() => {
                    if (postData) {
                        blogEditorTitle.value = postData.title;
                        blogEditorTags.value = postData.tags ? postData.tags.join(', ') : '';
                        tinymce.get('blog-editor-textarea').setContent(postData.content);
                        blogEditorPostId.value = postData.id;
                    } else {
                        tinymce.get('blog-editor-textarea').setContent('<p>Ba gõ nội dung vào đây...</p>');
                    }
                });
                blogEditorModal.classList.remove('hidden');
            }

            // --- HÀM LƯU BÀI (GHI VÀO "SỔ KẾ TOÁN") ---
            async function saveBlogPost() {
                const title = blogEditorTitle.value.trim();
                const content = tinymce.get('blog-editor-textarea').getContent();
                const tagsString = blogEditorTags.value.trim();
                const postId = blogEditorPostId.value;
                if (!title || !content) {
                    alert("Ba ơi, ba phải gõ Tiêu đề và Nội dung chứ!");
                    return;
                }
                // Tạo Tóm tắt
                let summary = tinymce.get('blog-editor-textarea').getContent({ format: 'text' });
                summary = summary.replace(/\s+/g, ' ').trim();
                if (summary.length > 200) {
                    summary = summary.substring(0, 200) + '...';
                } else if (summary.length === 0 && content.length > 0) {
                    summary = '[Bài viết chứa nội dung đa phương tiện...]';
                }
                const tagsArray = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                blogEditorSaveBtn.disabled = true;
                blogEditorSaveBtn.textContent = 'Đang lưu...';
                try {
                    const postData = {
                        title: title,
                        content: content,
                        summary: summary,
                        tags: tagsArray,
                    };

                    // Bắt đầu "Giao dịch" (batch)
                    const batch = db.batch();

                    if (postId) {
                        // SỬA BÀI (Không đụng tới sổ Kế toán)
                        postData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        const postRef = blogPostsRef.doc(postId);
                        batch.update(postRef, postData);
                        console.log("Đã cập nhật bài viết:", postId);
                    } else {
                        // TẠO BÀI MỚI (Phải +1 vô sổ)
                        postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        postData.authorId = auth.currentUser.uid;
                        const newPostRef = blogPostsRef.doc(); // Tạo 1 ref mới
                        batch.set(newPostRef, postData); // 1. Lưu bài viết
                        // 2. "Ghi sổ" (+1)
                        batch.set(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                        console.log("Đã tạo bài viết mới!");
                    }

                    await batch.commit(); // Chạy "Giao dịch"

                    blogEditorModal.classList.add('hidden');
                    tinymce.get('blog-editor-textarea').destroy();
                    loadBlogPosts(); // Tải lại (Reset)
                } catch (error) {
                    console.error("Lỗi khi lưu bài viết:", error);
                    alert("Lưu bài thất bại: " + error.message);
                } finally {
                    blogEditorSaveBtn.disabled = false;
                    blogEditorSaveBtn.textContent = 'Lưu bài viết';
                }
            }

            // --- HÀM XÓA BÀI (TRỪ "SỔ KẾ TOÁN") ---
            async function deleteBlogPost(postId, postTitle) {
                if (!confirm(`Ba có chắc chắn muốn XÓA bài viết "${postTitle}" không?`)) {
                    return;
                }
                try {
                    // Bắt đầu "Giao dịch"
                    const batch = db.batch();
                    // 1. Xóa bài
                    const postRef = blogPostsRef.doc(postId);
                    batch.delete(postRef);
                    // 2. "Ghi sổ" (-1)
                    batch.update(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(-1) });

                    await batch.commit(); // Chạy "Giao dịch"

                    console.log("Đã xóa bài viết và cập nhật sổ:", postId);
                    loadBlogPosts(); // Tải lại (Reset)
                } catch (error) {
                    console.error("Lỗi khi xóa bài viết:", error);
                    alert("Xóa bài thất bại: " + error.message);
                }
            }

            // === HÀM "ĐẠI PHẪU THUẬT" V5 ("MẮT THẦN") ===
            function openReaderModal(postData) {
                if (!blogReaderModal || !blogReaderBody || !blogReaderArticle) {
                    console.error("Lỗi: Mất bộ phận Cửa sổ đọc (V5)!");
                    return;
                }

                // 1. "GỘP" Tiêu đề và Tags (Giữ nguyên)
                let tagsHTML = '';
                if (postData.tags && postData.tags.length > 0) {
                    tagsHTML = postData.tags.map(tag => {
                        // "BỐC MÀU HÀNG HIỆU" CỦA MỠ!
                        const colorClasses = getTagColorClasses(tag);
                        // "Mượn" thêm mấy cái class cơ bản
                        const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                        // "Trộn" lại!
                        return `<span class="${baseClasses} ${colorClasses}">
                ${tag}
            </span>`;
                    }).join(' ');
                }
                const headerHTML = `
        <div class="in-article-header">
            <h2 class="in-article-title">${postData.title || 'Bài viết không có tiêu đề'}</h2>
            <div class="in-article-tags">
                ${tagsHTML || 'Chưa gắn tag'}
            </div>
        </div>
    `;

                // 2. "BƠM" (Gộp header + nội dung + "MẮT THẦN")
                blogReaderBody.innerHTML = headerHTML +
                    (postData.content || '<p>Nội dung đang cập nhật...</p>') +
                    '<div class="article-end-sentinel"></div>'; // Gắn "Mắt thần" ở đáy

                // 3. TẠO NÚT "ĐÓNG" (Chỉ 1 lần duy nhất)
                if (!stickyCloseButton) {
                    console.log("Tạo nút 'Đóng' lơ lửng (1 lần)");
                    stickyCloseButton = document.createElement('button');
                    stickyCloseButton.className = 'sticky-close-btn-injected'; // Gọi CSS "V5"
                    stickyCloseButton.textContent = 'Đóng';

                    // "Gắn" nút "Đóng" vào khu vực cuộn (Article)
                    blogReaderArticle.appendChild(stickyCloseButton);

                    // Gắn "dây điện" HỦY DIỆT cho nút
                    stickyCloseButton.addEventListener('click', () => {
                        blogReaderModal.classList.add('hidden'); // Đóng cửa sổ
                        stickyCloseButton.classList.remove('show'); // Tự "tàng hình"
                        if (blogObserver) blogObserver.disconnect(); // Tắt "mắt thần"
                        blogReaderBody.innerHTML = ''; // Xóa bài viết
                    });
                }

                // 4. RESET (Bắt buộc phải reset)
                blogReaderBody.scrollTop = 0; // Cuộn lên đầu
                stickyCloseButton.classList.remove('show'); // Ẩn nút "Đóng"

                // 5. GẮN DÂY ĐIỆN "MẮT THẦN" (Chỉ 1 lần)
                if (!blogObserver) {
                    console.log("Khởi động 'Mắt thần' (1 lần)");
                    const options = {
                        root: blogReaderArticle, // "Mắt thần" nhìn bên trong khu "Article"
                        rootMargin: '0px 0px 0px 0px',
                        threshold: 0.1 // Thấy 10% là "la làng"
                    };
                    blogObserver = new IntersectionObserver(handleObserver, options);
                }
                // (Bắt "Mắt thần" "canh" cái đáy bài)
                const sentinel = blogReaderBody.querySelector('.article-end-sentinel');
                if (sentinel) blogObserver.observe(sentinel);

                // 6. GẮN DÂY ĐIỆN TAG (Giữ nguyên)
                if (!blogReaderBody.hasTagListener) {
                    blogReaderBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('blog-tag-link')) {
                            const tagName = e.target.textContent.trim();
                            blogReaderModal.classList.add('hidden');
                            stickyCloseButton.classList.remove('show');
                            if (blogObserver) blogObserver.disconnect();
                            fetchBlogPostsByTag(tagName); // Lọc
                        }
                    });
                    blogReaderBody.hasTagListener = true;
                }

                // 7. Mở Cửa sổ!
                blogReaderModal.classList.remove('hidden');
            }




            // === HÀM MỚI (LỌC THEO TAG - CẦN INDEX!) ===
            async function fetchBlogPostsByTag(tagName) {
                console.log(`Đang lọc bài viết theo tag: "${tagName}"...`);

                // 1. Dọn dẹp giao diện
                blogLoadingState.classList.remove('hidden'); // Bật "Đang tải..."
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden'); // Ẩn phân trang

                // 2. Tạo giao diện "Đang lọc"
                const filterStatusEl = document.createElement('div');
                filterStatusEl.id = 'blog-filter-status'; // (Mỡ thêm ID để xóa)
                filterStatusEl.className = 'p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg mb-6 flex justify-between items-center';
                filterStatusEl.innerHTML = `
        <span class="font-medium text-amber-800 dark:text-amber-200">
            Đang lọc theo tag: <strong class="text-lg">${tagName}</strong>
        </span>
        <button id="blog-clear-filter-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
            &times; Xóa bộ lọc
        </button>
    `;
                // Chèn vào *trước* danh sách bài viết
                blogPostsList.before(filterStatusEl);

                // Gắn sự kiện cho nút "Xóa bộ lọc"
                document.getElementById('blog-clear-filter-btn').addEventListener('click', () => {
                    filterStatusEl.remove(); // Xóa cái thanh "Đang lọc"
                    blogEmptyState.textContent = 'Chưa có bài viết nào.'; // (Trả lại chữ cũ)
                    loadBlogPosts(); // Tải lại như cũ
                });

                // 3. Truy vấn Firestore (Cần Index!)
                try {
                    const query = blogPostsRef
                        .where("tags", "array-contains", tagName) // <-- CHIÊU "PRO" LÀ ĐÂY!
                        .orderBy("createdAt", "desc");

                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden'); // Tắt "Đang tải..."

                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        // (Đổi chữ cho ba dễ biết)
                        blogEmptyState.textContent = `Không tìm thấy bài viết nào có tag "${tagName}".`;
                        return;
                    }

                    // 4. "Vẽ" kết quả (Copy y chang hàm fetchBlogPage)
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';


                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'Bài viết không có tiêu đề';
                        // (Gọi hàm đã thống nhất)
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);

                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN') : '...';
                        postCard.appendChild(dateEl);

                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(Bài viết này chưa có tóm tắt...)';
                        postCard.appendChild(summaryEl);

                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "BỐC MÀU HÀNG HIỆU" CỦA MỠ!
                                const colorClasses = getTagColorClasses(tag);
                                // "Mượn" thêm mấy cái class cơ bản
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trộn" lại!
                                return `<span class="${baseClasses} ${colorClasses}">${tag}</span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }

                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                <div class="mt-4 flex gap-2">
                    <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sửa]</button>
                    <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[Xóa]</button>
                </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });

                } catch (error) {
                    console.error("Lỗi khi lọc tag:", error);
                    blogLoadingState.classList.add('hidden');

                    // ĐÂY LÀ "THẦN CHÚ" BÁO LỖI INDEX
                    if (error.code === 'failed-precondition') {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500 p-4 bg-red-100 dark:bg-red-900/50 rounded-lg">
                <b>Lỗi "đụng nóc" Firestore!</b><br>
                Ba ơi, ba cần tạo "Chỉ mục" (Index) thì mới lọc tag được! <br>
                <span class="text-xs">(Lỗi: ${error.message})</span>
            </p>`;
                    } else {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500">Lọc tag thất bại.</p>`;
                    }
                }
            }


            // === HÀM "MẮT THẦN" (V5) ===
            function handleObserver(entries) {
                if (!stickyCloseButton) return; // Nếu chưa có nút thì thôi

                const entry = entries[0];
                if (entry.isIntersecting) {
                    // "Mắt thần" THẤY đáy bài -> Hiện nút
                    stickyCloseButton.classList.add('show');
                } else {
                    // "Mắt thần" MẤT DẤU đáy bài -> Ẩn nút
                    stickyCloseButton.classList.remove('show');
                }
            }

            // === HÀM "MẤT TÍCH" MỠ VIẾT BÙ CHO BA ===
            // (Gắn dây điện cho các nút của Admin)
            function initializeAdminBlogFeatures() {
                console.log("Kích hoạt tính năng Admin Blog (Tạo/Sửa/Xóa)...");

                // 1. Hiện nút "Tạo bài viết mới"
                if (blogAdminControls) {
                    blogAdminControls.classList.remove('hidden');
                }

                // 2. Gắn sự kiện cho nút "Tạo bài viết mới"
                // (Con thêm .hasListener để nó không bị gắn 2 lần)
                if (blogCreateNewBtn && !blogCreateNewBtn.hasListener) {
                    blogCreateNewBtn.addEventListener('click', () => {
                        openBlogEditor(null); // Mở editor rỗng
                    });
                    blogCreateNewBtn.hasListener = true;
                }

                // 3. Gắn sự kiện "cha" cho Sửa/Xóa (Event Delegation)
                if (blogPostsList && !blogPostsList.hasAdminListener) {
                    blogPostsList.addEventListener('click', async (e) => {
                        const target = e.target;
                        const postId = target.dataset.id;

                        // === MỠ THÊM "DÂY ĐIỆN TAG" VÀO ĐÂY ===
                        if (target.classList.contains('blog-tag-link')) {
                            e.preventDefault(); // Ngăn hành vi lạ
                            const tagName = target.textContent.trim();
                            console.log("Ba click vào tag:", tagName);

                            // Xóa các thanh "Đang lọc" cũ nếu có
                            document.querySelectorAll('#blog-filter-status').forEach(el => el.remove());

                            fetchBlogPostsByTag(tagName); // Gọi hàm lọc mới
                            return; // Click tag thì thôi, không làm gì nữa
                        }
                        // === HẾT DÂY ĐIỆN TAG ===

                        // Bấm nút [Sửa]
                        if (target.classList.contains('blog-edit-btn') && postId) {
                            try {
                                const postDoc = await blogPostsRef.doc(postId).get();
                                if (postDoc.exists) {
                                    const postData = { id: postDoc.id, ...postDoc.data() };
                                    openBlogEditor(postData); // Mở editor với data
                                } else {
                                    alert("Lỗi: Không tìm thấy bài viết này!");
                                }
                            } catch (error) {
                                console.error("Lỗi khi lấy bài viết để sửa:", error);
                                alert("Lỗi khi tải bài viết!");
                            }
                        }

                        // Bấm nút [Xóa]
                        if (target.classList.contains('blog-delete-btn') && postId) {
                            const postCard = target.closest('.blog-post-card');
                            const titleEl = postCard ? postCard.querySelector('h3') : null;
                            const title = titleEl ? titleEl.textContent : 'bài viết này';
                            deleteBlogPost(postId, title);
                        }
                    });
                    blogPostsList.hasAdminListener = true;
                }
            }

            /* ============================================================
            === BỘ NÃO BADMINTON SCHEDULER (BẢN NÂNG CẤP AUTONUMERIC) ===
            ============================================================
            */
            // --- 1. Khai báo biến toàn cục cho lịch ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('calendar-prev-month');
            const nextMonthBtn = document.getElementById('calendar-next-month');
            const totalDepositedEl = document.getElementById('badminton-total-deposited');
            const addDepositInput = document.getElementById('badminton-add-deposit');
            const submitDepositBtn = document.getElementById('badminton-submit-deposit');
            const totalDaysEl = document.getElementById('badminton-total-days');
            const totalCostEl = document.getElementById('badminton-total-cost');
            const remainingBalanceEl = document.getElementById('badminton-remaining-balance');
            let currentDate = new Date();
            let currentMonthData = {};
            let currentFund = {
                totalDeposited: 0,
                totalCostEver: 0,
                totalDaysEver: 0
            };
            // --- 2. Hàm "Vẽ Lịch" (NÂNG CẤP AUTONUMERIC) ---
            // --- 2. Hàm "Vẽ Lịch" (BẢN VÁ LỖI CRASH CUỐI CÙNG) ---
            async function renderCalendar(month, year) {
                console.log(`Đang vẽ lịch cho: ${month + 1}/${year}`);

                // === BƯỚC 1: TẢI DATA TRƯỚC ===
                await loadMonthData(month, year);

                monthYearHeader.textContent = `Tháng ${month + 1} / ${year}`;

                let firstDayOfMonth = new Date(year, month, 1).getDay();
                let startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                let daysInMonth = new Date(year, month + 1, 0).getDate();

                // === BƯỚC 2: TẠO CHUỖI HTML (TẠO 1 LẦN) ===
                let calendarHtml = ''; // Tạo 1 chuỗi rỗng

                // A. Vẽ các ô "mờ" của tháng trước
                for (let i = 0; i < startDay; i++) {
                    calendarHtml += `<div class="calendar-day not-in-month"></div>`; // Nối vào chuỗi
                }

                // B. Vẽ các ô ngày của tháng này
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = currentMonthData[dateString] || {};
                    const isPresent = dayData.present || false;
                    const cost = dayData.cost || '';

                    // (Đã xóa placeholder="_" ở đây)
                    calendarHtml += `
<div class="calendar-day">
<span class="day-number">${day}</span>
<button 
class="day-toggle ${isPresent ? 'active' : ''}" 
data-date="${dateString}"
data-old-present="${isPresent}">
●
</button>
<input 
type="text"  
class="day-cost-input" 
placeholder="_" 
value="${cost}"
data-date="${dateString}"
data-old-cost="${cost || 0}">
</div>
`; // Nối vào chuỗi
                }

                // === BƯỚC 3: "BƠM" HTML VÀO LỊCH (CHỈ 1 LẦN) ===
                calendarGrid.innerHTML = calendarHtml;

                // === BƯỚC 4: "HỒI SỨC" (setTimeout) TRƯỚC KHI GỌI AUTONUMERIC ===
                // Chiêu này đảm bảo DOM đã "thở" xong
                setTimeout(() => {
                    try {
                        // C. Khởi động "Hàng hiệu"
                        const anInputs = new AutoNumeric.multiple('.day-cost-input', {
                            decimalCharacter: ',',
                            digitGroupSeparator: '.',
                            decimalPlaces: 0,
                            minimumValue: '-999999999',
                            maximumValue: '999999999'
                        });

                        // Lưu instance vào từng input
                        const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                        inputs.forEach(input => {
                            input.autoNumericInstance = AutoNumeric.getAutoNumericElement(input);

                        });

                        // === BƯỚC 5: SAU KHI KHỞI TẠO XONG, MỚI KHÓA/MỞ ===
                        setCalendarInputsReadOnly(!window.isAdmin);

                        // === BƯỚC 6: TÍNH TOÁN LẠI TIỀN (VÌ HÀM NÀY NẰM CUỐI CÙNG) ===
                        calculateThisMonthCost();


                    } catch (e) {
                        console.error("LỖI AUTONUMERIC NGHIÊM TRỌNG:", e);
                        calendarGrid.innerHTML = `<p class="text-red-500 text-center">Lỗi nghiêm trọng khi khởi tạo AutoNumeric. Không thể vẽ lịch.</p>`;
                    }
                }, 0); // Chỉ cần 0ms để đẩy nó ra sau
            }
            // --- 3. Hàm "Tính toán" ---
            function calculateThisMonthCost() {
                let thisMonthCost = 0;
                Object.values(currentMonthData).forEach(data => {
                    thisMonthCost += Number(data.cost || 0);
                });
                totalCostEl.textContent = `${thisMonthCost.toLocaleString('vi-VN')} đ`;
            }
            function updateSummaryUI() {
                const remaining = currentFund.totalDeposited - currentFund.totalCostEver;
                totalDepositedEl.textContent = `${currentFund.totalDeposited.toLocaleString('vi-VN')} đ`;
                totalDaysEl.textContent = `${currentFund.totalDaysEver} ngày`;
                remainingBalanceEl.textContent = `${remaining.toLocaleString('vi-VN')} đ`;
            }
            // --- 4. Hàm "Nói chuyện với Firestore" ---
            function loadFundData() {
                const fundRef = db.collection("badminton_fund").doc("global");
                fundRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        currentFund = doc.data();
                        console.log("Đã tải Quỹ:", currentFund);
                    } else {
                        console.log("Chưa có Quỹ, đang tạo mới...");
                        fundRef.set(currentFund);
                    }
                    updateSummaryUI();
                }, (error) => {
                    console.error("Lỗi khi tải Quỹ:", error);
                });
            }
            async function loadMonthData(month, year) {
                const monthString = String(month + 1).padStart(2, '0');
                const queryKey = `${year}-${monthString}`;
                const scheduleRef = db.collection("badminton_schedule");
                const snapshot = await scheduleRef
                    .where(firebase.firestore.FieldPath.documentId(), '>=', queryKey)
                    .where(firebase.firestore.FieldPath.documentId(), '<', `${queryKey}-32`)
                    .get();
                currentMonthData = {};
                snapshot.forEach(doc => {
                    currentMonthData[doc.id] = doc.data();
                });
                console.log(`Đã tải data cho ${queryKey}:`, currentMonthData);
            }
            // Hàm Lưu data (BẢN SỬA LỖI LOGIC "LẠC QUAN" CUỐI CÙNG)
            // Hàm Lưu data (BẢN SỬA LỖI LOGIC "LẠC QUAN" CUỐI CÙNG)
            async function saveData(dateString, isPresent, newCost, oldIsPresent, oldCost) { // <<< SỬA 1: Nhận newCost (dạng SỐ)
                const dayRef = db.collection("badminton_schedule").doc(dateString);
                const fundRef = db.collection("badminton_fund").doc("global");
                // === BƯỚC 1: TÍNH TOÁN TRƯỚC ===
                // const newCost = AutoNumeric.getNumber(costString); // <<< SỬA 2: Bỏ dòng lỗi này đi
                const costDiff = newCost - Number(oldCost || 0);
                let dayDiff = 0;
                if (isPresent && !oldIsPresent) {
                    dayDiff = 1;
                } else if (!isPresent && oldIsPresent) {
                    dayDiff = -1;
                }
                // === BƯỚC 2: CẬP NHẬT GIAO DIỆN "LẠC QUAN" ===
                // (Phần này đã đúng, nó gọi updateSummaryUI)
                if (costDiff !== 0 || dayDiff !== 0) {
                    // 1. Cập nhật "bộ nhớ đệm" (cache)
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                    currentFund.totalCostEver += costDiff;
                    currentFund.totalDaysEver += dayDiff;
                    // 2. "Vẽ" lại UI NGAY LẬP TỨC
                    updateSummaryUI();
                    calculateThisMonthCost(); // <<< THÊM DÒNG NÀY ĐỂ ADMIN CẬP NHẬT
                } else {
                    // Nếu k sửa gì, chỉ cập nhật cache
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                }
                // === BƯỚC 3: GỬI LỆNH LƯU LÊN FIREBASE (CHẠY NGẦM) ===
                const batch = db.batch();
                batch.set(dayRef, { present: isPresent, cost: newCost }, { merge: true });
                if (costDiff !== 0 || dayDiff !== 0) {
                    batch.update(fundRef, {
                        totalCostEver: firebase.firestore.FieldValue.increment(costDiff),
                        totalDaysEver: firebase.firestore.FieldValue.increment(dayDiff)
                    });
                }
                try {
                    await batch.commit();
                    console.log(`Đã lưu data (chạy ngầm) ngày ${dateString} và cập nhật Quỹ!`);
                } catch (error) {
                    console.error("Lỗi khi lưu data (chạy ngầm):", error);
                }
            }
            // Hàm Nộp Quỹ (BẢN "LẠC QUAN" CHUẨN + SỐ ÂM)
            // Hàm Nộp Quỹ (BẢN "LẠC QUAN" CHUẨN + SỐ ÂM)
            async function submitDeposit() {
                const amount = addDepositInput.autoNumericInstance.getNumber();
                if (isNaN(amount) || amount === 0) {
                    alert("Ba gõ số tiền (âm hoặc dương) vào đi ạ!");
                    return;
                }
                // === BƯỚC 1: CẬP NHẬT GIAO DIỆN "LẠC QUAN" ===
                currentFund.totalDeposited += amount;
                updateSummaryUI(); // DÒNG NÀY CẬP NHẬT 4 Ô TỔNG KẾT
                // === BƯỚC 2: Xóa ô input ===
                addDepositInput.autoNumericInstance.clear();
                // === BƯỚC 3: GỬI LỆNH LƯU LÊN FIREBASE (CHẠY NGẦM) ===
                const fundRef = db.collection("badminton_fund").doc("global");
                try {
                    await fundRef.update({
                        totalDeposited: firebase.firestore.FieldValue.increment(amount)
                    });
                    if (amount > 0) {
                        console.log(`Nộp quỹ (chạy ngầm) thành công: ${amount}`);
                    } else {
                        console.log(`Rút quỹ (chạy ngầm) thành công: ${amount}`);
                    }
                } catch (error) {
                    console.error("Lỗi khi nộp quỹ (chạy ngầm):", error);
                }
            }
            // --- 5. Gán Sự kiện (Event Listeners) ---
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            submitDepositBtn.addEventListener('click', submitDeposit);
            // DÂY ĐIỆN NÂNG CẤP 1 (CLICK ●)
            // DÂY ĐIỆN NÂNG CẤP 1 (CLICK ●)
            calendarGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('day-toggle')) {
                    if (!window.isAdmin) return; // <<< BẢO VỆ CHỐNG GUEST
                    const button = e.target;
                    const dateString = button.dataset.date;
                    const input = document.querySelector(`.day-cost-input[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    button.classList.toggle('active');
                    const newIsPresent = button.classList.contains('active');
                    // === SỬA LỖI NẰM Ở ĐÂY ===
                    // Phải lấy SỐ từ instance AutoNumeric, không lấy CHỮ (string)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    button.dataset.oldPresent = newIsPresent;
                    // Truyền con SỐ (newCostNumber) vào hàm saveData
                    saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                }
            });
            // DÂY ĐIỆN NÂNG CẤP 2 (GÕ TIỀN)
            calendarGrid.addEventListener('focusout', (e) => {

                if (e.target.classList.contains('day-cost-input')) {
                    if (!window.isAdmin) return;
                    const input = e.target;
                    const dateString = input.dataset.date;
                    const button = document.querySelector(`.day-toggle[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    const newIsPresent = button.classList.contains('active');
                    // === SỬA LỖI NẰM Ở ĐÂY ===
                    // Lấy SỐ (giống như hàm trên)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    if (newCostNumber !== oldCost) {
                        input.dataset.oldCost = newCostNumber;
                        // Truyền con SỐ (newCostNumber) vào hàm saveData
                        saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                    }
                }
            });
            /* ============================================================
            === HẾT BỘ NÃO BADMINTON ===
            ============================================================
            */
            // === CODE CŨ CỦA BA (MỠ GỘP VÀO ĐÂY) ===
            // --- BỘ ĐẾM TRUY CẬP (CŨ CỦA BA) ---
            async function updateVisitCount() {
                const counterElement = document.getElementById('visit-counter');
                if (!counterElement) return;
                const docRef = db.collection("stats").doc("global");
                docRef.update({
                    visits: firebase.firestore.FieldValue.increment(1)
                }).catch(error => {
                    if (error.code === 'not-found') {
                        docRef.set({ visits: 1 }).catch(err => console.error("Lỗi tạo Document lần đầu:", err));
                    } else {
                        console.error("Lỗi tăng lượt truy cập:", error);
                    }
                });
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const count = doc.data().visits;
                        counterElement.innerHTML = `Lượt truy cập: <strong>${count.toLocaleString('vi-VN')}</strong>`;
                    }
                }, (error) => {
                    console.error("Lỗi đọc lượt truy cập (listener):", error);
                    counterElement.textContent = 'Lượt truy cập: Không thể tải.';
                });
            }
            updateVisitCount();
            // --- Theme Toggle Logic (CŨ CỦA BA) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }
            themeToggleBtn.addEventListener('click', () => {
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });
            // --- Navigation Logic (CŨ CỦA BA) ---
            const navLinks = document.querySelectorAll('.nav-link');
            const toolContents = document.querySelectorAll('.tool-content');
            function showTool(toolId) {
                navLinks.forEach(nav => nav.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-tool="${toolId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                let targetFound = false;
                toolContents.forEach(content => {
                    if (content.id === `tool-${toolId}`) {
                        targetFound = true;
                        content.classList.remove('hidden');
                        setTimeout(() => content.classList.remove('opacity-0'), 10);
                        // === THẦN CHÚ CỦA MỠ (GỌI HÀM BLOG) ===
                        // (Mình chỉ tải 1 lần đầu tiên thôi nha ba)
                        if (toolId === 'my-research' && !window.isBlogInitialized) {
                            console.log("Lần đầu vào 'My Research', tải blog...");
                            loadBlogPosts(); // Tải blog lần đầu
                            window.isBlogInitialized = true; // Đánh dấu đã tải
                        }
                        // === HẾT THẦN CHÚ ===

                        // === MỠ THÊM: CHO GUEST XEM LỊCH ===
                        if (toolId === 'badminton-scheduler' && !window.calendarInitialized) {
                            console.log("Lần đầu vào 'B Scheduler', tải lịch (cho cả Guest)...");
                            // Guest không cần AutoNumeric cho ô "Nộp thêm", chỉ cần tải data
                            loadFundData(); // Tải Quỹ
                            renderCalendar(currentDate.getMonth(), currentDate.getFullYear()); // Vẽ lịch
                            window.calendarInitialized = true; // Đánh dấu đã tải
                        }
                        // === HẾT PHẦN THÊM ===

                    } else {
                        content.classList.add('opacity-0');
                        setTimeout(() => {
                            content.classList.add('hidden');
                        }, 400);
                    }
                    if (toolId === 'admin-panel' && window.isAdmin) {
                        initializeAdminPanelToggles();
                    }
                });
                if (!targetFound && navLinks.length > 0) {
                    const defaultToolId = navLinks[0].dataset.tool;
                    if (toolId !== defaultToolId) {
                        showTool(defaultToolId);
                    }
                }
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const toolId = link.dataset.tool;
                    history.pushState({ toolId: toolId }, '', `#${toolId}`);
                    showTool(toolId);
                });
            });
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.toolId) {
                    showTool(e.state.toolId);
                } else {
                    showTool(navLinks[0].dataset.tool);
                }
            });
            const initialToolId = window.location.hash.substring(1) || navLinks[0].dataset.tool;
            showTool(initialToolId);
            // --- BG Removal Logic (CŨ CỦA BA) ---
            const bgRemoveInput = document.getElementById('bg-remove-input');
            const bgRemoveFilename = document.getElementById('bg-remove-filename');
            const bgRemovePreviews = document.getElementById('bg-remove-previews');
            const bgRemoveOriginal = document.getElementById('bg-remove-original');
            const bgRemoveResult = document.getElementById('bg-remove-result');
            const bgRemoveLoader = document.getElementById('bg-remove-loader');
            const bgRemoveProcessBtn = document.getElementById('bg-remove-process-btn');
            const bgRemoveDownloadBtn = document.getElementById('bg-remove-download-btn');
            const bgRemoveStatus = document.getElementById('bg-remove-status');
            let resultBlob = null;
            if (bgRemoveInput) {
                bgRemoveInput.addEventListener('change', () => {
                    const file = bgRemoveInput.files[0];
                    if (file) {
                        bgRemoveFilename.textContent = file.name;
                        resultBlob = null;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            bgRemoveOriginal.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        bgRemovePreviews.classList.remove('hidden');
                        bgRemoveResult.classList.add('hidden');
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveDownloadBtn.disabled = true;
                        bgRemoveStatus.textContent = 'Sẵn sàng để tách nền.';
                        bgRemoveProcessBtn.disabled = false;
                    } else {
                        bgRemoveFilename.textContent = 'Chưa chọn tệp nào.';
                    }
                });
                bgRemoveProcessBtn.addEventListener('click', async () => {
                    const file = bgRemoveInput.files[0];
                    if (!file) return;
                    bgRemoveLoader.classList.remove('hidden');
                    bgRemoveResult.classList.add('hidden');
                    bgRemoveStatus.textContent = 'Đang tải ảnh lên và xử lý...';
                    bgRemoveProcessBtn.disabled = true;
                    bgRemoveDownloadBtn.disabled = true;
                    const formData = new FormData();
                    formData.append('image_file', file);
                    try {
                        const response = await fetch('/api/photoroom', {
                            method: 'POST',
                            body: formData,
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `Lỗi HTTP: ${response.status}`);
                        }
                        resultBlob = await response.blob();
                        const url = URL.createObjectURL(resultBlob);
                        bgRemoveResult.src = url;
                        bgRemoveResult.classList.remove('hidden');
                        bgRemoveStatus.textContent = 'Tách nền thành công!';
                        bgRemoveDownloadBtn.disabled = false;
                    } catch (error) {
                        console.error("Photoroom API error:", error);
                        bgRemoveStatus.textContent = `Lỗi: ${error.message}`;
                    } finally {
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveProcessBtn.disabled = false;
                    }
                });
                bgRemoveDownloadBtn.addEventListener('click', () => {
                    if (resultBlob) {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(resultBlob);
                        const originalFileName = bgRemoveInput.files[0].name.split('.').slice(0, -1).join('.');
                        link.download = `${originalFileName}-removed-bg.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
            }
            // --- PNG to ICO Logic (CŨ CỦA BA) ---
            const pngFileInput = document.getElementById('png-file-input');
            const pngFilename = document.getElementById('png-filename');
            const convertBtn = document.getElementById('convert-to-ico-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const icoStatus = document.getElementById('ico-status');
            const icoSizeSelect = document.getElementById('ico-size-select');
            if (pngFileInput) {
                pngFileInput.addEventListener('change', () => {
                    const file = pngFileInput.files[0];
                    if (file) {
                        pngFilename.textContent = file.name;
                        convertBtn.disabled = false;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        pngFilename.textContent = 'Chưa chọn tệp nào.';
                        convertBtn.disabled = true;
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
                convertBtn.addEventListener('click', () => {
                    const file = pngFileInput.files[0];
                    if (!file) return;
                    const size = parseInt(icoSizeSelect.value, 10);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            const icoData = createIco(ctx, size);
                            const blob = new Blob([icoData], { type: 'image/x-icon' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'favicon.ico';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            icoStatus.textContent = `Tệp favicon.ico (${size}x${size}) đã được tải xuống!`;
                            setTimeout(() => { icoStatus.textContent = '' }, 3000);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                function createIco(ctx, size) {
                    const imageData = ctx.getImageData(0, 0, size, size).data;
                    const buffer = new ArrayBuffer(22 + 40 + (size * size * 4));
                    const view = new DataView(buffer);
                    view.setUint16(0, 0, true); view.setUint16(2, 1, true); view.setUint16(4, 1, true);
                    view.setUint8(6, size); view.setUint8(7, size); view.setUint8(8, 0); view.setUint8(9, 0);
                    view.setUint16(10, 1, true); view.setUint16(12, 32, true);
                    view.setUint32(14, 40 + (size * size * 4), true); view.setUint32(18, 22, true);
                    let offset = 22;
                    view.setUint32(offset, 40, true); offset += 4;
                    view.setUint32(offset, size, true); offset += 4;
                    view.setUint32(offset, size * 2, true); offset += 4;
                    view.setUint16(offset, 1, true); offset += 2;
                    view.setUint16(offset, 32, true); offset += 2;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, size * size * 4, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    for (let y = size - 1; y >= 0; y--) {
                        for (let x = 0; x < size; x++) {
                            const i = (y * size + x) * 4;
                            view.setUint8(offset++, imageData[i + 2]); view.setUint8(offset++, imageData[i + 1]);
                            view.setUint8(offset++, imageData[i]); view.setUint8(offset++, imageData[i + 3]);
                        }
                    }
                    return new Uint8Array(buffer);
                }
            }
            // --- Base64 Logic (CŨ CỦA BA) ---
            const base64Input = document.getElementById('base64-input');
            const base64Output = document.getElementById('base64-output');
            const encodeBtn = document.getElementById('base64-encode-btn');
            const decodeBtn = document.getElementById('base64-decode-btn');
            const base64Status = document.getElementById('base64-status');
            if (base64Input) {
                function safeBtoa(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch (e) { return null; } }
                function safeAtob(str) { try { return decodeURIComponent(escape(atob(str))); } catch (e) { return null; } }
                encodeBtn.addEventListener('click', () => {
                    const input = base64Input.value;
                    if (!input) { base64Output.value = ''; return; }
                    const encoded = safeBtoa(input);
                    base64Output.value = encoded ? encoded : 'Lỗi: Dữ liệu đầu vào không hợp lệ.';
                    base64Status.textContent = encoded ? 'Mã hóa thành công!' : 'Mã hóa thất bại.';
                    setTimeout(() => { base64Status.textContent = '' }, 3000);
                });
                decodeBtn.addEventListener('click', () => {
                    let currentString = base64Input.value;
                    if (!currentString) { base64Output.value = ''; return; }
                    let decodeCount = 0;
                    let lastValidString = currentString;
                    while (true) {
                        const decoded = safeAtob(currentString);
                        if (decoded !== null && decoded !== currentString) {
                            currentString = decoded;
                            lastValidString = decoded;
                            decodeCount++;
                        } else { break; }
                    }
                    base64Output.value = lastValidString;
                    base64Status.textContent = decodeCount > 0 ? `Giải mã thành công qua ${decodeCount} lớp.` : 'Không thể giải mã thêm, chuỗi không phải là Base64 hợp lệ.';
                    setTimeout(() => { base64Status.textContent = '' }, 4000);
                });
            }
            // --- My Apps Logic (CŨ CỦA BA) ---
            const appsListContainer = document.getElementById('apps-list');
            const appsLoader = document.getElementById('apps-loader');
            const appsEmptyState = document.getElementById('apps-empty-state');
            if (appsListContainer) {
                db.collection("my_apps").onSnapshot((querySnapshot) => {
                    appsLoader.classList.add('hidden');
                    const appCards = appsListContainer.querySelectorAll('.app-card');
                    appCards.forEach(card => card.remove());
                    if (querySnapshot.empty) {
                        appsEmptyState.classList.remove('hidden');
                    } else {
                        appsEmptyState.classList.add('hidden');
                        querySnapshot.forEach((doc) => {
                            const app = doc.data();
                            const appId = doc.id;
                            let iconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`;
                            if (app.iconUrl && app.iconUrl.trim() !== '') {
                                iconHTML = `<img src="${app.iconUrl}" class="h-full w-full object-contain" alt="${app.appName || 'App'} icon">`;
                            }
                            const appCardHTML = `
<div class="app-card glass-effect p-6 rounded-xl shadow-md transition-all duration-300 flex flex-col sm:flex-row items-start sm:items-center gap-6">
<div class="flex-shrink-0 w-32 h-32 bg-white/70 dark:bg-white/10 rounded-lg flex items-center justify-center overflow-hidden">
${iconHTML}
</div>
<div class="flex-grow">
<h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${app.appName || 'Không có tên'}</h3>
<p class="text-gray-600 dark:text-gray-200 mt-1">${app.description || 'Không có mô tả.'}</p>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
<span>Số lượt tải: </span>
<span class="font-semibold" id="count-${appId}">${app.downloadCount || 0}</span>
</div>
</div>
<div class="w-full sm:w-auto flex-shrink-0">
<button class="download-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 flex items-center justify-center gap-2" data-doc-id="${appId}" data-url="${app.downloadUrl || '#'}">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
<span>Tải về</span>
</button>
</div>
</div>`;
                            appsListContainer.insertAdjacentHTML('beforeend', appCardHTML);
                        });
                    }
                }, (error) => {
                    console.error("Error getting documents: ", error);
                    appsLoader.classList.add('hidden');
                    appsListContainer.innerHTML = '<p class="text-center text-red-500">Đã xảy ra lỗi khi tải danh sách ứng dụng.</p>';
                });
                appsListContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.download-btn');
                    if (button) {
                        const docId = button.dataset.docId;
                        const url = button.dataset.url;
                        if (!docId || url === '#') {
                            console.error('Lỗi: Không tìm thấy đường link tải về cho ứng dụng này.');
                            return;
                        }
                        const appRef = db.collection('my_apps').doc(docId);
                        appRef.update({
                            downloadCount: firebase.firestore.FieldValue.increment(1)
                        }).then(() => {
                            console.log("Download count updated!");
                            window.open(url, '_blank');
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                            window.open(url, '_blank');
                        });
                    }
                });
            }
            // === MỠ GẮN DÂY ĐIỆN CHO CÁC NÚT CHUNG (BLOG) ===

            // 1. Nút Phân Trang (Pagination)
            if (blogPrevBtn) {
                blogPrevBtn.addEventListener('click', () => {
                    if (blogCurrentPage > 1) {
                        blogCurrentPage--;
                        fetchBlogPage();
                    }
                });
            }
            if (blogNextBtn) {
                blogNextBtn.addEventListener('click', () => {
                    if (blogCurrentPage < blogTotalPages) {
                        blogCurrentPage++;
                        fetchBlogPage();
                    }
                });
            }

            // 2. Nút trong Editor (Lưu / Hủy)
            if (blogEditorSaveBtn) {
                blogEditorSaveBtn.addEventListener('click', saveBlogPost);
            }
            if (blogEditorCancelBtn) {
                blogEditorCancelBtn.addEventListener('click', () => {
                    blogEditorModal.classList.add('hidden');
                    if (tinymce.get('blog-editor-textarea')) {
                        tinymce.get('blog-editor-textarea').destroy();
                    }
                });
            }



        }); // Hết DOMContentLoaded
    </script>
    <script>
        let daPhatNhacLanDau = false;
        document.addEventListener('click', function () {
            if (!daPhatNhacLanDau) {
                let fileNhac = document.getElementById('nhac-nen-cua-ba');
                if (fileNhac) {
                    fileNhac.volume = 0.15;
                    fileNhac.play().catch(error => {
                        console.log("Trình duyệt chặn tự động phát nhạc:", error);
                    });
                    daPhatNhacLanDau = true;
                }
            }
        });
    </script>
</body>

</html>