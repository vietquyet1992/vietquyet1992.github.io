<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVQ's World</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5/dist/autoNumeric.min.js"></script>
    <script src="tinymce/tinymce.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=4.0">
    <script>
        if (localStorage.theme === 'dark' || !('theme' in localStorage)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body class="text-black dark:text-gray-100 min-h-screen">
    <audio id="nhac-nen-cua-ba" src="assets/am-thanh.mp3" loop></audio>
    <div class="lg:flex">
        <aside class="lg:w-64 w-full lg:min-h-screen p-4 flex flex-col glass-effect">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400">My Toolbox</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">C√¥ng c·ª• & ·ª®ng d·ª•ng</p>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="nav-link active group flex items-center px-4 py-3 rounded-lg transition-all duration-200 
text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="remove-bg">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5.5 2a3.5 3.5 0 013.163 5.002L13 11.172V15a1 1 0 01-1 1H6a1 1 0 01-1-1v-3.828l4.337-4.17A3.5 3.5 0 115.5 2zM4.5 3.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" />
                        <path
                            d="M11.94 11.513l-1.34-1.29a.75.75 0 00-1.06 1.06l1.5 1.44a.75.75 0 001.12-.001l3.5-3.719a.75.75 0 00-1.08-1.04l-2.64 2.79z" />
                    </svg>
                    <span class="font-medium">T√°ch n·ªÅn ·∫£nh</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="png-to-ico">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">PNG to ICO</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="base64">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 3a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1h2a1 1 0 011 1v1h4V6a1 1 0 011-1h2a1 1 0 011 1v1z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Base64 Multi-layer</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-apps">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span class="font-medium">My Apps</span>
                </a>
                <a href="#" id="nav-my-diary"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-diary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" />
                    </svg>
                    <span class="font-medium">My Diary</span>
                </a>
                <a href="#" id="nav-my-research"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-research">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V2.75A.75.75 0 0110 2zM8.5 4.5A.75.75 0 007.75 5.25v1.25a.75.75 0 001.5 0V5.25A.75.75 0 008.5 4.5zM12.25 5.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0V5.25zM10 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V10.75A.75.75 0 0110 10zM8.5 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM12.25 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM5.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75V10.75A.75.75 0 015.5 10zM4 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM6.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM14.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H14.5a.75.75 0 01-.75-.75V10.75A.75.75 0 0114.5 10zM13 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM15.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">My Blog</span>
                </a>
                <a href="#" id="nav-badminton-scheduler"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="badminton-scheduler">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">B Scheduler</span>
                </a>

                <a href="#" id="nav-admin-panel"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="admin-panel">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Admin Panel</span>
                </a>

            </nav>
            <div class="mt-auto">
                <div class="p-4">
                    <button id="theme-toggle"
                        class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div id="guest-view" class="text-center pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                    <p id="admin-login-btn"
                        class="text-base text-gray-500 dark:text-gray-400 cursor-pointer hover:text-amber-500 dark:hover:text-amber-400 transition-colors">
                        &copy; 2025 Ti√™u Vi·∫øt Quy·∫øt
                    </p>
                </div>
                <div id="admin-view" class="p-4 border-t border-gray-300/50 dark:border-gray-600/50"
                    style="display: none;">
                    <div class="flex items-center space-x-3">
                        <img id="admin-avatar" src="images/favicon.png" alt="Avatar"
                            class="h-10 w-10 rounded-full border-2 border-amber-500 object-cover">
                        <div class="flex-1">
                            <p id="admin-name" class="font-semibold text-sm text-gray-800 dark:text-gray-100">Ch√†o ba!
                            </p>
                            <a href="#" id="admin-logout-btn"
                                class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">ƒêƒÉng
                                xu·∫•t</a>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto min-h-screen">
            <div id="tool-remove-bg" class="tool-content">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">T√°ch n·ªÅn ·∫£nh</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">T·∫£i l√™n m·ªôt h√¨nh ·∫£nh ƒë·ªÉ t·ª± ƒë·ªông x√≥a n·ªÅn b·∫±ng API
                        c·ªßa Photoroom.</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="bg-remove-input"
                                class="cursor-pointer bg-gray-300 text-gray-700 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Ch·ªçn t·ªáp...
                            </label>
                            <span id="bg-remove-filename" class="text-sm text-gray-500 dark:text-gray-300">Ch∆∞a ch·ªçn t·ªáp
                                n√†o.</span>
                            <input type="file" id="bg-remove-input" accept="image/png, image/jpeg" class="hidden" />
                        </div>
                        <div id="bg-remove-previews" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">·∫¢nh g·ªëc:</p>
                                <img id="bg-remove-original"
                                    class="w-full rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">ƒê√£ t√°ch n·ªÅn:</p>
                                <div class="w-full aspect-video rounded-lg border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center bg-gray-100/50 dark:bg-gray-700/50"
                                    style="background-image: repeating-conic-gradient(#d1d5db80 0 25%, #e5e7eb80 0 50%); background-size: 16px 16px;">
                                    <img id="bg-remove-result" class="hidden max-w-full max-h-full" />
                                    <div id="bg-remove-loader" class="loader hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button id="bg-remove-process-btn"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>T√°ch n·ªÅn</button>
                            <button id="bg-remove-download-btn"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>T·∫£i xu·ªëng k·∫øt qu·∫£</button>
                        </div>
                        <div id="bg-remove-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5"></div>
                    </div>
                </div>
            </div>
            <div id="tool-png-to-ico" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Chuy·ªÉn ƒë·ªïi PNG sang ICO</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">T·∫£i l√™n t·ªáp PNG v√† ch·ªçn k√≠ch th∆∞·ªõc ƒë·ªÉ t·∫°o t·ªáp ICO
                        (bi·ªÉu t∆∞·ª£ng trang web).</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="png-file-input"
                                class="cursor-pointer bg-gray-300 text-gray-500 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Ch·ªçn t·ªáp...
                            </label>
                            <span id="png-filename" class="text-sm text-gray-500 dark:text-gray-300">Ch∆∞a ch·ªçn t·ªáp
                                n√†o.</span>
                            <input type="file" id="png-file-input" accept="image/png" class="hidden" />
                        </div>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium mb-2 dark:text-gray-300">·∫¢nh xem tr∆∞·ªõc:</p>
                            <img id="image-preview"
                                class="max-w-xs max-h-32 rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                        </div>
                        <div>
                            <label for="ico-size-select" class="block font-medium mb-2 dark:text-gray-300">Ch·ªçn k√≠ch
                                th∆∞·ªõc:</label>
                            <select id="ico-size-select"
                                class="w-full sm:w-auto p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                                <option value="16">16x16 pixels</option>
                                <option value="32" selected>32x32 pixels</option>
                                <option value="48">48x48 pixels</option>
                                <option value="64">64x64 pixels</option>
                                <option value="128">128x128 pixels</option>
                            </select>
                        </div>
                        <button id="convert-to-ico-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 
disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none 
dark:disabled:bg-gray-600/50 dark:disabled:text-gray-400 
shadow-lg hover:shadow-amber-500/40" disabled>Chuy·ªÉn ƒë·ªïi & T·∫£i xu·ªëng</button>
                        <div id="ico-status" class="text-sm text-green-600 dark:text-green-400 mt-2"></div>
                    </div>
                </div>
            </div>
            <div id="tool-base64" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">M√£ h√≥a & Gi·∫£i m√£ Base64</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">M√£ h√≥a (1 l·∫ßn) ho·∫∑c gi·∫£i m√£ (nhi·ªÅu l·ªõp) chu·ªói vƒÉn
                        b·∫£n c·ªßa b·∫°n.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="base64-input" class="font-medium dark:text-gray-300">ƒê·∫ßu v√†o:</label>
                            <textarea id="base64-input" rows="8"
                                class="w-full p-3 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="base64-output" class="font-medium dark:text-gray-300">K·∫øt qu·∫£:</label>
                            <textarea id="base64-output" rows="8" readonly
                                class="w-full p-3 bg-gray-100/50 dark:bg-slate-800/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg cursor-not-allowed"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="base64-encode-btn"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">M√£
                            h√≥a (Encode)</button>
                        <button id="base64-decode-btn"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-blue-500/50">Gi·∫£i
                            m√£ (Decode)</button>
                    </div>
                    <div id="base64-status" class="text-sm mt-4"></div>
                </div>
            </div>
            <div id="tool-my-apps" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">·ª®ng d·ª•ng c·ªßa t√¥i</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">T·ªïng h·ª£p c√°c ·ª©ng d·ª•ng Windows do t√¥i ph√°t tri·ªÉn.
                        Nh·∫•n ƒë·ªÉ t·∫£i v·ªÅ v√† tr·∫£i nghi·ªám!</p>
                    <div id="apps-list" class="space-y-6">
                        <div id="apps-loader" class="flex justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <p id="apps-empty-state" class="text-center text-gray-500 py-8 hidden">Ch∆∞a c√≥ ·ª©ng d·ª•ng n√†o ƒë∆∞·ª£c
                            th√™m.</p>
                    </div>
                </div>
            </div>
            <div id="tool-my-diary" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">My Diary</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">ƒê√¢y l√† khu v·ª±c nh·∫≠t k√Ω c·ªßa ba...</p>
                </div>
            </div>
            <div id="tool-my-research" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">M·ªôt v√†i b√†i vi·∫øt do ch·ª©c nƒÉng
                        Deep Research c·ªßa Gemini t·∫°o ra!</h2>
                    <div id="blog-admin-controls" class="hidden">
                        <button id="blog-create-new-btn"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/40 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>T·∫°o b√†i vi·∫øt m·ªõi</span>
                        </button>
                    </div>
                    <div id="blog-posts-list" class="space-y-6">
                        <p id="blog-loading-state" class="text-center text-gray-500 py-8">ƒêang
                            t·∫£i b√†i vi·∫øt...</p>
                        <p id="blog-empty-state" class="text-center text-gray-500 py-8 hidden">
                            Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>
                    </div>

                    <div id="blog-pagination-controls" class="hidden flex items-center justify-between mt-8">
                        <button id="blog-prev-btn"
                            class="bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            &larr; Trang tr∆∞·ªõc
                        </button>
                        <span id="blog-page-indicator" class="font-semibold text-gray-700 dark:text-gray-300">Trang 1 /
                            1</span>
                        <button id="blog-next-btn"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 disabled:opacity-50 disabled:cursor-not-allowed">
                            Trang sau &rarr;
                        </button>
                    </div>

                </div>
            </div>
            <div id="tool-badminton-scheduler" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Badminton Scheduler</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">T·ªïng ti·ªÅn ƒë√£
                                n·ªôp:</label>
                            <p id="badminton-total-deposited"
                                class="text-2xl font-bold text-green-600 dark:text-green-400">0 ƒë</p>
                            <div class="mt-4 flex gap-2">
                                <input type="text" id="badminton-add-deposit" placeholder="N·ªôp th√™m..."
                                    class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" />
                                <button id="badminton-submit-deposit"
                                    class="p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-all shadow-lg hover:shadow-green-500/50">
                                    [+]
                                </button>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">T·ªïng s·ªë ng√†y
                                ƒëi:</label>
                            <p id="badminton-total-days" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0
                                ng√†y</p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">T·ªïng s·ªë ti·ªÅn s√¢n
                                (th√°ng n√†y):</label>
                            <p id="badminton-total-cost" class="text-2xl font-bold text-red-500 dark:text-red-400">0 ƒë
                            </p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">S·ªë ti·ªÅn c√≤n
                                l·∫°i:</label>
                            <p id="badminton-remaining-balance"
                                class="text-2xl font-bold text-amber-600 dark:text-amber-400">0 ƒë</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <button id="calendar-prev-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <h3 id="calendar-month-year"
                                class="text-xl font-bold text-center text-amber-600 dark:text-amber-400">Th√°ng 11 / 2025
                            </h3>
                            <button id="calendar-next-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 dark:text-gray-400">
                            <div class="calendar-header">Th·ª© 2</div>
                            <div class="calendar-header">Th·ª© 3</div>
                            <div class="calendar-header">Th·ª© 4</div>
                            <div class="calendar-header">Th·ª© 5</div>
                            <div class="calendar-header">Th·ª© 6</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Th·ª© 7</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Ch·ªß Nh·∫≠t</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tool-admin-panel" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">C√†i ƒë·∫∑t Hi·ªÉn th·ªã</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Ch·ªçn nh·ªØng tab m√† <span
                            class="font-bold text-red-500">Kh√°ch (Guest)</span> c√≥ th·ªÉ th·∫•y.</p>

                    <div class="space-y-4 max-w-md">
                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-diary" class="font-medium text-gray-700 dark:text-gray-200">Hi·ªán "My
                                Diary"</label>
                            <input type="checkbox" id="toggle-diary"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-research" class="font-medium text-gray-700 dark:text-gray-200">Hi·ªán
                                "My Blog"</label>
                            <input type="checkbox" id="toggle-research"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-badminton" class="font-medium text-gray-700 dark:text-gray-200">Hi·ªán
                                "B Scheduler"</label>
                            <input type="checkbox" id="toggle-badminton"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>
                    </div>
                </div>
        </main>
    </div>

    </div>
    </main>
    </div>
    <footer class="text-center py-4 mt-8 relative">
        <p class="text-base text-gray-500 dark:text-gray-400">
            Th·ªùi ƒë·∫°i AI ƒëang ƒë·∫øn!!!! <br>
            T·∫•t c·∫£ m·ªçi th·ª© ·ªü ƒë√¢y ƒë·ªÅu ƒë∆∞·ª£c t·∫°o b·∫±ng Gemini.
        </p>
        <div class="absolute right-4 bottom-4 hidden sm:block">
            <p id="visit-counter" class="text-xs text-gray-400 dark:text-gray-500 text-right">
                L∆∞·ª£t truy c·∫≠p: ƒêang t·∫£i...
            </p>
        </div>
    </footer>
    <div id="role-selection-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-sm glass-effect">
            <h3 class="text-3xl font-extrabold text-center mb-6 text-pink-600 dark:text-pink-400">TR·ªúI ∆†I, B·∫†N T·ªöI R·ªíI!
                üéâ</h3>
            <p class="text-center mb-8 text-gray-100 dark:text-gray-100">B·∫°n l√† fan Manchester United hay fan ƒë·ªôi kh√°c
                Fan ƒë·ªôi kh√°c?</p>
            <div class="flex flex-col space-y-4">
                <button id="select-role-admin"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40">
                    Manchester United
                </button>
                <button id="select-role-guest"
                    class="w-full bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg transition duration-300">
                    Fan ƒë·ªôi kh√°c???
                </button>
            </div>
        </div>
    </div>
    <div id="blog-editor-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
        <div class="w-full max-w-4xl max-h-[90vh] flex flex-col bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-amber-600 dark:text-amber-400">So·∫°n th·∫£o b√†i vi·∫øt</h3>
            <div class="space-y-4 overflow-y-auto pr-2">
                <div>
                    <label for="blog-editor-title" class="block font-medium mb-1 dark:text-gray-300">Ti√™u ƒë·ªÅ:</label>
                    <input type="text" id="blog-editor-title"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                </div>
                <div>
                    <label for="blog-editor-tags" class="block font-medium mb-1 dark:text-gray-300">Hashtags:</label>
                    <input type="text" id="blog-editor-tags" placeholder="V√≠ d·ª•: excel, vba, ai"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">C√°ch nhau b·∫±ng d·∫•u ph·∫©y (,)</p>
                </div>
                <div>
                    <label class="block font-medium mb-1 dark:text-gray-300">N·ªôi dung:</label>
                    <textarea id="blog-editor-textarea"></textarea>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                <button id="blog-editor-save-btn"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">L∆∞u
                    b√†i vi·∫øt</button>
                <button id="blog-editor-cancel-btn"
                    class="flex-1 bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">H·ªßy</button>
                <input type="hidden" id="blog-editor-post-id">
            </div>
        </div>
    </div>
    <div id="blog-reader-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 hidden p-4">
        <div id="blog-reader-content"
            class="w-11/12 h-[90vh] flex flex-col bg-white dark:bg-slate-800 rounded-lg shadow-2xl overflow-hidden">
            <header class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700 overflow-y-auto">
                <h2 id="blog-reader-title" class="text-3xl font-bold text-amber-600 dark:text-amber-400">
                    ƒê√¢y l√† Ti√™u ƒë·ªÅ B√†i vi·∫øt
                </h2>
                <div id="blog-reader-tags" class="flex flex-wrap gap-2 mt-4">
                </div>
            </header>
            <article class="flex-1 p-6 overflow-y-auto">
                <div id="blog-reader-body" class="prose dark:prose-invert max-w-none">
                </div>
            </article>
            <footer
                class="flex-shrink-0 p-4 bg-gray-50 dark:bg-slate-900 border-t border-gray-200 dark:border-gray-700">
                <button id="blog-reader-close-btn"
                    class="w-full sm:w-auto bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-8 rounded-lg transition duration-300">
                    ƒê√≥ng
                </button>
            </footer>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Initialization (C≈® C·ª¶A BA) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCG_OqnwjNTg3kfCUmEkxo-qrJTMMsyhqk",
                authDomain: "my-toolbox-downloads.firebaseapp.com",
                projectId: "my-toolbox-downloads",
                storageBucket: "my-toolbox-downloads.appspot.com",
                messagingSenderId: "723884147235",
                appId: "1:723884147235:web:d08241abfd477d91c2e796"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            let globalTabSettings = { show_diary: false, show_research: false, show_badminton: false };
            const settingsRef = db.collection("settings").doc("tab_visibility");

            const storage = firebase.storage();
            // === CODE AUTH C·ª¶A M·ª† (B·∫¢O M·∫¨T + S·ª¨A L·ªñI) ===
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); // <<< D√íNG M·ª† TH√äM V√ÄO ƒê√ÇY
            const modal = document.getElementById('role-selection-modal');
            const selectGuestBtn = document.getElementById('select-role-guest');
            const selectAdminBtn = document.getElementById('select-role-admin');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            // (T·ª± ƒë·ªông l·∫Øng nghe thay ƒë·ªïi t·ª´ Firestore)
            settingsRef.onSnapshot((doc) => {
                if (doc.exists) {
                    globalTabSettings = doc.data();
                } else {
                    // N·∫øu ch∆∞a c√≥, t·ª± t·∫°o file c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh (·∫©n h·∫øt)
                    settingsRef.set(globalTabSettings).catch(e => console.error("L·ªói t·∫°o settings:", e));
                }
                console.log("C√†i ƒë·∫∑t tab ƒë√£ c·∫≠p nh·∫≠t:", globalTabSettings);

                // Ch·∫°y l·∫°i h√†m updateUI ƒë·ªÉ √°p d·ª•ng c√†i ƒë·∫∑t m·ªõi cho Guest
                const user = auth.currentUser;
                checkAdminStatus(user);
            }, (error) => {
                console.error("L·ªói t·∫£i c√†i ƒë·∫∑t tab:", error);
            });
            // === H√ÄM "SI√äU TR√ÇU B√í" (style.display) + N√ÇNG C·∫§P AUTONUMERIC + B·∫¢O M·∫¨T ===
            // === H√ÄM "SI√äU TR√ÇU B√í" (style.display) + N√ÇNG C·∫§P AUTONUMERIC + B·∫¢O M·∫¨T ===
            // === H√ÄM M·ªöI: CHUY√äN GIA KH√ìA/M·ªû L·ªäCH ===
            function setCalendarInputsReadOnly(isReadOnly) {
                // 1. Kh√≥a/M·ªü c√°c √¥ g√µ ti·ªÅn
                const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                inputs.forEach(input => {
                    if (input.autoNumericInstance) {
                        input.autoNumericInstance.options.readOnly(isReadOnly);
                    } else {
                        input.readOnly = isReadOnly;
                    }
                });

                // 2. Kh√≥a/M·ªü c√°c n√∫t '‚óè'
                const toggles = calendarGrid.querySelectorAll('.day-toggle');
                toggles.forEach(toggle => {
                    toggle.disabled = isReadOnly;
                });
            }

            // === H√ÄM "SI√äU TR√ÇU B√í" (style.display) + N√ÇNG C·∫§P AUTONUMERIC + B·∫¢O M·∫¨T ===
            function updateUI(user, isAdmin) {
                // === M·ª† B·ªî SUNG 1: ƒê·∫∑t "bi·ªÉn b√°o" Admin to√†n c·ª•c ===
                window.isAdmin = (user && isAdmin);
                // ===============================================
                const gView = document.getElementById('guest-view');
                const aView = document.getElementById('admin-view');
                const navD = document.getElementById('nav-my-diary');
                const navR = document.getElementById('nav-my-research');
                const navB = document.getElementById('nav-badminton-scheduler');
                const navAdmin = document.getElementById('nav-admin-panel');
                const addDepositInput = document.getElementById('badminton-add-deposit'); // L·∫•y √¥ N·ªôp ti·ªÅn
                const submitDepositBtn = document.getElementById('badminton-submit-deposit'); // <<< M·ª† L·∫§Y TH√äM N√öT

                // (B·∫£n v√° ƒë·∫ßy ƒë·ªß)
                if (!gView || !aView || !navD || !navR || !navB || !navAdmin || !addDepositInput || !submitDepositBtn) { // <<< M·ª† TH√äM N√öT V√ÄO CHECK
                    console.error("L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y 1 trong c√°c View UI!");
                    return;
                }

                // === M·ª† "T√ÅI C·∫§U TR√öC" H√ÄM N√ÄY ===

                // 1. Kh·ªüi t·∫°o AutoNumeric cho √¥ "N·ªôp th√™m" (1 L·∫¶N DUY NH·∫§T)
                // (H√†m n√†y s·∫Ω t·ª± ch·∫°y 1 l·∫ßn khi t·∫£i trang)
                if (addDepositInput && !addDepositInput.autoNumericInstance) {
                    const anInput = new AutoNumeric(addDepositInput, {
                        decimalCharacter: ',',
                        digitGroupSeparator: '.',
                        decimalPlaces: 0,
                        minimumValue: '-999999999',
                        maximumValue: '999999999',
                        // Kh√¥ng set readOnly ·ªü ƒë√¢y, set ·ªü d∆∞·ªõi
                    });
                    addDepositInput.autoNumericInstance = anInput;
                }


                if (user && isAdmin) {
                    // 1. L√Ä ADMIN
                    gView.style.display = 'none';
                    aView.style.display = 'block';
                    navD.classList.remove('hidden');
                    navR.classList.remove('hidden');
                    navB.classList.remove('hidden');
                    navAdmin.classList.remove('hidden');
                    initializeAdminBlogFeatures();
                    setCalendarInputsReadOnly(false);

                    // 2. B·∫≠t √¥ n·ªôp ti·ªÅn
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(false); // <<< Cho ph√©p g√µ
                    }
                    addDepositInput.placeholder = 'N·ªôp th√™m...';
                    submitDepositBtn.disabled = false; // <<< B·∫≠t n√∫t [+]

                    // 3. T·∫£i l·ªãch (n·∫øu ch∆∞a)
                    // (Code n√†y ƒë√£ b·ªã chuy·ªÉn qua h√†m showTool, nh∆∞ng Admin v·∫´n c·∫ßn kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu)
                    if (!window.calendarInitialized) {
                        loadFundData();
                        renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                        window.calendarInitialized = true;
                    }

                    // 4. Set Avatar
                    const adminAvatar = document.getElementById('admin-avatar');
                    const adminName = document.getElementById('admin-name');
                    if (adminAvatar) adminAvatar.src = user.photoURL || 'images/favicon.png';
                    if (adminName) adminName.textContent = user.displayName || "Ch√†o Admin!";

                } else {
                    // 1. L√Ä GUEST
                    gView.style.display = 'block';
                    aView.style.display = 'none';
                    setCalendarInputsReadOnly(true); // <<< D√íNG M·ªöI (KH√ìA L·ªäCH)

                    // 2. T·∫Øt √¥ n·ªôp ti·ªÅn
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(true); // <<< Kh√≥a g√µ
                        addDepositInput.autoNumericInstance.clear(); // X√≥a s·ªë (n·∫øu l·ª° g√µ)
                    }
                    addDepositInput.placeholder = "Money doesn't grow on trees!"; // <<< ƒê·ªïi ch·ªØ
                    submitDepositBtn.disabled = true; // <<< T·∫Øt n√∫t [+]

                    // 3. ·∫®n/Hi·ªán Nav theo c√†i ƒë·∫∑t (Gi·ªØ nguy√™n)
                    navAdmin.classList.add('hidden');
                    if (globalTabSettings.show_diary) {
                        navD.classList.remove('hidden');
                    } else {
                        navD.classList.add('hidden');
                    }

                    if (globalTabSettings.show_research) {
                        navR.classList.remove('hidden');
                    } else {
                        navR.classList.add('hidden');
                    }

                    if (globalTabSettings.show_badminton) {
                        navB.classList.remove('hidden');
                    } else {
                        navB.classList.add('hidden');
                    }
                    if (user && !isAdmin) {
                        signOut();
                        alert("T√†i kho·∫£n n√†y kh√¥ng c√≥ quy·ªÅn Admin!");
                    }

                    // === S·ª¨A L·ªñI LOGIC "QU√âT PH√íNG" N·∫∞M ·ªû ƒê√ÇY ===

                    const currentHash = window.location.hash.substring(1);
                    const defaultTool = 'remove-bg'; // Trang an to√†n

                    // 1. T·∫°o 1 danh s√°ch c√°c trang B·ªä C·∫§M (t·ª©c l√† ƒëang ·∫®N)
                    let forbiddenTools = ['admin-panel']; // 'admin-panel' lu√¥n c·∫•m
                    if (!globalTabSettings.show_diary) {
                        forbiddenTools.push('my-diary');
                    }
                    if (!globalTabSettings.show_research) {
                        forbiddenTools.push('my-research');
                    }
                    if (!globalTabSettings.show_badminton) {
                        forbiddenTools.push('badminton-scheduler');
                    }

                    // 2. Ch·ªâ "ƒë√°" v·ªÅ trang ch·ªß N·∫æU user ƒëang ·ªü 1 trang B·ªä C·∫§M
                    if (forbiddenTools.includes(currentHash)) {
                        console.warn("User ƒëang ·ªü trang b·ªã c·∫•m (" + currentHash + "). ƒê√° v·ªÅ trang ch·ªß...");
                        // Chuy·ªÉn link v·ªÅ trang an to√†n
                        history.pushState({ toolId: defaultTool }, '', `#${defaultTool}`);
                        // G·ªçi h√†m showTool ƒë·ªÉ "v·∫Ω" l·∫°i trang an to√†n
                        showTool(defaultTool);
                    }
                    // === H·∫æT PH·∫¶N S·ª¨A L·ªñI ===
                }
            }


            // === TH√äM H√ÄM M·ªöI N√ÄY ===
            function initializeAdminPanelToggles() {
                // L·∫•y 3 c√°i n√∫t g·∫°t
                const toggleDiary = document.getElementById('toggle-diary');
                const toggleResearch = document.getElementById('toggle-research');
                const toggleBadminton = document.getElementById('toggle-badminton');

                // (Tho√°t n·∫øu l·ª° g·ªçi h√†m m√† ch∆∞a ·ªü ƒë√∫ng tab)
                if (!toggleDiary) return;

                console.log("Kh·ªüi t·∫°o Admin Panel Toggles...");

                // 1. ƒê·∫∑t tr·∫°ng th√°i 'checked' theo c√†i ƒë·∫∑t ƒë√£ t·∫£i
                toggleDiary.checked = globalTabSettings.show_diary;
                toggleResearch.checked = globalTabSettings.show_research;
                toggleBadminton.checked = globalTabSettings.show_badminton;

                // 2. G·∫Øn s·ª± ki·ªán 'change' ƒë·ªÉ l∆∞u l√™n Firestore
                // (D√πng .hasListener ƒë·ªÉ tr√°nh g·∫Øn 2-3 l·∫ßn)
                if (!toggleDiary.hasListener) {
                    toggleDiary.addEventListener('change', () => {
                        settingsRef.update({ show_diary: toggleDiary.checked })
                            .catch(e => alert("L·ªói c·∫≠p nh·∫≠t Diary: " + e.message));
                    });
                    toggleDiary.hasListener = true;
                }

                if (!toggleResearch.hasListener) {
                    toggleResearch.addEventListener('change', () => {
                        settingsRef.update({ show_research: toggleResearch.checked })
                            .catch(e => alert("L·ªói c·∫≠p nh·∫≠t Research: " + e.message));
                    });
                    toggleResearch.hasListener = true;
                }

                if (!toggleBadminton.hasListener) {
                    toggleBadminton.addEventListener('change', () => {
                        settingsRef.update({ show_badminton: toggleBadminton.checked })
                            .catch(e => alert("L·ªói c·∫≠p nh·∫≠t Badminton: " + e.message));
                    });
                    toggleBadminton.hasListener = true;
                }
            }
            // === H·∫æT H√ÄM M·ªöI ===
            // === H√ÄM CHECK ADMIN (H·ªéI FIRESTORE) ===
            async function checkAdminStatus(user) {
                if (!user) {
                    updateUI(null, false);
                    return;
                }
                try {
                    const adminDocRef = db.collection("admins").doc(user.email);
                    const adminDoc = await adminDocRef.get();
                    if (adminDoc.exists) {
                        console.log("Admin ƒë√£ ƒëƒÉng nh·∫≠p:", user.email);
                        updateUI(user, true);
                    } else {
                        console.log("User l·∫° ƒëƒÉng nh·∫≠p, kh√¥ng c√≥ quy·ªÅn:", user.email);
                        updateUI(user, false);
                    }
                } catch (error) {
                    console.error("L·ªói khi check admin:", error);
                    updateUI(user, false);
                }
            }
            // === C√ÅC H√ÄM X·ª¨ L√ù AUTH (GI·ªÆ NGUY√äN) ===
            auth.onAuthStateChanged((user) => {
                const role = localStorage.getItem('userRole');
                if (user) {
                    checkAdminStatus(user);
                } else {
                    updateUI(null, false);
                    if (!role) {
                        modal.classList.add('show');
                    }
                }
            });
            function signInWithGoogle() {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        localStorage.setItem('userRole', 'admin');
                    })
                    .catch((error) => {
                        console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
                        if (error.code === 'auth/popup-blocked-by-browser') {
                            alert("Tr√¨nh duy·ªát ƒë√£ ch·∫∑n c·ª≠a s·ªï ƒëƒÉng nh·∫≠p. Ba vui l√≤ng cho ph√©p pop-up cho trang n√†y nha!");
                        } else if (error.code === 'auth/unauthorized-domain') {
                            alert("L·ªói: T√™n mi·ªÅn n√†y ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω v·ªõi Firebase!");
                        }
                    });
            }
            function signOut() {
                auth.signOut()
                    .then(() => {
                        console.log("ƒê√£ ƒëƒÉng xu·∫•t.");
                        localStorage.setItem('userRole', 'guest');
                    })
                    .catch((error) => {
                        console.error("L·ªói ƒëƒÉng xu·∫•t:", error);
                    });
            }
            // === G√ÅN S·ª∞ KI·ªÜN CHO C√ÅC N√öT AUTH ===
            selectGuestBtn.addEventListener('click', () => {
                localStorage.setItem('userRole', 'guest');
                modal.classList.remove('show');
            });
            selectAdminBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                signInWithGoogle();
            });
            adminLoginBtn.addEventListener('click', () => {
                signInWithGoogle();
            });
            adminLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut();
            });






            /* ============================================================
            === B·ªò N√ÉO BLOG "MY RESEARCH" (Gƒê 6 - "K·∫æ TO√ÅN" PRO) ===
            ===       (B·∫£n "T·ªîNG V·ªÜ SINH" - Fix m·ªçi l·ªói)               ===
            ============================================================
            */
            // --- 1. Khai b√°o bi·∫øn to√†n c·ª•c cho Blog ---
            const blogPostsRef = db.collection("blog_posts");
            // "S·ªî K·∫æ TO√ÅN" C·ª¶A BA CON M√åNH
            const blogMetadataRef = db.collection("blog_metadata").doc("stats");

            const blogAdminControls = document.getElementById('blog-admin-controls');
            const blogCreateNewBtn = document.getElementById('blog-create-new-btn');
            const blogPostsList = document.getElementById('blog-posts-list');
            const blogLoadingState = document.getElementById('blog-loading-state');
            const blogEmptyState = document.getElementById('blog-empty-state');
            const blogEditorModal = document.getElementById('blog-editor-modal');
            const blogEditorTitle = document.getElementById('blog-editor-title');
            const blogEditorTags = document.getElementById('blog-editor-tags');
            const blogEditorTextarea = document.getElementById('blog-editor-textarea');
            const blogEditorSaveBtn = document.getElementById('blog-editor-save-btn');
            const blogEditorCancelBtn = document.getElementById('blog-editor-cancel-btn');
            const blogEditorPostId = document.getElementById('blog-editor-post-id');
            // Bi·∫øn cho C·ª¨A S·ªî ƒê·ªåC (READER MODAL)
            const blogReaderModal = document.getElementById('blog-reader-modal');
            const blogReaderBody = document.getElementById('blog-reader-body');
            // === M·ª† TH√äM 3 "TAY" M·ªöI ===
            const blogReaderArticle = document.querySelector('#blog-reader-content article'); // "TAY" G·∫ÆN N√öT
            let stickyCloseButton = null; // "TAY" ƒêI·ªÄU KHI·ªÇN N√öT
            let blogObserver = null; // "M·∫ÆT TH·∫¶N"
            // === H·∫æT ===
            const blogReaderCloseBtn = document.getElementById('blog-reader-close-btn');
            let isBlogInitialized = false;
            // BI·∫æN TO√ÄN C·ª§C CHO PH√ÇN TRANG (PAGINATION)
            const blogPaginationControls = document.getElementById('blog-pagination-controls');
            const blogPrevBtn = document.getElementById('blog-prev-btn');
            const blogNextBtn = document.getElementById('blog-next-btn');
            const blogPageIndicator = document.getElementById('blog-page-indicator');
            let blogPageSize = 5; // Ba mu·ªën 5 hay 10 th√¨ s·ª≠a s·ªë n√†y
            let blogCurrentPage = 1;
            let blogTotalPages = 1;
            let blogTotalPosts = 0;
            let blogPageMocks = [null]; // M·∫£ng "m·ªëc" (d·∫•u trang)
            let isLoadingBlog = false;
            // === "B·ªò N√ÉO M√ÄU" C·ª¶A M·ª† (D√ôNG CHO HASHTAG) ===
            // 1. "B·∫£ng M√†u" 10 m√†u (Ba ∆∞ng m√†u n√†o th√¨ s·ª≠a code Tailwind ·ªü ƒë√¢y)
            // 1. "B·∫£ng M√†u" 10 m√†u (Ba ∆∞ng m√†u n√†o th√¨ s·ª≠a code Tailwind ·ªü ƒë√¢y)
            // 1. "B·∫£ng M√†u" 10 m√†u (Ba ∆∞ng m√†u n√†o th√¨ s·ª≠a code Tailwind ·ªü ƒë√¢y)
            // 1. "B·∫£ng M√†u" 10 m√†u (Ba ∆∞ng m√†u n√†o th√¨ s·ª≠a code Tailwind ·ªü ƒë√¢y)
            const tagColorPalette = [
                // [N·ªÅn S√°ng, Ch·ªØ S√°ng], [N·ªÅn T·ªëi (700), Ch·ªØ T·ªëi (200)] - ƒê√É S·ª¨A D·ªäU M·∫ÆT
                ['bg-red-200', 'text-red-900', 'dark:bg-red-700', 'dark:text-red-200'],
                ['bg-amber-200', 'text-amber-900', 'dark:bg-amber-700', 'dark:text-amber-200'],
                ['bg-green-200', 'text-green-900', 'dark:bg-green-700', 'dark:text-green-200'],
                ['bg-blue-200', 'text-blue-900', 'dark:bg-blue-700', 'dark:text-blue-200'],
                ['bg-indigo-200', 'text-indigo-900', 'dark:bg-indigo-700', 'dark:text-indigo-200'],
                ['bg-purple-200', 'text-purple-900', 'dark:bg-purple-700', 'dark:text-purple-200'],
                ['bg-pink-200', 'text-pink-900', 'dark:bg-pink-700', 'dark:text-pink-200'],
                ['bg-sky-200', 'text-sky-900', 'dark:bg-sky-700', 'dark:text-sky-200'],
                ['bg-teal-200', 'text-teal-900', 'dark:bg-teal-700', 'dark:text-teal-200'],
                ['bg-orange-200', 'text-orange-900', 'dark:bg-orange-700', 'dark:text-orange-200']
            ];
            // 2. "B·ªô n√£o" "bƒÉm" ch·ªØ th√†nh s·ªë (ƒë·ªÉ b·ªëc m√†u)
            function getStringHash(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash); // Tr·∫£ v·ªÅ s·ªë d∆∞∆°ng
            }
            // 3. H√†m "b·ªëc" m√†u (tr·∫£ v·ªÅ 4 class)
            function getTagColorClasses(tagName) {
                const hash = getStringHash(tagName);
                const index = hash % tagColorPalette.length; // L·∫•y s·ªë d∆∞ (0-9)
                const colors = tagColorPalette[index];
                return `${colors[0]} ${colors[1]} ${colors[2]} ${colors[3]}`; // Tr·∫£ v·ªÅ 4 class, v√≠ d·ª•: "bg-red-200 text-red-900 dark:bg-red-700 dark:text-red-100"
            }
            // === H·∫æT "B·ªò N√ÉO M√ÄU" ===

            // --- H√ÄM "ƒê·∫¶U T√ÄU": L·∫¨T "S·ªî K·∫æ TO√ÅN" (H·∫æT L·ªñI .count()) ---
            async function loadBlogPosts() {
                if (isLoadingBlog) return;
                isLoadingBlog = true;
                blogLoadingState.classList.remove('hidden');
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    // 1. L·∫≠t "S·ªï K·∫ø to√°n"
                    const metaDoc = await blogMetadataRef.get();
                    if (metaDoc.exists) {
                        blogTotalPosts = metaDoc.data().totalPosts || 0;
                    } else {
                        blogTotalPosts = 0; // N·∫øu s·ªï kh√¥ng c√≥, coi nh∆∞ l√† 0
                    }

                    if (blogTotalPosts === 0) {
                        blogLoadingState.classList.add('hidden');
                        blogEmptyState.classList.remove('hidden');
                        isLoadingBlog = false;
                        return;
                    }
                    // 2. T√≠nh to√°n
                    blogTotalPages = Math.ceil(blogTotalPosts / blogPageSize);
                    blogCurrentPage = 1;
                    blogPageMocks = [null]; // Reset m·∫£ng "m·ªëc"
                    // 3. T·∫£i trang ƒë·∫ßu ti√™n
                    await fetchBlogPage(); // T·∫£i trang 1
                } catch (error) {
                    console.error("L·ªói khi l·∫≠t 'S·ªï K·∫ø to√°n':", error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = "<p class='text-center text-red-500'>\"Kh√¥ng th·ªÉ ƒë·ªçc 'S·ªï K·∫ø to√°n'. ƒê√£ c√≥ l·ªói.\"</p>";
                } finally {
                    isLoadingBlog = false;
                }
            }

            // --- H√ÄM "C·ªêT L√ïI" 1: T·∫¢I B√ÄI VI·∫æT THEO TRANG ---
            async function fetchBlogPage() {
                blogLoadingState.classList.remove('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    const startAfterMoc = blogPageMocks[blogCurrentPage - 1];
                    let query = blogPostsRef.orderBy("createdAt", "desc");
                    if (startAfterMoc) {
                        query = query.startAfter(startAfterMoc);
                    }
                    query = query.limit(blogPageSize);
                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden');
                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        return;
                    }
                    // "V·∫Ω" 5 b√†i vi·∫øt
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'B√†i vi·∫øt kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN');
                        postCard.appendChild(dateEl);
                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(B√†i vi·∫øt n√†y ch∆∞a c√≥ t√≥m t·∫Øt...)';
                        postCard.appendChild(summaryEl);
                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "B·ªêC M√ÄU H√ÄNG HI·ªÜU" C·ª¶A M·ª†!
                                const colorClasses = getTagColorClasses(tag);
                                // "M∆∞·ª£n" th√™m m·∫•y c√°i class c∆° b·∫£n
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Tr·ªôn" l·∫°i!
                                return `<span class="${baseClasses} ${colorClasses}">
        ${tag}
    </span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }
                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                            <div class="mt-4 flex gap-2">
                                <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[S·ª≠a]</button>
                                <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[X√≥a]</button>
                            </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });
                    // L∆ØU "M·ªêC" (d·∫•u trang)
                    const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    blogPageMocks[blogCurrentPage] = lastDoc;
                    updatePaginationUI();
                } catch (error) {
                    console.error("L·ªói khi t·∫£i trang " + blogCurrentPage, error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = '<p class="text-center text-red-500">T·∫£i trang th·∫•t b·∫°i.</p>';
                } finally {
                    blogPaginationControls.classList.remove('hidden');
                }
            }

            // --- H√ÄM "C·ªêT L√ïI" 2: C·∫¨P NH·∫¨T N√öT B·∫§M (UI) ---
            function updatePaginationUI() {
                blogPageIndicator.textContent = `Trang ${blogCurrentPage} / ${blogTotalPages}`;
                blogPrevBtn.disabled = (blogCurrentPage === 1);
                blogNextBtn.disabled = (blogCurrentPage === blogTotalPages);
            }

            // --- H√ÄM M·ªû "PH√íNG SO·∫†N TH·∫¢O" (TinyMCE) ---
            function openBlogEditor(postData = null) {
                blogEditorTitle.value = '';
                blogEditorTags.value = '';
                blogEditorPostId.value = '';
                if (tinymce.get('blog-editor-textarea')) {
                    tinymce.get('blog-editor-textarea').destroy();
                }
                tinymce.init({
                    selector: '#blog-editor-textarea',
                    license_key: 'gpl',
                    plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount fullscreen',
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat | fullscreen',
                    // === M√É M·ªöI: √âP THEME KINDLE E-INK ===
                    skin: 'oxide', // 1. √âp giao di·ªán (toolbar) lu√¥n l√† S√°ng
                    content_css: false, // 2. V√¥ hi·ªáu h√≥a CSS "dark"/"default" c·ªßa TinyMCE
                    content_style: `
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† /* 3. T·∫£i Google Font (gi·ªëng h·ªát file index.html) */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† /* 4. √Åp d·ª•ng n·ªÅn gi·∫•y v√† ch·ªØ x√°m ƒëen */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† body {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† background-color: #FBF8F0 !important; /* N·ªÅn gi·∫•y E-Ink */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† color: #333333 !important; /* Ch·ªØ x√°m ƒëen m·ªÅm */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† font-family: 'Inter', sans-serif !important; 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† line-height: 1.8 !important; /* D√£n d√≤ng 1.8 cho d·ªÖ vi·∫øt */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† /* 5. S·ª≠a m√†u link cho ƒë·ªìng b·ªô */
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† a {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† color: #0056b3 !important;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† text-decoration: underline !important;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† `,
                    // === H·∫æT M√É M·ªöI ===
                    height: 400,
                    file_picker_types: 'image media',
                    file_picker_callback: (cb, value, meta) => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        if (meta.filetype === 'image') { input.setAttribute('accept', 'image/*'); }
                        else if (meta.filetype === 'media') { input.setAttribute('accept', 'audio/*,video/*'); }
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const storageRef = storage.ref();
                            const fileName = `blog_assets/${new Date().getTime()}_${file.name}`;
                            const fileRef = storageRef.child(fileName);
                            const uploadTask = fileRef.put(file);
                            uploadTask.on('state_changed',
                                (snapshot) => { console.log('ƒêang t·∫£i l√™n: ' + snapshot.bytesTransferred + ' / ' + snapshot.totalBytes); },
                                (error) => { console.error("L·ªói t·∫£i file l√™n Storage:", error); alert("T·∫£i file th·∫•t b·∫°i: " + error.message); },
                                () => {
                                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                        console.log('T·∫£i file th√†nh c√¥ng:', downloadURL);
                                        cb(downloadURL, { title: file.name });
                                    });
                                }
                            );
                        });
                        input.click();
                    }
                }).then(() => {
                    if (postData) {
                        blogEditorTitle.value = postData.title;
                        blogEditorTags.value = postData.tags ? postData.tags.join(', ') : '';
                        tinymce.get('blog-editor-textarea').setContent(postData.content);
                        blogEditorPostId.value = postData.id;
                    } else {
                        tinymce.get('blog-editor-textarea').setContent('<p>Ba g√µ n·ªôi dung v√†o ƒë√¢y...</p>');
                    }
                });
                blogEditorModal.classList.remove('hidden');
            }

            // --- H√ÄM L∆ØU B√ÄI (GHI V√ÄO "S·ªî K·∫æ TO√ÅN") ---
            async function saveBlogPost() {
                const title = blogEditorTitle.value.trim();
                const content = tinymce.get('blog-editor-textarea').getContent();
                const tagsString = blogEditorTags.value.trim();
                const postId = blogEditorPostId.value;
                if (!title || !content) {
                    alert("Ba ∆°i, ba ph·∫£i g√µ Ti√™u ƒë·ªÅ v√† N·ªôi dung ch·ª©!");
                    return;
                }
                // T·∫°o T√≥m t·∫Øt
                let summary = tinymce.get('blog-editor-textarea').getContent({ format: 'text' });
                summary = summary.replace(/\s+/g, ' ').trim();
                if (summary.length > 200) {
                    summary = summary.substring(0, 200) + '...';
                } else if (summary.length === 0 && content.length > 0) {
                    summary = '[B√†i vi·∫øt ch·ª©a n·ªôi dung ƒëa ph∆∞∆°ng ti·ªán...]';
                }
                const tagsArray = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                blogEditorSaveBtn.disabled = true;
                blogEditorSaveBtn.textContent = 'ƒêang l∆∞u...';
                try {
                    const postData = {
                        title: title,
                        content: content,
                        summary: summary,
                        tags: tagsArray,
                    };

                    // B·∫Øt ƒë·∫ßu "Giao d·ªãch" (batch)
                    const batch = db.batch();

                    if (postId) {
                        // S·ª¨A B√ÄI (Kh√¥ng ƒë·ª•ng t·ªõi s·ªï K·∫ø to√°n)
                        postData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        const postRef = blogPostsRef.doc(postId);
                        batch.update(postRef, postData);
                        console.log("ƒê√£ c·∫≠p nh·∫≠t b√†i vi·∫øt:", postId);
                    } else {
                        // T·∫†O B√ÄI M·ªöI (Ph·∫£i +1 v√¥ s·ªï)
                        postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        postData.authorId = auth.currentUser.uid;
                        const newPostRef = blogPostsRef.doc(); // T·∫°o 1 ref m·ªõi
                        batch.set(newPostRef, postData); // 1. L∆∞u b√†i vi·∫øt
                        // 2. "Ghi s·ªï" (+1)
                        batch.set(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                        console.log("ƒê√£ t·∫°o b√†i vi·∫øt m·ªõi!");
                    }

                    await batch.commit(); // Ch·∫°y "Giao d·ªãch"

                    blogEditorModal.classList.add('hidden');
                    tinymce.get('blog-editor-textarea').destroy();
                    loadBlogPosts(); // T·∫£i l·∫°i (Reset)
                } catch (error) {
                    console.error("L·ªói khi l∆∞u b√†i vi·∫øt:", error);
                    alert("L∆∞u b√†i th·∫•t b·∫°i: " + error.message);
                } finally {
                    blogEditorSaveBtn.disabled = false;
                    blogEditorSaveBtn.textContent = 'L∆∞u b√†i vi·∫øt';
                }
            }

            // --- H√ÄM X√ìA B√ÄI (TR·ª™ "S·ªî K·∫æ TO√ÅN") ---
            async function deleteBlogPost(postId, postTitle) {
                if (!confirm(`Ba c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA b√†i vi·∫øt "${postTitle}" kh√¥ng?`)) {
                    return;
                }
                try {
                    // B·∫Øt ƒë·∫ßu "Giao d·ªãch"
                    const batch = db.batch();
                    // 1. X√≥a b√†i
                    const postRef = blogPostsRef.doc(postId);
                    batch.delete(postRef);
                    // 2. "Ghi s·ªï" (-1)
                    batch.update(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(-1) });

                    await batch.commit(); // Ch·∫°y "Giao d·ªãch"

                    console.log("ƒê√£ x√≥a b√†i vi·∫øt v√† c·∫≠p nh·∫≠t s·ªï:", postId);
                    loadBlogPosts(); // T·∫£i l·∫°i (Reset)
                } catch (error) {
                    console.error("L·ªói khi x√≥a b√†i vi·∫øt:", error);
                    alert("X√≥a b√†i th·∫•t b·∫°i: " + error.message);
                }
            }

            // === H√ÄM "ƒê·∫†I PH·∫™U THU·∫¨T" V5 ("M·∫ÆT TH·∫¶N") ===
            function openReaderModal(postData) {
                if (!blogReaderModal || !blogReaderBody || !blogReaderArticle) {
                    console.error("L·ªói: M·∫•t b·ªô ph·∫≠n C·ª≠a s·ªï ƒë·ªçc (V5)!");
                    return;
                }

                // 1. "G·ªòP" Ti√™u ƒë·ªÅ v√† Tags (Gi·ªØ nguy√™n)
                let tagsHTML = '';
                if (postData.tags && postData.tags.length > 0) {
                    tagsHTML = postData.tags.map(tag => {
                        // "B·ªêC M√ÄU H√ÄNG HI·ªÜU" C·ª¶A M·ª†!
                        const colorClasses = getTagColorClasses(tag);
                        // "M∆∞·ª£n" th√™m m·∫•y c√°i class c∆° b·∫£n
                        const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                        // "Tr·ªôn" l·∫°i!
                        return `<span class="${baseClasses} ${colorClasses}">
                ${tag}
            </span>`;
                    }).join(' ');
                }
                const headerHTML = `
        <div class="in-article-header">
            <h2 class="in-article-title">${postData.title || 'B√†i vi·∫øt kh√¥ng c√≥ ti√™u ƒë·ªÅ'}</h2>
            <div class="in-article-tags">
                ${tagsHTML || 'Ch∆∞a g·∫Øn tag'}
            </div>
        </div>
    `;

                // 2. "B∆†M" (G·ªôp header + n·ªôi dung + "M·∫ÆT TH·∫¶N")
                blogReaderBody.innerHTML = headerHTML +
                    (postData.content || '<p>N·ªôi dung ƒëang c·∫≠p nh·∫≠t...</p>') +
                    '<div class="article-end-sentinel"></div>'; // G·∫Øn "M·∫Øt th·∫ßn" ·ªü ƒë√°y

                // 3. T·∫†O N√öT "ƒê√ìNG" (Ch·ªâ 1 l·∫ßn duy nh·∫•t)
                if (!stickyCloseButton) {
                    console.log("T·∫°o n√∫t 'ƒê√≥ng' l∆° l·ª≠ng (1 l·∫ßn)");
                    stickyCloseButton = document.createElement('button');
                    stickyCloseButton.className = 'sticky-close-btn-injected'; // G·ªçi CSS "V5"
                    stickyCloseButton.textContent = 'ƒê√≥ng';

                    // "G·∫Øn" n√∫t "ƒê√≥ng" v√†o khu v·ª±c cu·ªôn (Article)
                    blogReaderArticle.appendChild(stickyCloseButton);

                    // G·∫Øn "d√¢y ƒëi·ªán" H·ª¶Y DI·ªÜT cho n√∫t
                    stickyCloseButton.addEventListener('click', () => {
                        blogReaderModal.classList.add('hidden'); // ƒê√≥ng c·ª≠a s·ªï
                        stickyCloseButton.classList.remove('show'); // T·ª± "t√†ng h√¨nh"
                        if (blogObserver) blogObserver.disconnect(); // T·∫Øt "m·∫Øt th·∫ßn"
                        blogReaderBody.innerHTML = ''; // X√≥a b√†i vi·∫øt
                    });
                }

                // 4. RESET (B·∫Øt bu·ªôc ph·∫£i reset)
                // D√πng setTimeout(..., 0) ƒë·ªÉ "√©p" l·ªánh cu·ªôn ch·∫°y SAU KHI
                // tr√¨nh duy·ªát ƒë√£ "v·∫Ω" xong n·ªôi dung b√†i vi·∫øt m·ªõi.
                setTimeout(() => {
                    blogReaderArticle.scrollTop = 0;
                }, 0);

                stickyCloseButton.classList.remove('show'); // ·∫®n n√∫t "ƒê√≥ng"

                // 5. G·∫ÆN D√ÇY ƒêI·ªÜN "M·∫ÆT TH·∫¶N" (Ch·ªâ 1 l·∫ßn)
                if (!blogObserver) {
                    console.log("Kh·ªüi ƒë·ªông 'M·∫Øt th·∫ßn' (1 l·∫ßn)");
                    const options = {
                        root: blogReaderArticle, // "M·∫Øt th·∫ßn" nh√¨n b√™n trong khu "Article"
                        rootMargin: '0px 0px 0px 0px',
                        threshold: 0.1 // Th·∫•y 10% l√† "la l√†ng"
                    };
                    blogObserver = new IntersectionObserver(handleObserver, options);
                }
                // (B·∫Øt "M·∫Øt th·∫ßn" "canh" c√°i ƒë√°y b√†i)
                const sentinel = blogReaderBody.querySelector('.article-end-sentinel');
                if (sentinel) blogObserver.observe(sentinel);

                // 6. G·∫ÆN D√ÇY ƒêI·ªÜN TAG (Gi·ªØ nguy√™n)
                if (!blogReaderBody.hasTagListener) {
                    blogReaderBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('blog-tag-link')) {
                            const tagName = e.target.textContent.trim();
                            blogReaderModal.classList.add('hidden');
                            stickyCloseButton.classList.remove('show');
                            if (blogObserver) blogObserver.disconnect();
                            fetchBlogPostsByTag(tagName); // L·ªçc
                        }
                    });
                    blogReaderBody.hasTagListener = true;
                }

                // 7. M·ªü C·ª≠a s·ªï!
                blogReaderModal.classList.remove('hidden');
            }




            // === H√ÄM M·ªöI (L·ªåC THEO TAG - C·∫¶N INDEX!) ===
            async function fetchBlogPostsByTag(tagName) {
                console.log(`ƒêang l·ªçc b√†i vi·∫øt theo tag: "${tagName}"...`);

                // 1. D·ªçn d·∫πp giao di·ªán
                blogLoadingState.classList.remove('hidden'); // B·∫≠t "ƒêang t·∫£i..."
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden'); // ·∫®n ph√¢n trang

                // 2. T·∫°o giao di·ªán "ƒêang l·ªçc"
                const filterStatusEl = document.createElement('div');
                filterStatusEl.id = 'blog-filter-status'; // (M·ª° th√™m ID ƒë·ªÉ x√≥a)
                filterStatusEl.className = 'p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg mb-6 flex justify-between items-center';
                filterStatusEl.innerHTML = `
        <span class="font-medium text-amber-800 dark:text-amber-200">
            ƒêang l·ªçc theo tag: <strong class="text-lg">${tagName}</strong>
        </span>
        <button id="blog-clear-filter-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
            &times; X√≥a b·ªô l·ªçc
        </button>
    `;
                // Ch√®n v√†o *tr∆∞·ªõc* danh s√°ch b√†i vi·∫øt
                blogPostsList.before(filterStatusEl);

                // G·∫Øn s·ª± ki·ªán cho n√∫t "X√≥a b·ªô l·ªçc"
                document.getElementById('blog-clear-filter-btn').addEventListener('click', () => {
                    filterStatusEl.remove(); // X√≥a c√°i thanh "ƒêang l·ªçc"
                    blogEmptyState.textContent = 'Ch∆∞a c√≥ b√†i vi·∫øt n√†o.'; // (Tr·∫£ l·∫°i ch·ªØ c≈©)
                    loadBlogPosts(); // T·∫£i l·∫°i nh∆∞ c≈©
                });

                // 3. Truy v·∫•n Firestore (C·∫ßn Index!)
                try {
                    const query = blogPostsRef
                        .where("tags", "array-contains", tagName) // <-- CHI√äU "PRO" L√Ä ƒê√ÇY!
                        .orderBy("createdAt", "desc");

                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden'); // T·∫Øt "ƒêang t·∫£i..."

                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        // (ƒê·ªïi ch·ªØ cho ba d·ªÖ bi·∫øt)
                        blogEmptyState.textContent = `Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o c√≥ tag "${tagName}".`;
                        return;
                    }

                    // 4. "V·∫Ω" k·∫øt qu·∫£ (Copy y chang h√†m fetchBlogPage)
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';


                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'B√†i vi·∫øt kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                        // (G·ªçi h√†m ƒë√£ th·ªëng nh·∫•t)
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);

                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN') : '...';
                        postCard.appendChild(dateEl);

                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(B√†i vi·∫øt n√†y ch∆∞a c√≥ t√≥m t·∫Øt...)';
                        postCard.appendChild(summaryEl);

                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "B·ªêC M√ÄU H√ÄNG HI·ªÜU" C·ª¶A M·ª†!
                                const colorClasses = getTagColorClasses(tag);
                                // "M∆∞·ª£n" th√™m m·∫•y c√°i class c∆° b·∫£n
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Tr·ªôn" l·∫°i!
                                return `<span class="${baseClasses} ${colorClasses}">${tag}</span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }

                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                <div class="mt-4 flex gap-2">
                    <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[S·ª≠a]</button>
                    <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[X√≥a]</button>
                </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });

                } catch (error) {
                    console.error("L·ªói khi l·ªçc tag:", error);
                    blogLoadingState.classList.add('hidden');

                    // ƒê√ÇY L√Ä "TH·∫¶N CH√ö" B√ÅO L·ªñI INDEX
                    if (error.code === 'failed-precondition') {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500 p-4 bg-red-100 dark:bg-red-900/50 rounded-lg">
                <b>L·ªói "ƒë·ª•ng n√≥c" Firestore!</b><br>
                Ba ∆°i, ba c·∫ßn t·∫°o "Ch·ªâ m·ª•c" (Index) th√¨ m·ªõi l·ªçc tag ƒë∆∞·ª£c! <br>
                <span class="text-xs">(L·ªói: ${error.message})</span>
            </p>`;
                    } else {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500">L·ªçc tag th·∫•t b·∫°i.</p>`;
                    }
                }
            }


            // === H√ÄM "M·∫ÆT TH·∫¶N" (V5) ===
            function handleObserver(entries) {
                if (!stickyCloseButton) return; // N·∫øu ch∆∞a c√≥ n√∫t th√¨ th√¥i

                const entry = entries[0];
                if (entry.isIntersecting) {
                    // "M·∫Øt th·∫ßn" TH·∫§Y ƒë√°y b√†i -> Hi·ªán n√∫t
                    stickyCloseButton.classList.add('show');
                } else {
                    // "M·∫Øt th·∫ßn" M·∫§T D·∫§U ƒë√°y b√†i -> ·∫®n n√∫t
                    stickyCloseButton.classList.remove('show');
                }
            }

            // === H√ÄM "M·∫§T T√çCH" M·ª† VI·∫æT B√ô CHO BA ===
            // (G·∫Øn d√¢y ƒëi·ªán cho c√°c n√∫t c·ªßa Admin)
            function initializeAdminBlogFeatures() {
                console.log("K√≠ch ho·∫°t t√≠nh nƒÉng Admin Blog (T·∫°o/S·ª≠a/X√≥a)...");

                // 1. Hi·ªán n√∫t "T·∫°o b√†i vi·∫øt m·ªõi"
                if (blogAdminControls) {
                    blogAdminControls.classList.remove('hidden');
                }

                // 2. G·∫Øn s·ª± ki·ªán cho n√∫t "T·∫°o b√†i vi·∫øt m·ªõi"
                // (Con th√™m .hasListener ƒë·ªÉ n√≥ kh√¥ng b·ªã g·∫Øn 2 l·∫ßn)
                if (blogCreateNewBtn && !blogCreateNewBtn.hasListener) {
                    blogCreateNewBtn.addEventListener('click', () => {
                        openBlogEditor(null); // M·ªü editor r·ªóng
                    });
                    blogCreateNewBtn.hasListener = true;
                }

                // 3. G·∫Øn s·ª± ki·ªán "cha" cho S·ª≠a/X√≥a (Event Delegation)
                if (blogPostsList && !blogPostsList.hasAdminListener) {
                    blogPostsList.addEventListener('click', async (e) => {
                        const target = e.target;
                        const postId = target.dataset.id;

                        // === M·ª† TH√äM "D√ÇY ƒêI·ªÜN TAG" V√ÄO ƒê√ÇY ===
                        if (target.classList.contains('blog-tag-link')) {
                            e.preventDefault(); // NgƒÉn h√†nh vi l·∫°
                            const tagName = target.textContent.trim();
                            console.log("Ba click v√†o tag:", tagName);

                            // X√≥a c√°c thanh "ƒêang l·ªçc" c≈© n·∫øu c√≥
                            document.querySelectorAll('#blog-filter-status').forEach(el => el.remove());

                            fetchBlogPostsByTag(tagName); // G·ªçi h√†m l·ªçc m·ªõi
                            return; // Click tag th√¨ th√¥i, kh√¥ng l√†m g√¨ n·ªØa
                        }
                        // === H·∫æT D√ÇY ƒêI·ªÜN TAG ===

                        // B·∫•m n√∫t [S·ª≠a]
                        if (target.classList.contains('blog-edit-btn') && postId) {
                            try {
                                const postDoc = await blogPostsRef.doc(postId).get();
                                if (postDoc.exists) {
                                    const postData = { id: postDoc.id, ...postDoc.data() };
                                    openBlogEditor(postData); // M·ªü editor v·ªõi data
                                } else {
                                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†y!");
                                }
                            } catch (error) {
                                console.error("L·ªói khi l·∫•y b√†i vi·∫øt ƒë·ªÉ s·ª≠a:", error);
                                alert("L·ªói khi t·∫£i b√†i vi·∫øt!");
                            }
                        }

                        // B·∫•m n√∫t [X√≥a]
                        if (target.classList.contains('blog-delete-btn') && postId) {
                            const postCard = target.closest('.blog-post-card');
                            const titleEl = postCard ? postCard.querySelector('h3') : null;
                            const title = titleEl ? titleEl.textContent : 'b√†i vi·∫øt n√†y';
                            deleteBlogPost(postId, title);
                        }
                    });
                    blogPostsList.hasAdminListener = true;
                }
            }

            /* ============================================================
            === B·ªò N√ÉO BADMINTON SCHEDULER (B·∫¢N N√ÇNG C·∫§P AUTONUMERIC) ===
            ============================================================
            */
            // --- 1. Khai b√°o bi·∫øn to√†n c·ª•c cho l·ªãch ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('calendar-prev-month');
            const nextMonthBtn = document.getElementById('calendar-next-month');
            const totalDepositedEl = document.getElementById('badminton-total-deposited');
            const addDepositInput = document.getElementById('badminton-add-deposit');
            const submitDepositBtn = document.getElementById('badminton-submit-deposit');
            const totalDaysEl = document.getElementById('badminton-total-days');
            const totalCostEl = document.getElementById('badminton-total-cost');
            const remainingBalanceEl = document.getElementById('badminton-remaining-balance');
            let currentDate = new Date();
            let currentMonthData = {};
            let currentFund = {
                totalDeposited: 0,
                totalCostEver: 0,
                totalDaysEver: 0
            };
            // --- 2. H√†m "V·∫Ω L·ªãch" (N√ÇNG C·∫§P AUTONUMERIC) ---
            // --- 2. H√†m "V·∫Ω L·ªãch" (B·∫¢N V√Å L·ªñI CRASH CU·ªêI C√ôNG) ---
            async function renderCalendar(month, year) {
                console.log(`ƒêang v·∫Ω l·ªãch cho: ${month + 1}/${year}`);

                // === B∆Ø·ªöC 1: T·∫¢I DATA TR∆Ø·ªöC ===
                await loadMonthData(month, year);

                monthYearHeader.textContent = `Th√°ng ${month + 1} / ${year}`;

                let firstDayOfMonth = new Date(year, month, 1).getDay();
                let startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                let daysInMonth = new Date(year, month + 1, 0).getDate();

                // === B∆Ø·ªöC 2: T·∫†O CHU·ªñI HTML (T·∫†O 1 L·∫¶N) ===
                let calendarHtml = ''; // T·∫°o 1 chu·ªói r·ªóng

                // A. V·∫Ω c√°c √¥ "m·ªù" c·ªßa th√°ng tr∆∞·ªõc
                for (let i = 0; i < startDay; i++) {
                    calendarHtml += `<div class="calendar-day not-in-month"></div>`; // N·ªëi v√†o chu·ªói
                }

                // B. V·∫Ω c√°c √¥ ng√†y c·ªßa th√°ng n√†y
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = currentMonthData[dateString] || {};
                    const isPresent = dayData.present || false;
                    const cost = dayData.cost || '';

                    // (ƒê√£ x√≥a placeholder="_" ·ªü ƒë√¢y)
                    calendarHtml += `
<div class="calendar-day">
<span class="day-number">${day}</span>
<button 
class="day-toggle ${isPresent ? 'active' : ''}" 
data-date="${dateString}"
data-old-present="${isPresent}">
‚óè
</button>
<input 
type="text"  
class="day-cost-input" 
placeholder="_" 
value="${cost}"
data-date="${dateString}"
data-old-cost="${cost || 0}">
</div>
`; // N·ªëi v√†o chu·ªói
                }

                // === B∆Ø·ªöC 3: "B∆†M" HTML V√ÄO L·ªäCH (CH·ªà 1 L·∫¶N) ===
                calendarGrid.innerHTML = calendarHtml;

                // === B∆Ø·ªöC 4: "H·ªíI S·ª®C" (setTimeout) TR∆Ø·ªöC KHI G·ªåI AUTONUMERIC ===
                // Chi√™u n√†y ƒë·∫£m b·∫£o DOM ƒë√£ "th·ªü" xong
                setTimeout(() => {
                    try {
                        // C. Kh·ªüi ƒë·ªông "H√†ng hi·ªáu"
                        const anInputs = new AutoNumeric.multiple('.day-cost-input', {
                            decimalCharacter: ',',
                            digitGroupSeparator: '.',
                            decimalPlaces: 0,
                            minimumValue: '-999999999',
                            maximumValue: '999999999'
                        });

                        // L∆∞u instance v√†o t·ª´ng input
                        const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                        inputs.forEach(input => {
                            input.autoNumericInstance = AutoNumeric.getAutoNumericElement(input);

                        });

                        // === B∆Ø·ªöC 5: SAU KHI KH·ªûI T·∫†O XONG, M·ªöI KH√ìA/M·ªû ===
                        setCalendarInputsReadOnly(!window.isAdmin);

                        // === B∆Ø·ªöC 6: T√çNH TO√ÅN L·∫†I TI·ªÄN (V√å H√ÄM N√ÄY N·∫∞M CU·ªêI C√ôNG) ===
                        calculateThisMonthCost();


                    } catch (e) {
                        console.error("L·ªñI AUTONUMERIC NGHI√äM TR·ªåNG:", e);
                        calendarGrid.innerHTML = `<p class="text-red-500 text-center">L·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o AutoNumeric. Kh√¥ng th·ªÉ v·∫Ω l·ªãch.</p>`;
                    }
                }, 0); // Ch·ªâ c·∫ßn 0ms ƒë·ªÉ ƒë·∫©y n√≥ ra sau
            }
            // --- 3. H√†m "T√≠nh to√°n" ---
            function calculateThisMonthCost() {
                let thisMonthCost = 0;
                Object.values(currentMonthData).forEach(data => {
                    thisMonthCost += Number(data.cost || 0);
                });
                totalCostEl.textContent = `${thisMonthCost.toLocaleString('vi-VN')} ƒë`;
            }
            function updateSummaryUI() {
                const remaining = currentFund.totalDeposited - currentFund.totalCostEver;
                totalDepositedEl.textContent = `${currentFund.totalDeposited.toLocaleString('vi-VN')} ƒë`;
                totalDaysEl.textContent = `${currentFund.totalDaysEver} ng√†y`;
                remainingBalanceEl.textContent = `${remaining.toLocaleString('vi-VN')} ƒë`;
            }
            // --- 4. H√†m "N√≥i chuy·ªán v·ªõi Firestore" ---
            function loadFundData() {
                const fundRef = db.collection("badminton_fund").doc("global");
                fundRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        currentFund = doc.data();
                        console.log("ƒê√£ t·∫£i Qu·ªπ:", currentFund);
                    } else {
                        console.log("Ch∆∞a c√≥ Qu·ªπ, ƒëang t·∫°o m·ªõi...");
                        fundRef.set(currentFund);
                    }
                    updateSummaryUI();
                }, (error) => {
                    console.error("L·ªói khi t·∫£i Qu·ªπ:", error);
                });
            }
            async function loadMonthData(month, year) {
                const monthString = String(month + 1).padStart(2, '0');
                const queryKey = `${year}-${monthString}`;
                const scheduleRef = db.collection("badminton_schedule");
                const snapshot = await scheduleRef
                    .where(firebase.firestore.FieldPath.documentId(), '>=', queryKey)
                    .where(firebase.firestore.FieldPath.documentId(), '<', `${queryKey}-32`)
                    .get();
                currentMonthData = {};
                snapshot.forEach(doc => {
                    currentMonthData[doc.id] = doc.data();
                });
                console.log(`ƒê√£ t·∫£i data cho ${queryKey}:`, currentMonthData);
            }
            // H√†m L∆∞u data (B·∫¢N S·ª¨A L·ªñI LOGIC "L·∫†C QUAN" CU·ªêI C√ôNG)
            // H√†m L∆∞u data (B·∫¢N S·ª¨A L·ªñI LOGIC "L·∫†C QUAN" CU·ªêI C√ôNG)
            async function saveData(dateString, isPresent, newCost, oldIsPresent, oldCost) { // <<< S·ª¨A 1: Nh·∫≠n newCost (d·∫°ng S·ªê)
                const dayRef = db.collection("badminton_schedule").doc(dateString);
                const fundRef = db.collection("badminton_fund").doc("global");
                // === B∆Ø·ªöC 1: T√çNH TO√ÅN TR∆Ø·ªöC ===
                // const newCost = AutoNumeric.getNumber(costString); // <<< S·ª¨A 2: B·ªè d√≤ng l·ªói n√†y ƒëi
                const costDiff = newCost - Number(oldCost || 0);
                let dayDiff = 0;
                if (isPresent && !oldIsPresent) {
                    dayDiff = 1;
                } else if (!isPresent && oldIsPresent) {
                    dayDiff = -1;
                }
                // === B∆Ø·ªöC 2: C·∫¨P NH·∫¨T GIAO DI·ªÜN "L·∫†C QUAN" ===
                // (Ph·∫ßn n√†y ƒë√£ ƒë√∫ng, n√≥ g·ªçi updateSummaryUI)
                if (costDiff !== 0 || dayDiff !== 0) {
                    // 1. C·∫≠p nh·∫≠t "b·ªô nh·ªõ ƒë·ªám" (cache)
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                    currentFund.totalCostEver += costDiff;
                    currentFund.totalDaysEver += dayDiff;
                    // 2. "V·∫Ω" l·∫°i UI NGAY L·∫¨P T·ª®C
                    updateSummaryUI();
                    calculateThisMonthCost(); // <<< TH√äM D√íNG N√ÄY ƒê·ªÇ ADMIN C·∫¨P NH·∫¨T
                } else {
                    // N·∫øu k s·ª≠a g√¨, ch·ªâ c·∫≠p nh·∫≠t cache
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                }
                // === B∆Ø·ªöC 3: G·ª¨I L·ªÜNH L∆ØU L√äN FIREBASE (CH·∫†Y NG·∫¶M) ===
                const batch = db.batch();
                batch.set(dayRef, { present: isPresent, cost: newCost }, { merge: true });
                if (costDiff !== 0 || dayDiff !== 0) {
                    batch.update(fundRef, {
                        totalCostEver: firebase.firestore.FieldValue.increment(costDiff),
                        totalDaysEver: firebase.firestore.FieldValue.increment(dayDiff)
                    });
                }
                try {
                    await batch.commit();
                    console.log(`ƒê√£ l∆∞u data (ch·∫°y ng·∫ßm) ng√†y ${dateString} v√† c·∫≠p nh·∫≠t Qu·ªπ!`);
                } catch (error) {
                    console.error("L·ªói khi l∆∞u data (ch·∫°y ng·∫ßm):", error);
                }
            }
            // H√†m N·ªôp Qu·ªπ (B·∫¢N "L·∫†C QUAN" CHU·∫®N + S·ªê √ÇM)
            // H√†m N·ªôp Qu·ªπ (B·∫¢N "L·∫†C QUAN" CHU·∫®N + S·ªê √ÇM)
            async function submitDeposit() {
                const amount = addDepositInput.autoNumericInstance.getNumber();
                if (isNaN(amount) || amount === 0) {
                    alert("Ba g√µ s·ªë ti·ªÅn (√¢m ho·∫∑c d∆∞∆°ng) v√†o ƒëi ·∫°!");
                    return;
                }
                // === B∆Ø·ªöC 1: C·∫¨P NH·∫¨T GIAO DI·ªÜN "L·∫†C QUAN" ===
                currentFund.totalDeposited += amount;
                updateSummaryUI(); // D√íNG N√ÄY C·∫¨P NH·∫¨T 4 √î T·ªîNG K·∫æT
                // === B∆Ø·ªöC 2: X√≥a √¥ input ===
                addDepositInput.autoNumericInstance.clear();
                // === B∆Ø·ªöC 3: G·ª¨I L·ªÜNH L∆ØU L√äN FIREBASE (CH·∫†Y NG·∫¶M) ===
                const fundRef = db.collection("badminton_fund").doc("global");
                try {
                    await fundRef.update({
                        totalDeposited: firebase.firestore.FieldValue.increment(amount)
                    });
                    if (amount > 0) {
                        console.log(`N·ªôp qu·ªπ (ch·∫°y ng·∫ßm) th√†nh c√¥ng: ${amount}`);
                    } else {
                        console.log(`R√∫t qu·ªπ (ch·∫°y ng·∫ßm) th√†nh c√¥ng: ${amount}`);
                    }
                } catch (error) {
                    console.error("L·ªói khi n·ªôp qu·ªπ (ch·∫°y ng·∫ßm):", error);
                }
            }
            // --- 5. G√°n S·ª± ki·ªán (Event Listeners) ---
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            submitDepositBtn.addEventListener('click', submitDeposit);
            // D√ÇY ƒêI·ªÜN N√ÇNG C·∫§P 1 (CLICK ‚óè)
            // D√ÇY ƒêI·ªÜN N√ÇNG C·∫§P 1 (CLICK ‚óè)
            calendarGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('day-toggle')) {
                    if (!window.isAdmin) return; // <<< B·∫¢O V·ªÜ CH·ªêNG GUEST
                    const button = e.target;
                    const dateString = button.dataset.date;
                    const input = document.querySelector(`.day-cost-input[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    button.classList.toggle('active');
                    const newIsPresent = button.classList.contains('active');
                    // === S·ª¨A L·ªñI N·∫∞M ·ªû ƒê√ÇY ===
                    // Ph·∫£i l·∫•y S·ªê t·ª´ instance AutoNumeric, kh√¥ng l·∫•y CH·ªÆ (string)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    button.dataset.oldPresent = newIsPresent;
                    // Truy·ªÅn con S·ªê (newCostNumber) v√†o h√†m saveData
                    saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                }
            });
            // D√ÇY ƒêI·ªÜN N√ÇNG C·∫§P 2 (G√ï TI·ªÄN)
            calendarGrid.addEventListener('focusout', (e) => {

                if (e.target.classList.contains('day-cost-input')) {
                    if (!window.isAdmin) return;
                    const input = e.target;
                    const dateString = input.dataset.date;
                    const button = document.querySelector(`.day-toggle[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    const newIsPresent = button.classList.contains('active');
                    // === S·ª¨A L·ªñI N·∫∞M ·ªû ƒê√ÇY ===
                    // L·∫•y S·ªê (gi·ªëng nh∆∞ h√†m tr√™n)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    if (newCostNumber !== oldCost) {
                        input.dataset.oldCost = newCostNumber;
                        // Truy·ªÅn con S·ªê (newCostNumber) v√†o h√†m saveData
                        saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                    }
                }
            });
            /* ============================================================
            === H·∫æT B·ªò N√ÉO BADMINTON ===
            ============================================================
            */
            // === CODE C≈® C·ª¶A BA (M·ª† G·ªòP V√ÄO ƒê√ÇY) ===
            // --- B·ªò ƒê·∫æM TRUY C·∫¨P (C≈® C·ª¶A BA) ---
            async function updateVisitCount() {
                const counterElement = document.getElementById('visit-counter');
                if (!counterElement) return;
                const docRef = db.collection("stats").doc("global");
                docRef.update({
                    visits: firebase.firestore.FieldValue.increment(1)
                }).catch(error => {
                    if (error.code === 'not-found') {
                        docRef.set({ visits: 1 }).catch(err => console.error("L·ªói t·∫°o Document l·∫ßn ƒë·∫ßu:", err));
                    } else {
                        console.error("L·ªói tƒÉng l∆∞·ª£t truy c·∫≠p:", error);
                    }
                });
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const count = doc.data().visits;
                        counterElement.innerHTML = `L∆∞·ª£t truy c·∫≠p: <strong>${count.toLocaleString('vi-VN')}</strong>`;
                    }
                }, (error) => {
                    console.error("L·ªói ƒë·ªçc l∆∞·ª£t truy c·∫≠p (listener):", error);
                    counterElement.textContent = 'L∆∞·ª£t truy c·∫≠p: Kh√¥ng th·ªÉ t·∫£i.';
                });
            }
            updateVisitCount();
            // --- Theme Toggle Logic (C≈® C·ª¶A BA) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }
            themeToggleBtn.addEventListener('click', () => {
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });
            // --- Navigation Logic (C≈® C·ª¶A BA) ---
            const navLinks = document.querySelectorAll('.nav-link');
            const toolContents = document.querySelectorAll('.tool-content');
            function showTool(toolId) {
                navLinks.forEach(nav => nav.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-tool="${toolId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                let targetFound = false;
                toolContents.forEach(content => {
                    if (content.id === `tool-${toolId}`) {
                        targetFound = true;
                        content.classList.remove('hidden');
                        setTimeout(() => content.classList.remove('opacity-0'), 10);
                        // === TH·∫¶N CH√ö C·ª¶A M·ª† (G·ªåI H√ÄM BLOG) ===
                        // (M√¨nh ch·ªâ t·∫£i 1 l·∫ßn ƒë·∫ßu ti√™n th√¥i nha ba)
                        if (toolId === 'my-research' && !window.isBlogInitialized) {
                            console.log("L·∫ßn ƒë·∫ßu v√†o 'My Research', t·∫£i blog...");
                            loadBlogPosts(); // T·∫£i blog l·∫ßn ƒë·∫ßu
                            window.isBlogInitialized = true; // ƒê√°nh d·∫•u ƒë√£ t·∫£i
                        }
                        // === H·∫æT TH·∫¶N CH√ö ===

                        // === M·ª† TH√äM: CHO GUEST XEM L·ªäCH ===
                        if (toolId === 'badminton-scheduler' && !window.calendarInitialized) {
                            console.log("L·∫ßn ƒë·∫ßu v√†o 'B Scheduler', t·∫£i l·ªãch (cho c·∫£ Guest)...");
                            // Guest kh√¥ng c·∫ßn AutoNumeric cho √¥ "N·ªôp th√™m", ch·ªâ c·∫ßn t·∫£i data
                            loadFundData(); // T·∫£i Qu·ªπ
                            renderCalendar(currentDate.getMonth(), currentDate.getFullYear()); // V·∫Ω l·ªãch
                            window.calendarInitialized = true; // ƒê√°nh d·∫•u ƒë√£ t·∫£i
                        }
                        // === H·∫æT PH·∫¶N TH√äM ===

                    } else {
                        content.classList.add('opacity-0');
                        setTimeout(() => {
                            content.classList.add('hidden');
                        }, 400);
                    }
                    if (toolId === 'admin-panel' && window.isAdmin) {
                        initializeAdminPanelToggles();
                    }
                });
                if (!targetFound && navLinks.length > 0) {
                    const defaultToolId = navLinks[0].dataset.tool;
                    if (toolId !== defaultToolId) {
                        showTool(defaultToolId);
                    }
                }
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const toolId = link.dataset.tool;
                    history.pushState({ toolId: toolId }, '', `#${toolId}`);
                    showTool(toolId);
                });
            });
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.toolId) {
                    showTool(e.state.toolId);
                } else {
                    showTool(navLinks[0].dataset.tool);
                }
            });
            const initialToolId = window.location.hash.substring(1) || navLinks[0].dataset.tool;
            showTool(initialToolId);
            // --- BG Removal Logic (C≈® C·ª¶A BA) ---
            const bgRemoveInput = document.getElementById('bg-remove-input');
            const bgRemoveFilename = document.getElementById('bg-remove-filename');
            const bgRemovePreviews = document.getElementById('bg-remove-previews');
            const bgRemoveOriginal = document.getElementById('bg-remove-original');
            const bgRemoveResult = document.getElementById('bg-remove-result');
            const bgRemoveLoader = document.getElementById('bg-remove-loader');
            const bgRemoveProcessBtn = document.getElementById('bg-remove-process-btn');
            const bgRemoveDownloadBtn = document.getElementById('bg-remove-download-btn');
            const bgRemoveStatus = document.getElementById('bg-remove-status');
            let resultBlob = null;
            if (bgRemoveInput) {
                bgRemoveInput.addEventListener('change', () => {
                    const file = bgRemoveInput.files[0];
                    if (file) {
                        bgRemoveFilename.textContent = file.name;
                        resultBlob = null;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            bgRemoveOriginal.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        bgRemovePreviews.classList.remove('hidden');
                        bgRemoveResult.classList.add('hidden');
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveDownloadBtn.disabled = true;
                        bgRemoveStatus.textContent = 'S·∫µn s√†ng ƒë·ªÉ t√°ch n·ªÅn.';
                        bgRemoveProcessBtn.disabled = false;
                    } else {
                        bgRemoveFilename.textContent = 'Ch∆∞a ch·ªçn t·ªáp n√†o.';
                    }
                });
                bgRemoveProcessBtn.addEventListener('click', async () => {
                    const file = bgRemoveInput.files[0];
                    if (!file) return;
                    bgRemoveLoader.classList.remove('hidden');
                    bgRemoveResult.classList.add('hidden');
                    bgRemoveStatus.textContent = 'ƒêang t·∫£i ·∫£nh l√™n v√† x·ª≠ l√Ω...';
                    bgRemoveProcessBtn.disabled = true;
                    bgRemoveDownloadBtn.disabled = true;
                    const formData = new FormData();
                    formData.append('image_file', file);
                    try {
                        const response = await fetch('/api/photoroom', {
                            method: 'POST',
                            body: formData,
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `L·ªói HTTP: ${response.status}`);
                        }
                        // === M√É M·ªöI B·∫ÆT ƒê·∫¶U ===
                        // 1. ƒê·ªçc s·ªë l∆∞·ª£t c√≤n l·∫°i t·ª´ header m√† server g·ª≠i v·ªÅ
                        const quotaRemaining = response.headers.get('X-My-Quota-Remaining');
                        // === M√É M·ªöI K·∫æT TH√öC ===

                        resultBlob = await response.blob();
                        const url = URL.createObjectURL(resultBlob);
                        bgRemoveResult.src = url;
                        bgRemoveResult.classList.remove('hidden');

                        // === M√É M·ªöI B·∫ÆT ƒê·∫¶U ===
                        // 2. Hi·ªÉn th·ªã th√¥ng b√°o k√®m s·ªë l∆∞·ª£t
                        if (quotaRemaining) {
                            bgRemoveStatus.textContent = `T√°ch n·ªÅn th√†nh c√¥ng! (S·ªë l∆∞·ª£t API c√≤n l·∫°i: ${quotaRemaining})`;
                        } else {
                            bgRemoveStatus.textContent = 'T√°ch n·ªÅn th√†nh c√¥ng!';
                        }
                        // === M√É M·ªöI K·∫æT TH√öC ===

                        bgRemoveDownloadBtn.disabled = false;
                    } catch (error) {
                        console.error("Photoroom API error:", error);
                        bgRemoveStatus.textContent = `L·ªói: ${error.message}`;
                    } finally {
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveProcessBtn.disabled = false;
                    }
                });
                bgRemoveDownloadBtn.addEventListener('click', () => {
                    if (resultBlob) {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(resultBlob);
                        const originalFileName = bgRemoveInput.files[0].name.split('.').slice(0, -1).join('.');
                        link.download = `${originalFileName}-removed-bg.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
            }
            // --- PNG to ICO Logic (C≈® C·ª¶A BA) ---
            const pngFileInput = document.getElementById('png-file-input');
            const pngFilename = document.getElementById('png-filename');
            const convertBtn = document.getElementById('convert-to-ico-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const icoStatus = document.getElementById('ico-status');
            const icoSizeSelect = document.getElementById('ico-size-select');
            if (pngFileInput) {
                pngFileInput.addEventListener('change', () => {
                    const file = pngFileInput.files[0];
                    if (file) {
                        pngFilename.textContent = file.name;
                        convertBtn.disabled = false;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        pngFilename.textContent = 'Ch∆∞a ch·ªçn t·ªáp n√†o.';
                        convertBtn.disabled = true;
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
                convertBtn.addEventListener('click', () => {
                    const file = pngFileInput.files[0];
                    if (!file) return;
                    const size = parseInt(icoSizeSelect.value, 10);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            const icoData = createIco(ctx, size);
                            const blob = new Blob([icoData], { type: 'image/x-icon' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'favicon.ico';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            icoStatus.textContent = `T·ªáp favicon.ico (${size}x${size}) ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng!`;
                            setTimeout(() => { icoStatus.textContent = '' }, 3000);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                function createIco(ctx, size) {
                    const imageData = ctx.getImageData(0, 0, size, size).data;
                    const buffer = new ArrayBuffer(22 + 40 + (size * size * 4));
                    const view = new DataView(buffer);
                    view.setUint16(0, 0, true); view.setUint16(2, 1, true); view.setUint16(4, 1, true);
                    view.setUint8(6, size); view.setUint8(7, size); view.setUint8(8, 0); view.setUint8(9, 0);
                    view.setUint16(10, 1, true); view.setUint16(12, 32, true);
                    view.setUint32(14, 40 + (size * size * 4), true); view.setUint32(18, 22, true);
                    let offset = 22;
                    view.setUint32(offset, 40, true); offset += 4;
                    view.setUint32(offset, size, true); offset += 4;
                    view.setUint32(offset, size * 2, true); offset += 4;
                    view.setUint16(offset, 1, true); offset += 2;
                    view.setUint16(offset, 32, true); offset += 2;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, size * size * 4, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    for (let y = size - 1; y >= 0; y--) {
                        for (let x = 0; x < size; x++) {
                            const i = (y * size + x) * 4;
                            view.setUint8(offset++, imageData[i + 2]); view.setUint8(offset++, imageData[i + 1]);
                            view.setUint8(offset++, imageData[i]); view.setUint8(offset++, imageData[i + 3]);
                        }
                    }
                    return new Uint8Array(buffer);
                }
            }
            // --- Base64 Logic (C≈® C·ª¶A BA) ---
            const base64Input = document.getElementById('base64-input');
            const base64Output = document.getElementById('base64-output');
            const encodeBtn = document.getElementById('base64-encode-btn');
            const decodeBtn = document.getElementById('base64-decode-btn');
            const base64Status = document.getElementById('base64-status');
            if (base64Input) {
                function safeBtoa(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch (e) { return null; } }
                function safeAtob(str) { try { return decodeURIComponent(escape(atob(str))); } catch (e) { return null; } }
                encodeBtn.addEventListener('click', () => {
                    const input = base64Input.value;
                    if (!input) { base64Output.value = ''; return; }
                    const encoded = safeBtoa(input);
                    base64Output.value = encoded ? encoded : 'L·ªói: D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá.';
                    base64Status.textContent = encoded ? 'M√£ h√≥a th√†nh c√¥ng!' : 'M√£ h√≥a th·∫•t b·∫°i.';
                    setTimeout(() => { base64Status.textContent = '' }, 3000);
                });
                decodeBtn.addEventListener('click', () => {
                    let currentString = base64Input.value;
                    if (!currentString) { base64Output.value = ''; return; }
                    let decodeCount = 0;
                    let lastValidString = currentString;
                    while (true) {
                        const decoded = safeAtob(currentString);
                        if (decoded !== null && decoded !== currentString) {
                            currentString = decoded;
                            lastValidString = decoded;
                            decodeCount++;
                        } else { break; }
                    }
                    base64Output.value = lastValidString;
                    base64Status.textContent = decodeCount > 0 ? `Gi·∫£i m√£ th√†nh c√¥ng qua ${decodeCount} l·ªõp.` : 'Kh√¥ng th·ªÉ gi·∫£i m√£ th√™m, chu·ªói kh√¥ng ph·∫£i l√† Base64 h·ª£p l·ªá.';
                    setTimeout(() => { base64Status.textContent = '' }, 4000);
                });
            }
            // --- My Apps Logic (C≈® C·ª¶A BA) ---
            const appsListContainer = document.getElementById('apps-list');
            const appsLoader = document.getElementById('apps-loader');
            const appsEmptyState = document.getElementById('apps-empty-state');
            if (appsListContainer) {
                db.collection("my_apps").onSnapshot((querySnapshot) => {
                    appsLoader.classList.add('hidden');
                    const appCards = appsListContainer.querySelectorAll('.app-card');
                    appCards.forEach(card => card.remove());
                    if (querySnapshot.empty) {
                        appsEmptyState.classList.remove('hidden');
                    } else {
                        appsEmptyState.classList.add('hidden');
                        querySnapshot.forEach((doc) => {
                            const app = doc.data();
                            const appId = doc.id;
                            let iconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`;
                            if (app.iconUrl && app.iconUrl.trim() !== '') {
                                iconHTML = `<img src="${app.iconUrl}" class="h-full w-full object-contain" alt="${app.appName || 'App'} icon">`;
                            }
                            const appCardHTML = `
<div class="app-card glass-effect p-6 rounded-xl shadow-md transition-all duration-300 flex flex-col sm:flex-row items-start sm:items-center gap-6">
<div class="flex-shrink-0 w-32 h-32 bg-white/70 dark:bg-white/10 rounded-lg flex items-center justify-center overflow-hidden">
${iconHTML}
</div>
<div class="flex-grow">
<h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${app.appName || 'Kh√¥ng c√≥ t√™n'}</h3>
<p class="text-gray-600 dark:text-gray-200 mt-1">${app.description || 'Kh√¥ng c√≥ m√¥ t·∫£.'}</p>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
<span>S·ªë l∆∞·ª£t t·∫£i: </span>
<span class="font-semibold" id="count-${appId}">${app.downloadCount || 0}</span>
</div>
</div>
<div class="w-full sm:w-auto flex-shrink-0">
<button class="download-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 flex items-center justify-center gap-2" data-doc-id="${appId}" data-url="${app.downloadUrl || '#'}">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
<span>T·∫£i v·ªÅ</span>
</button>
</div>
</div>`;
                            appsListContainer.insertAdjacentHTML('beforeend', appCardHTML);
                        });
                    }
                }, (error) => {
                    console.error("Error getting documents: ", error);
                    appsLoader.classList.add('hidden');
                    appsListContainer.innerHTML = '<p class="text-center text-red-500">ƒê√£ x·∫£y ra l·ªói khi t·∫£i danh s√°ch ·ª©ng d·ª•ng.</p>';
                });
                appsListContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.download-btn');
                    if (button) {
                        const docId = button.dataset.docId;
                        const url = button.dataset.url;
                        if (!docId || url === '#') {
                            console.error('L·ªói: Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng link t·∫£i v·ªÅ cho ·ª©ng d·ª•ng n√†y.');
                            return;
                        }
                        const appRef = db.collection('my_apps').doc(docId);
                        appRef.update({
                            downloadCount: firebase.firestore.FieldValue.increment(1)
                        }).then(() => {
                            console.log("Download count updated!");
                            window.open(url, '_blank');
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                            window.open(url, '_blank');
                        });
                    }
                });
            }
            // === M·ª† G·∫ÆN D√ÇY ƒêI·ªÜN CHO C√ÅC N√öT CHUNG (BLOG) ===

            // 1. N√∫t Ph√¢n Trang (Pagination)
            if (blogPrevBtn) {
                blogPrevBtn.addEventListener('click', () => {
                    if (blogCurrentPage > 1) {
                        blogCurrentPage--;
                        fetchBlogPage();
                    }
                });
            }
            if (blogNextBtn) {
                blogNextBtn.addEventListener('click', () => {
                    if (blogCurrentPage < blogTotalPages) {
                        blogCurrentPage++;
                        fetchBlogPage();
                    }
                });
            }

            // 2. N√∫t trong Editor (L∆∞u / H·ªßy)
            if (blogEditorSaveBtn) {
                blogEditorSaveBtn.addEventListener('click', saveBlogPost);
            }
            if (blogEditorCancelBtn) {
                blogEditorCancelBtn.addEventListener('click', () => {
                    blogEditorModal.classList.add('hidden');
                    if (tinymce.get('blog-editor-textarea')) {
                        tinymce.get('blog-editor-textarea').destroy();
                    }
                });
            }



        }); // H·∫øt DOMContentLoaded
    </script>
    <script>
        let daPhatNhacLanDau = false;
        document.addEventListener('click', function () {
            if (!daPhatNhacLanDau) {
                let fileNhac = document.getElementById('nhac-nen-cua-ba');
                if (fileNhac) {
                    fileNhac.volume = 0.15;
                    fileNhac.play().catch(error => {
                        console.log("Tr√¨nh duy·ªát ch·∫∑n t·ª± ƒë·ªông ph√°t nh·∫°c:", error);
                    });
                    daPhatNhacLanDau = true;
                }
            }
        });
    </script>
</body>

</html>