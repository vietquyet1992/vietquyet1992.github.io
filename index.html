<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TVQ's World</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.10.5/dist/autoNumeric.min.js"></script>
    <script src="tinymce/tinymce.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=4.0">
    <script>
        if (localStorage.theme === 'dark' || !('theme' in localStorage)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>

<body class="text-black dark:text-gray-100 min-h-screen">
    <audio id="nhac-nen-cua-ba" src="assets/am-thanh.mp3" loop></audio>
    <div class="lg:flex">
        <aside class="lg:w-64 w-full lg:min-h-screen p-4 flex flex-col glass-effect">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-amber-600 dark:text-amber-400">My Toolbox</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400">CÃ´ng cá»¥ & á»¨ng dá»¥ng</p>
            </div>
            <nav class="flex flex-col space-y-2">
                <a href="#" class="nav-link active group flex items-center px-4 py-3 rounded-lg transition-all duration-200 
text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white" data-tool="remove-bg">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5.5 2a3.5 3.5 0 013.163 5.002L13 11.172V15a1 1 0 01-1 1H6a1 1 0 01-1-1v-3.828l4.337-4.17A3.5 3.5 0 115.5 2zM4.5 3.5a2.5 2.5 0 105 0 2.5 2.5 0 00-5 0z" />
                        <path
                            d="M11.94 11.513l-1.34-1.29a.75.75 0 00-1.06 1.06l1.5 1.44a.75.75 0 001.12-.001l3.5-3.719a.75.75 0 00-1.08-1.04l-2.64 2.79z" />
                    </svg>
                    <span class="font-medium">TÃ¡ch ná»n áº£nh</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="png-to-ico">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">PNG to ICO</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="base64">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a3 3 0 006 0h3a2 2 0 012 2v9a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm12 3a1 1 0 01-1 1H5a1 1 0 01-1-1V6a1 1 0 011-1h2a1 1 0 011 1v1h4V6a1 1 0 011-1h2a1 1 0 011 1v1z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Base64 Multi-layer</span>
                </a>
                <a href="#"
                    class="nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-apps">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    <span class="font-medium">My Apps</span>
                </a>
                <a href="#" id="nav-my-diary"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-diary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 005.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM11 4.804A7.968 7.968 0 0114.5 4c1.255 0 2.443.29 3.5.804v10A7.969 7.969 0 0114.5 16c-1.255 0-2.443-.29-3.5-.804V4.804z" />
                    </svg>
                    <span class="font-medium">My Diary</span>
                </a>
                <a href="#" id="nav-my-research"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="my-research">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 2a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V2.75A.75.75 0 0110 2zM8.5 4.5A.75.75 0 007.75 5.25v1.25a.75.75 0 001.5 0V5.25A.75.75 0 008.5 4.5zM12.25 5.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0V5.25zM10 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H10a.75.75 0 01-.75-.75V10.75A.75.75 0 0110 10zM8.5 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM12.25 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM5.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H5.5a.75.75 0 01-.75-.75V10.75A.75.75 0 015.5 10zM4 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM6.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM14.5 10a.75.75 0 01.75.75v.25h1.25a.75.75 0 010 1.5H14.5a.75.75 0 01-.75-.75V10.75A.75.75 0 0114.5 10zM13 11.5a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25zM15.75 12.25a.75.75 0 00-1.5 0v1.25a.75.75 0 001.5 0v-1.25z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">My Blog</span>
                </a>
                <a href="#" id="nav-badminton-scheduler"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="badminton-scheduler">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">B Scheduler</span>
                </a>

                <a href="#" id="nav-admin-panel"
                    class="nav-link group hidden flex items-center px-4 py-3 rounded-lg transition-all duration-200 text-gray-700 dark:text-gray-300 hover:bg-amber-500 hover:text-white"
                    data-tool="admin-panel">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5 mr-3 transition-all duration-200 text-amber-500 group-hover:text-white"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span class="font-medium">Admin Panel</span>
                </a>

            </nav>
            <div class="mt-auto">
                <div class="p-4">
                    <button id="theme-toggle"
                        class="w-full flex items-center justify-center p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor"
                            viewBox="0 0 20 20">
                            <path
                                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                                fill-rule="evenodd" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
                <div id="guest-view" class="text-center pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                    <p id="admin-login-btn"
                        class="text-base text-gray-500 dark:text-gray-400 cursor-pointer hover:text-amber-500 dark:hover:text-amber-400 transition-colors">
                        &copy; 2025 TiÃªu Viáº¿t Quyáº¿t
                    </p>
                </div>
                <div id="admin-view" class="p-4 border-t border-gray-300/50 dark:border-gray-600/50"
                    style="display: none;">
                    <div class="flex items-center space-x-3">
                        <img id="admin-avatar" src="images/favicon.png" alt="Avatar"
                            class="h-10 w-10 rounded-full border-2 border-amber-500 object-cover">
                        <div class="flex-1">
                            <p id="admin-name" class="font-semibold text-sm text-gray-800 dark:text-gray-100">ChÃ o ba!
                            </p>
                            <a href="#" id="admin-logout-btn"
                                class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-medium">ÄÄƒng
                                xuáº¥t</a>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto min-h-screen">
            <div id="tool-remove-bg" class="tool-content">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">TÃ¡ch ná»n áº£nh</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Táº£i lÃªn má»™t hÃ¬nh áº£nh Ä‘á»ƒ tá»± Ä‘á»™ng xÃ³a ná»n báº±ng API
                        cá»§a Photoroom.</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="bg-remove-input"
                                class="cursor-pointer bg-gray-300 text-gray-700 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chá»n tá»‡p...
                            </label>
                            <span id="bg-remove-filename" class="text-sm text-gray-500 dark:text-gray-300">ChÆ°a chá»n tá»‡p
                                nÃ o.</span>
                            <input type="file" id="bg-remove-input" accept="image/png, image/jpeg" class="hidden" />
                        </div>
                        <div id="bg-remove-previews" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">áº¢nh gá»‘c:</p>
                                <img id="bg-remove-original"
                                    class="w-full rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                            </div>
                            <div>
                                <p class="text-sm font-medium mb-2 dark:text-gray-300">ÄÃ£ tÃ¡ch ná»n:</p>
                                <div class="w-full aspect-video rounded-lg border border-gray-200/50 dark:border-gray-700/50 flex items-center justify-center bg-gray-100/50 dark:bg-gray-700/50"
                                    style="background-image: repeating-conic-gradient(#d1d5db80 0 25%, #e5e7eb80 0 50%); background-size: 16px 16px;">
                                    <img id="bg-remove-result" class="hidden max-w-full max-h-full" />
                                    <div id="bg-remove-loader" class="loader hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-2">
                            <button id="bg-remove-process-btn"
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>TÃ¡ch ná»n</button>
                            <button id="bg-remove-download-btn"
                                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg"
                                disabled>Táº£i xuá»‘ng káº¿t quáº£</button>
                        </div>
                        <div id="bg-remove-status" class="text-sm text-gray-500 dark:text-gray-400 mt-2 h-5"></div>
                    </div>
                </div>
            </div>
            <div id="tool-png-to-ico" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Chuyá»ƒn Ä‘á»•i PNG sang ICO</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Táº£i lÃªn tá»‡p PNG vÃ  chá»n kÃ­ch thÆ°á»›c Ä‘á»ƒ táº¡o tá»‡p ICO
                        (biá»ƒu tÆ°á»£ng trang web).</p>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="png-file-input"
                                class="cursor-pointer bg-gray-300 text-gray-500 dark:bg-gray-600/50 dark:text-gray-400 py-2 px-4 rounded-lg transition duration-300 shadow-none">
                                Chá»n tá»‡p...
                            </label>
                            <span id="png-filename" class="text-sm text-gray-500 dark:text-gray-300">ChÆ°a chá»n tá»‡p
                                nÃ o.</span>
                            <input type="file" id="png-file-input" accept="image/png" class="hidden" />
                        </div>
                        <div id="image-preview-container" class="mt-4 hidden">
                            <p class="text-sm font-medium mb-2 dark:text-gray-300">áº¢nh xem trÆ°á»›c:</p>
                            <img id="image-preview"
                                class="max-w-xs max-h-32 rounded-lg border border-gray-200/50 dark:border-gray-700/50" />
                        </div>
                        <div>
                            <label for="ico-size-select" class="block font-medium mb-2 dark:text-gray-300">Chá»n kÃ­ch
                                thÆ°á»›c:</label>
                            <select id="ico-size-select"
                                class="w-full sm:w-auto p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                                <option value="16">16x16 pixels</option>
                                <option value="32" selected>32x32 pixels</option>
                                <option value="48">48x48 pixels</option>
                                <option value="64">64x64 pixels</option>
                                <option value="128">128x128 pixels</option>
                            </select>
                        </div>
                        <button id="convert-to-ico-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 
disabled:bg-gray-300 disabled:text-gray-500 disabled:shadow-none 
dark:disabled:bg-gray-600/50 dark:disabled:text-gray-400 
shadow-lg hover:shadow-amber-500/40" disabled>Chuyá»ƒn Ä‘á»•i & Táº£i xuá»‘ng</button>
                        <div id="ico-status" class="text-sm text-green-600 dark:text-green-400 mt-2"></div>
                    </div>
                </div>
            </div>
            <div id="tool-base64" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">MÃ£ hÃ³a & Giáº£i mÃ£ Base64</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">MÃ£ hÃ³a (1 láº§n) hoáº·c giáº£i mÃ£ (nhiá»u lá»›p) chuá»—i vÄƒn
                        báº£n cá»§a báº¡n.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="base64-input" class="font-medium dark:text-gray-300">Äáº§u vÃ o:</label>
                            <textarea id="base64-input" rows="8"
                                class="w-full p-3 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"></textarea>
                        </div>
                        <div class="space-y-2">
                            <label for="base64-output" class="font-medium dark:text-gray-300">Káº¿t quáº£:</label>
                            <textarea id="base64-output" rows="8" readonly
                                class="w-full p-3 bg-gray-100/50 dark:bg-slate-800/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg cursor-not-allowed"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-col sm:flex-row gap-4">
                        <button id="base64-encode-btn"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">MÃ£
                            hÃ³a (Encode)</button>
                        <button id="base64-decode-btn"
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-blue-500/50">Giáº£i
                            mÃ£ (Decode)</button>
                    </div>
                    <div id="base64-status" class="text-sm mt-4"></div>
                </div>
            </div>
            <div id="tool-my-apps" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">á»¨ng dá»¥ng cá»§a tÃ´i</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Tá»•ng há»£p cÃ¡c á»©ng dá»¥ng Windows do tÃ´i phÃ¡t triá»ƒn.
                        Nháº¥n Ä‘á»ƒ táº£i vá» vÃ  tráº£i nghiá»‡m!</p>
                    <div id="apps-list" class="space-y-6">
                        <div id="apps-loader" class="flex justify-center items-center py-8">
                            <div class="loader"></div>
                        </div>
                        <p id="apps-empty-state" class="text-center text-gray-500 py-8 hidden">ChÆ°a cÃ³ á»©ng dá»¥ng nÃ o Ä‘Æ°á»£c
                            thÃªm.</p>
                    </div>
                </div>
            </div>
            <div id="tool-my-diary" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">My Diary</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">ÄÃ¢y lÃ  khu vá»±c nháº­t kÃ½ cá»§a ba...</p>
                </div>
            </div>
            <div id="tool-my-research" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Má»™t vÃ i bÃ i viáº¿t do chá»©c nÄƒng
                        Deep Research cá»§a Gemini táº¡o ra!</h2>
                    <div id="blog-admin-controls" class="hidden">
                        <button id="blog-create-new-btn"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/40 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>Táº¡o bÃ i viáº¿t má»›i</span>
                        </button>
                    </div>
                    <div id="blog-posts-list" class="space-y-6">
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="blog-loading-state" class="text-center text-gray-500 py-8">Äang
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  táº£i bÃ i viáº¿t...</p>
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="blog-empty-state" class="text-center text-gray-500 py-8 hidden">
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ChÆ°a cÃ³ bÃ i viáº¿t nÃ o.</p>
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="blog-pagination-controls"
                        class="hidden flex items-center justify-between mt-8">
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="blog-prev-btn" Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
                            class="font-bold py-2 px-6 rounded-lg transition duration-300 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â bg-amber-500 hover:bg-amber-600 text-white shadow-lg hover:shadow-amber-500/40 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â disabled:bg-gray-200/50 disabled:dark:bg-gray-700/50 disabled:text-gray-700 disabled:dark:text-gray-300 disabled:shadow-none disabled:cursor-not-allowed disabled:hover:bg-gray-200/50 disabled:dark:hover:bg-gray-600/70">
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  &larr; Trang trÆ°á»›c
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="blog-page-indicator"
                            class="font-semibold text-gray-700 dark:text-gray-300">Trang 1 /
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1</span>
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="blog-next-btn" Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
                            class="font-bold py-2 px-6 rounded-lg transition duration-300 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â bg-amber-500 hover:bg-amber-600 text-white shadow-lg hover:shadow-amber-500/40 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â disabled:bg-gray-200/50 disabled:dark:bg-gray-700/50 disabled:text-gray-700 disabled:dark:text-gray-300 disabled:shadow-none disabled:cursor-not-allowed disabled:hover:bg-gray-200/50 disabled:dark:hover:bg-gray-600/70">
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Trang sau &rarr;
                            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
                        Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

                </div>
            </div>
            <div id="tool-badminton-scheduler" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect space-y-8">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">Badminton Scheduler</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tá»•ng tiá»n Ä‘Ã£
                                ná»™p:</label>
                            <p id="badminton-total-deposited"
                                class="text-2xl font-bold text-green-600 dark:text-green-400">0 Ä‘
                            </p>
                            <div class="mt-4 flex gap-2">
                                <input type="text" id="badminton-add-deposit" placeholder="Ná»™p thÃªm..."
                                    class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" />
                                <button id="badminton-submit-deposit"
                                    class="p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition-all shadow-lg hover:shadow-green-500/50">
                                    [+]
                                </button>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tá»•ng sá»‘ ngÃ y
                                Ä‘i:</label>
                            <p id="badminton-total-days" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0
                                ngÃ y</p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Tá»•ng sá»‘ tiá»n sÃ¢n
                                (thÃ¡ng nÃ y):</label>
                            <p id="badminton-total-cost" class="text-2xl font-bold text-red-500 dark:text-red-400">0 Ä‘
                            </p>
                        </div>
                        <div class="p-4 bg-gray-100/50 dark:bg-gray-800/50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-500 dark:text-gray-400">Sá»‘ tiá»n cÃ²n
                                láº¡i:</label>
                            <p id="badminton-remaining-balance"
                                class="text-2xl font-bold text-amber-600 dark:text-amber-400">0
                                Ä‘</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <button id="calendar-prev-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <h3 id="calendar-month-year"
                                class="text-xl font-bold text-center text-amber-600 dark:text-amber-400">ThÃ¡ng 11 / 2025
                            </h3>
                            <button id="calendar-next-month"
                                class="p-2 rounded-lg bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 dark:text-gray-400">
                            <div class="calendar-header">Thá»© 2</div>
                            <div class="calendar-header">Thá»© 3</div>
                            <div class="calendar-header">Thá»© 4</div>
                            <div class="calendar-header">Thá»© 5</div>
                            <div class="calendar-header">Thá»© 6</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Thá»© 7</div>
                            <div class="calendar-header text-red-500 dark:text-red-400">Chá»§ Nháº­t</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tool-admin-panel" class="tool-content hidden opacity-0">
                <div class="p-8 tool-card glass-effect">
                    <h2 class="text-2xl font-bold mb-2 text-amber-600 dark:text-gray-50">CÃ i Ä‘áº·t Hiá»ƒn thá»‹</h2>
                    <p class="text-gray-800 dark:text-gray-300 mb-6">Chá»n nhá»¯ng tab mÃ  <span
                            class="font-bold text-red-500">KhÃ¡ch (Guest)</span> cÃ³ thá»ƒ tháº¥y.</p>

                    <div class="space-y-4 max-w-md">
                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-diary" class="font-medium text-gray-700 dark:text-gray-200">Hiá»‡n "My
                                Diary"</label>
                            <input type="checkbox" id="toggle-diary"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-research" class="font-medium text-gray-700 dark:text-gray-200">Hiá»‡n
                                "My Blog"</label>
                            <input type="checkbox" id="toggle-research"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>

                        <div class="flex items-center justify-between p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg">
                            <label for="toggle-badminton" class="font-medium text-gray-700 dark:text-gray-200">Hiá»‡n
                                "B Scheduler"</label>
                            <input type="checkbox" id="toggle-badminton"
                                class="form-checkbox h-6 w-6 text-amber-500 rounded focus:ring-amber-500" />
                        </div>
                    </div>
                </div>
        </main>
    </div>

    </div>
    </main>
    </div>
    <footer class="text-center py-4 mt-8 relative">
        <p class="text-base text-gray-500 dark:text-gray-400">
            Thá»i Ä‘áº¡i AI Ä‘ang Ä‘áº¿n!!!! <br>
            Táº¥t cáº£ má»i thá»© á»Ÿ Ä‘Ã¢y Ä‘á»u Ä‘Æ°á»£c táº¡o báº±ng Gemini.
        </p>
        <div class="absolute right-4 bottom-4 hidden sm:block">
            <p id="visit-counter" class="text-xs text-gray-400 dark:text-gray-500 text-right">
                LÆ°á»£t truy cáº­p: Äang táº£i...
            </p>
        </div>
    </footer>
    <div id="role-selection-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
        <div class="p-8 rounded-lg shadow-xl w-full max-w-sm glass-effect">
            <h3 class="text-3xl font-extrabold text-center mb-6 text-pink-600 dark:text-pink-400">TRá»œI Æ I, Báº N Tá»šI Rá»’I!
                ğŸ‰</h3>
            <p class="text-center mb-8 text-gray-100 dark:text-gray-100">Báº¡n lÃ  fan Manchester United hay fan Ä‘á»™i khÃ¡c
                Fan Ä‘á»™i khÃ¡c?</p>
            <div class="flex flex-col space-y-4">
                <button id="select-role-admin"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40">
                    Manchester United
                </button>
                <button id="select-role-guest"
                    class="w-full bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg transition duration-300">
                    Fan Ä‘á»™i khÃ¡c???
                </button>
            </div>
        </div>
    </div>
    <div id="blog-editor-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden p-4">
        <div class="w-full max-w-4xl max-h-[90vh] flex flex-col bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-6 text-amber-600 dark:text-amber-400">Soáº¡n tháº£o bÃ i viáº¿t</h3>
            <div class="space-y-4 overflow-y-auto pr-2">
                <div>
                    <label for="blog-editor-title" class="block font-medium mb-1 dark:text-gray-300">TiÃªu Ä‘á»:</label>
                    <input type="text" id="blog-editor-title"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                </div>
                <div>
                    <label for="blog-editor-tags" class="block font-medium mb-1 dark:text-gray-300">Hashtags:</label>
                    <input type="text" id="blog-editor-tags" placeholder="VÃ­ dá»¥: excel, vba, ai"
                        class="w-full p-2 bg-gray-50/50 dark:bg-gray-700/50 border border-gray-300/50 dark:border-gray-600/50 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">CÃ¡ch nhau báº±ng dáº¥u pháº©y (,)</p>
                </div>
                <div>
                    <label class="block font-medium mb-1 dark:text-gray-300">Ná»™i dung:</label>
                    <textarea id="blog-editor-textarea"></textarea>
                </div>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-300/50 dark:border-gray-600/50">
                <button id="blog-editor-save-btn"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-green-500/50">LÆ°u
                    bÃ i viáº¿t</button>
                <button id="blog-editor-cancel-btn"
                    class="flex-1 bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-2 px-6 rounded-lg transition duration-300">Há»§y</button>
                <input type="hidden" id="blog-editor-post-id">
            </div>
        </div>
    </div>
    <div id="blog-reader-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 hidden p-4">
        <div id="blog-reader-content"
            class="w-11/12 h-[90vh] flex flex-col bg-white dark:bg-slate-800 rounded-lg shadow-2xl overflow-hidden">
            <header class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700 overflow-y-auto">
                <h2 id="blog-reader-title" class="text-3xl font-bold text-amber-600 dark:text-amber-400">
                    ÄÃ¢y lÃ  TiÃªu Ä‘á» BÃ i viáº¿t
                </h2>
                <div id="blog-reader-tags" class="flex flex-wrap gap-2 mt-4">
                </div>
            </header>
            <article class="flex-1 p-6 overflow-y-auto">
                <div id="blog-reader-body" class="prose dark:prose-invert max-w-none">
                </div>
            </article>
            <footer
                class="flex-shrink-0 p-4 bg-gray-50 dark:bg-slate-900 border-t border-gray-200 dark:border-gray-700">
                <button id="blog-reader-close-btn"
                    class="w-full sm:w-auto bg-gray-200/50 dark:bg-gray-700/50 hover:bg-gray-300/70 dark:hover:bg-gray-600/70 text-gray-700 dark:text-gray-300 font-bold py-3 px-8 rounded-lg transition duration-300">
                    ÄÃ³ng
                </button>
            </footer>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Initialization (CÅ¨ Cá»¦A BA) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCG_OqnwjNTg3kfCUmEkxo-qrJTMMsyhqk",
                authDomain: "my-toolbox-downloads.firebaseapp.com",
                projectId: "my-toolbox-downloads",
                storageBucket: "my-toolbox-downloads.appspot.com",
                messagingSenderId: "723884147235",
                appId: "1:723884147235:web:d08241abfd477d91c2e796"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            let globalTabSettings = { show_diary: false, show_research: false, show_badminton: false };
            const settingsRef = db.collection("settings").doc("tab_visibility");

            const storage = firebase.storage();
            // === CODE AUTH Cá»¦A Má»  (Báº¢O Máº¬T + Sá»¬A Lá»–I) ===
            const auth = firebase.auth();
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); // <<< DÃ’NG Má»  THÃŠM VÃ€O ÄÃ‚Y
            const modal = document.getElementById('role-selection-modal');
            const selectGuestBtn = document.getElementById('select-role-guest');
            const selectAdminBtn = document.getElementById('select-role-admin');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            // (Tá»± Ä‘á»™ng láº¯ng nghe thay Ä‘á»•i tá»« Firestore)
            settingsRef.onSnapshot((doc) => {
                if (doc.exists) {
                    globalTabSettings = doc.data();
                } else {
                    // Náº¿u chÆ°a cÃ³, tá»± táº¡o file cÃ i Ä‘áº·t máº·c Ä‘á»‹nh (áº©n háº¿t)
                    settingsRef.set(globalTabSettings).catch(e => console.error("Lá»—i táº¡o settings:", e));
                }
                console.log("CÃ i Ä‘áº·t tab Ä‘Ã£ cáº­p nháº­t:", globalTabSettings);

                // Cháº¡y láº¡i hÃ m updateUI Ä‘á»ƒ Ã¡p dá»¥ng cÃ i Ä‘áº·t má»›i cho Guest
                const user = auth.currentUser;
                checkAdminStatus(user);
            }, (error) => {
                console.error("Lá»—i táº£i cÃ i Ä‘áº·t tab:", error);
            });
            // === HÃ€M "SIÃŠU TRÃ‚U BÃ’" (style.display) + NÃ‚NG Cáº¤P AUTONUMERIC + Báº¢O Máº¬T ===
            // === HÃ€M "SIÃŠU TRÃ‚U BÃ’" (style.display) + NÃ‚NG Cáº¤P AUTONUMERIC + Báº¢O Máº¬T ===
            // === HÃ€M Má»šI: CHUYÃŠN GIA KHÃ“A/Má» Lá»ŠCH ===
            function setCalendarInputsReadOnly(isReadOnly) {
                // 1. KhÃ³a/Má»Ÿ cÃ¡c Ã´ gÃµ tiá»n
                const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                inputs.forEach(input => {
                    if (input.autoNumericInstance) {
                        input.autoNumericInstance.options.readOnly(isReadOnly);
                    } else {
                        input.readOnly = isReadOnly;
                    }
                });

                // 2. KhÃ³a/Má»Ÿ cÃ¡c nÃºt 'â—'
                const toggles = calendarGrid.querySelectorAll('.day-toggle');
                toggles.forEach(toggle => {
                    toggle.disabled = isReadOnly;
                });
            }

            // === HÃ€M "SIÃŠU TRÃ‚U BÃ’" (style.display) + NÃ‚NG Cáº¤P AUTONUMERIC + Báº¢O Máº¬T ===
            function updateUI(user, isAdmin) {
                // === Má»  Bá»” SUNG 1: Äáº·t "biá»ƒn bÃ¡o" Admin toÃ n cá»¥c ===
                window.isAdmin = (user && isAdmin);
                // ===============================================
                const gView = document.getElementById('guest-view');
                const aView = document.getElementById('admin-view');
                const navD = document.getElementById('nav-my-diary');
                const navR = document.getElementById('nav-my-research');
                const navB = document.getElementById('nav-badminton-scheduler');
                const navAdmin = document.getElementById('nav-admin-panel');
                const addDepositInput = document.getElementById('badminton-add-deposit'); // Láº¥y Ã´ Ná»™p tiá»n
                const submitDepositBtn = document.getElementById('badminton-submit-deposit'); // <<< Má»  Láº¤Y THÃŠM NÃšT

                // (Báº£n vÃ¡ Ä‘áº§y Ä‘á»§)
                if (!gView || !aView || !navD || !navR || !navB || !navAdmin || !addDepositInput || !submitDepositBtn) { // <<< Má»  THÃŠM NÃšT VÃ€O CHECK
                    console.error("Lá»—i nghiÃªm trá»ng: KhÃ´ng tÃ¬m tháº¥y 1 trong cÃ¡c View UI!");
                    return;
                }

                // === Má»  "TÃI Cáº¤U TRÃšC" HÃ€M NÃ€Y ===

                // 1. Khá»Ÿi táº¡o AutoNumeric cho Ã´ "Ná»™p thÃªm" (1 Láº¦N DUY NHáº¤T)
                // (HÃ m nÃ y sáº½ tá»± cháº¡y 1 láº§n khi táº£i trang)
                if (addDepositInput && !addDepositInput.autoNumericInstance) {
                    const anInput = new AutoNumeric(addDepositInput, {
                        decimalCharacter: ',',
                        digitGroupSeparator: '.',
                        decimalPlaces: 0,
                        minimumValue: '-999999999',
                        maximumValue: '999999999',
                        // KhÃ´ng set readOnly á»Ÿ Ä‘Ã¢y, set á»Ÿ dÆ°á»›i
                    });
                    addDepositInput.autoNumericInstance = anInput;
                }


                if (user && isAdmin) {
                    // 1. LÃ€ ADMIN
                    gView.style.display = 'none';
                    aView.style.display = 'block';
                    navD.classList.remove('hidden');
                    navR.classList.remove('hidden');
                    navB.classList.remove('hidden');
                    navAdmin.classList.remove('hidden');
                    initializeAdminBlogFeatures();
                    setCalendarInputsReadOnly(false);

                    // 2. Báº­t Ã´ ná»™p tiá»n
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(false); // <<< Cho phÃ©p gÃµ
                    }
                    addDepositInput.placeholder = 'Ná»™p thÃªm...';
                    submitDepositBtn.disabled = false; // <<< Báº­t nÃºt [+]

                    // 3. Táº£i lá»‹ch (náº¿u chÆ°a)
                    // (Code nÃ y Ä‘Ã£ bá»‹ chuyá»ƒn qua hÃ m showTool, nhÆ°ng Admin váº«n cáº§n khá»Ÿi táº¡o láº§n Ä‘áº§u)
                    if (!window.calendarInitialized) {
                        loadFundData();
                        renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
                        window.calendarInitialized = true;
                    }

                    // 4. Set Avatar
                    const adminAvatar = document.getElementById('admin-avatar');
                    const adminName = document.getElementById('admin-name');
                    if (adminAvatar) adminAvatar.src = user.photoURL || 'images/favicon.png';
                    if (adminName) adminName.textContent = user.displayName || "ChÃ o Admin!";

                } else {
                    // 1. LÃ€ GUEST
                    gView.style.display = 'block';
                    aView.style.display = 'none';
                    setCalendarInputsReadOnly(true); // <<< DÃ’NG Má»šI (KHÃ“A Lá»ŠCH)

                    // 2. Táº¯t Ã´ ná»™p tiá»n
                    if (addDepositInput.autoNumericInstance) {
                        addDepositInput.autoNumericInstance.options.readOnly(true); // <<< KhÃ³a gÃµ
                        addDepositInput.autoNumericInstance.clear(); // XÃ³a sá»‘ (náº¿u lá»¡ gÃµ)
                    }
                    addDepositInput.placeholder = "Money doesn't grow on trees!"; // <<< Äá»•i chá»¯
                    submitDepositBtn.disabled = true; // <<< Táº¯t nÃºt [+]

                    // 3. áº¨n/Hiá»‡n Nav theo cÃ i Ä‘áº·t (Giá»¯ nguyÃªn)
                    navAdmin.classList.add('hidden');
                    if (globalTabSettings.show_diary) {
                        navD.classList.remove('hidden');
                    } else {
                        navD.classList.add('hidden');
                    }

                    if (globalTabSettings.show_research) {
                        navR.classList.remove('hidden');
                    } else {
                        navR.classList.add('hidden');
                    }

                    if (globalTabSettings.show_badminton) {
                        navB.classList.remove('hidden');
                    } else {
                        navB.classList.add('hidden');
                    }
                    if (user && !isAdmin) {
                        signOut();
                        alert("TÃ i khoáº£n nÃ y khÃ´ng cÃ³ quyá»n Admin!");
                    }

                    // === Sá»¬A Lá»–I LOGIC "QUÃ‰T PHÃ’NG" Náº°M á» ÄÃ‚Y ===

                    const currentHash = window.location.hash.substring(1);
                    const defaultTool = 'remove-bg'; // Trang an toÃ n

                    // 1. Táº¡o 1 danh sÃ¡ch cÃ¡c trang Bá»Š Cáº¤M (tá»©c lÃ  Ä‘ang áº¨N)
                    let forbiddenTools = ['admin-panel']; // 'admin-panel' luÃ´n cáº¥m
                    if (!globalTabSettings.show_diary) {
                        forbiddenTools.push('my-diary');
                    }
                    if (!globalTabSettings.show_research) {
                        forbiddenTools.push('my-research');
                    }
                    if (!globalTabSettings.show_badminton) {
                        forbiddenTools.push('badminton-scheduler');
                    }

                    // 2. Chá»‰ "Ä‘Ã¡" vá» trang chá»§ Náº¾U user Ä‘ang á»Ÿ 1 trang Bá»Š Cáº¤M
                    if (forbiddenTools.includes(currentHash)) {
                        console.warn("User Ä‘ang á»Ÿ trang bá»‹ cáº¥m (" + currentHash + "). ÄÃ¡ vá» trang chá»§...");
                        // Chuyá»ƒn link vá» trang an toÃ n
                        history.pushState({ toolId: defaultTool }, '', `#${defaultTool}`);
                        // Gá»i hÃ m showTool Ä‘á»ƒ "váº½" láº¡i trang an toÃ n
                        showTool(defaultTool);
                    }
                    // === Háº¾T PHáº¦N Sá»¬A Lá»–I ===
                }
            }


            // === THÃŠM HÃ€M Má»šI NÃ€Y ===
            function initializeAdminPanelToggles() {
                // Láº¥y 3 cÃ¡i nÃºt gáº¡t
                const toggleDiary = document.getElementById('toggle-diary');
                const toggleResearch = document.getElementById('toggle-research');
                const toggleBadminton = document.getElementById('toggle-badminton');

                // (ThoÃ¡t náº¿u lá»¡ gá»i hÃ m mÃ  chÆ°a á»Ÿ Ä‘Ãºng tab)
                if (!toggleDiary) return;

                console.log("Khá»Ÿi táº¡o Admin Panel Toggles...");

                // 1. Äáº·t tráº¡ng thÃ¡i 'checked' theo cÃ i Ä‘áº·t Ä‘Ã£ táº£i
                toggleDiary.checked = globalTabSettings.show_diary;
                toggleResearch.checked = globalTabSettings.show_research;
                toggleBadminton.checked = globalTabSettings.show_badminton;

                // 2. Gáº¯n sá»± kiá»‡n 'change' Ä‘á»ƒ lÆ°u lÃªn Firestore
                // (DÃ¹ng .hasListener Ä‘á»ƒ trÃ¡nh gáº¯n 2-3 láº§n)
                if (!toggleDiary.hasListener) {
                    toggleDiary.addEventListener('change', () => {
                        settingsRef.update({ show_diary: toggleDiary.checked })
                            .catch(e => alert("Lá»—i cáº­p nháº­t Diary: " + e.message));
                    });
                    toggleDiary.hasListener = true;
                }

                if (!toggleResearch.hasListener) {
                    toggleResearch.addEventListener('change', () => {
                        settingsRef.update({ show_research: toggleResearch.checked })
                            .catch(e => alert("Lá»—i cáº­p nháº­t Research: " + e.message));
                    });
                    toggleResearch.hasListener = true;
                }

                if (!toggleBadminton.hasListener) {
                    toggleBadminton.addEventListener('change', () => {
                        settingsRef.update({ show_badminton: toggleBadminton.checked })
                            .catch(e => alert("Lá»—i cáº­p nháº­t Badminton: " + e.message));
                    });
                    toggleBadminton.hasListener = true;
                }
            }
            // === Háº¾T HÃ€M Má»šI ===
            // === HÃ€M CHECK ADMIN (Há»I FIRESTORE) ===
            async function checkAdminStatus(user) {
                if (!user) {
                    updateUI(null, false);
                    return;
                }
                try {
                    const adminDocRef = db.collection("admins").doc(user.email);
                    const adminDoc = await adminDocRef.get();
                    if (adminDoc.exists) {
                        console.log("Admin Ä‘Ã£ Ä‘Äƒng nháº­p:", user.email);
                        updateUI(user, true);
                    } else {
                        console.log("User láº¡ Ä‘Äƒng nháº­p, khÃ´ng cÃ³ quyá»n:", user.email);
                        updateUI(user, false);
                    }
                } catch (error) {
                    console.error("Lá»—i khi check admin:", error);
                    updateUI(user, false);
                }
            }
            // === CÃC HÃ€M Xá»¬ LÃ AUTH (GIá»® NGUYÃŠN) ===
            auth.onAuthStateChanged((user) => {
                const role = localStorage.getItem('userRole');
                if (user) {
                    checkAdminStatus(user);
                } else {
                    updateUI(null, false);
                    if (!role) {
                        modal.classList.add('show');
                    }
                }
            });
            function signInWithGoogle() {
                auth.signInWithPopup(provider)
                    .then((result) => {
                        localStorage.setItem('userRole', 'admin');
                    })
                    .catch((error) => {
                        console.error("Lá»—i Ä‘Äƒng nháº­p:", error);
                        if (error.code === 'auth/popup-blocked-by-browser') {
                            alert("TrÃ¬nh duyá»‡t Ä‘Ã£ cháº·n cá»­a sá»• Ä‘Äƒng nháº­p. Ba vui lÃ²ng cho phÃ©p pop-up cho trang nÃ y nha!");
                        } else if (error.code === 'auth/unauthorized-domain') {
                            alert("Lá»—i: TÃªn miá»n nÃ y chÆ°a Ä‘Æ°á»£c Ä‘Äƒng kÃ½ vá»›i Firebase!");
                        }
                    });
            }
            function signOut() {
                auth.signOut()
                    .then(() => {
                        console.log("ÄÃ£ Ä‘Äƒng xuáº¥t.");
                        localStorage.setItem('userRole', 'guest');
                    })
                    .catch((error) => {
                        console.error("Lá»—i Ä‘Äƒng xuáº¥t:", error);
                    });
            }
            // === GÃN Sá»° KIá»†N CHO CÃC NÃšT AUTH ===
            selectGuestBtn.addEventListener('click', () => {
                localStorage.setItem('userRole', 'guest');
                modal.classList.remove('show');
            });
            selectAdminBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                signInWithGoogle();
            });
            adminLoginBtn.addEventListener('click', () => {
                signInWithGoogle();
            });
            adminLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                signOut();
            });






            /* ============================================================
            === Bá»˜ NÃƒO BLOG "MY RESEARCH" (GÄ 6 - "Káº¾ TOÃN" PRO) ===
            ===       (Báº£n "Tá»”NG Vá»† SINH" - Fix má»i lá»—i)               ===
            ============================================================
            */
            // --- 1. Khai bÃ¡o biáº¿n toÃ n cá»¥c cho Blog ---
            const blogPostsRef = db.collection("blog_posts");
            // "Sá»” Káº¾ TOÃN" Cá»¦A BA CON MÃŒNH
            const blogMetadataRef = db.collection("blog_metadata").doc("stats");

            const blogAdminControls = document.getElementById('blog-admin-controls');
            const blogCreateNewBtn = document.getElementById('blog-create-new-btn');
            const blogPostsList = document.getElementById('blog-posts-list');
            const blogLoadingState = document.getElementById('blog-loading-state');
            const blogEmptyState = document.getElementById('blog-empty-state');
            const blogEditorModal = document.getElementById('blog-editor-modal');
            const blogEditorTitle = document.getElementById('blog-editor-title');
            const blogEditorTags = document.getElementById('blog-editor-tags');
            const blogEditorTextarea = document.getElementById('blog-editor-textarea');
            const blogEditorSaveBtn = document.getElementById('blog-editor-save-btn');
            const blogEditorCancelBtn = document.getElementById('blog-editor-cancel-btn');
            const blogEditorPostId = document.getElementById('blog-editor-post-id');
            // Biáº¿n cho Cá»¬A Sá»” Äá»ŒC (READER MODAL)
            const blogReaderModal = document.getElementById('blog-reader-modal');
            const blogReaderBody = document.getElementById('blog-reader-body');
            // === Má»  THÃŠM 3 "TAY" Má»šI ===
            const blogReaderArticle = document.querySelector('#blog-reader-content article'); // "TAY" Gáº®N NÃšT
            let stickyCloseButton = null; // "TAY" ÄIá»€U KHIá»‚N NÃšT
            let blogObserver = null; // "Máº®T THáº¦N"
            // === Háº¾T ===
            const blogReaderCloseBtn = document.getElementById('blog-reader-close-btn');
            let isBlogInitialized = false;
            // BIáº¾N TOÃ€N Cá»¤C CHO PHÃ‚N TRANG (PAGINATION)
            const blogPaginationControls = document.getElementById('blog-pagination-controls');
            const blogPrevBtn = document.getElementById('blog-prev-btn');
            const blogNextBtn = document.getElementById('blog-next-btn');
            const blogPageIndicator = document.getElementById('blog-page-indicator');
            let blogPageSize = 5; // Ba muá»‘n 5 hay 10 thÃ¬ sá»­a sá»‘ nÃ y
            let blogCurrentPage = 1;
            let blogTotalPages = 1;
            let blogTotalPosts = 0;
            let blogPageMocks = [null]; // Máº£ng "má»‘c" (dáº¥u trang)
            let isLoadingBlog = false;
            // === "Bá»˜ NÃƒO MÃ€U" Cá»¦A Má»  (DÃ™NG CHO HASHTAG) ===
            // 1. "Báº£ng MÃ u" 10 mÃ u (Ba Æ°ng mÃ u nÃ o thÃ¬ sá»­a code Tailwind á»Ÿ Ä‘Ã¢y)
            // 1. "Báº£ng MÃ u" 10 mÃ u (Ba Æ°ng mÃ u nÃ o thÃ¬ sá»­a code Tailwind á»Ÿ Ä‘Ã¢y)
            // 1. "Báº£ng MÃ u" 10 mÃ u (Ba Æ°ng mÃ u nÃ o thÃ¬ sá»­a code Tailwind á»Ÿ Ä‘Ã¢y)
            // 1. "Báº£ng MÃ u" 10 mÃ u (Ba Æ°ng mÃ u nÃ o thÃ¬ sá»­a code Tailwind á»Ÿ Ä‘Ã¢y)
            const tagColorPalette = [
                // [Ná»n SÃ¡ng, Chá»¯ SÃ¡ng], [Ná»n Tá»‘i (700), Chá»¯ Tá»‘i (200)] - ÄÃƒ Sá»¬A Dá»ŠU Máº®T
                ['bg-red-200', 'text-red-900', 'dark:bg-red-700', 'dark:text-red-200'],
                ['bg-amber-200', 'text-amber-900', 'dark:bg-amber-700', 'dark:text-amber-200'],
                ['bg-green-200', 'text-green-900', 'dark:bg-green-700', 'dark:text-green-200'],
                ['bg-blue-200', 'text-blue-900', 'dark:bg-blue-700', 'dark:text-blue-200'],
                ['bg-indigo-200', 'text-indigo-900', 'dark:bg-indigo-700', 'dark:text-indigo-200'],
                ['bg-purple-200', 'text-purple-900', 'dark:bg-purple-700', 'dark:text-purple-200'],
                ['bg-pink-200', 'text-pink-900', 'dark:bg-pink-700', 'dark:text-pink-200'],
                ['bg-sky-200', 'text-sky-900', 'dark:bg-sky-700', 'dark:text-sky-200'],
                ['bg-teal-200', 'text-teal-900', 'dark:bg-teal-700', 'dark:text-teal-200'],
                ['bg-orange-200', 'text-orange-900', 'dark:bg-orange-700', 'dark:text-orange-200']
            ];
            // 2. "Bá»™ nÃ£o" "bÄƒm" chá»¯ thÃ nh sá»‘ (Ä‘á»ƒ bá»‘c mÃ u)
            function getStringHash(str) {
                let hash = 0;
                if (str.length === 0) return hash;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return Math.abs(hash); // Tráº£ vá» sá»‘ dÆ°Æ¡ng
            }
            // 3. HÃ m "bá»‘c" mÃ u (tráº£ vá» 4 class)
            function getTagColorClasses(tagName) {
                const hash = getStringHash(tagName);
                const index = hash % tagColorPalette.length; // Láº¥y sá»‘ dÆ° (0-9)
                const colors = tagColorPalette[index];
                return `${colors[0]} ${colors[1]} ${colors[2]} ${colors[3]}`; // Tráº£ vá» 4 class, vÃ­ dá»¥: "bg-red-200 text-red-900 dark:bg-red-700 dark:text-red-100"
            }
            // === Háº¾T "Bá»˜ NÃƒO MÃ€U" ===

            // --- HÃ€M "Äáº¦U TÃ€U": Láº¬T "Sá»” Káº¾ TOÃN" (Háº¾T Lá»–I .count()) ---
            async function loadBlogPosts() {
                if (isLoadingBlog) return;
                isLoadingBlog = true;
                blogLoadingState.classList.remove('hidden');
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    // 1. Láº­t "Sá»• Káº¿ toÃ¡n"
                    const metaDoc = await blogMetadataRef.get();
                    if (metaDoc.exists) {
                        blogTotalPosts = metaDoc.data().totalPosts || 0;
                    } else {
                        blogTotalPosts = 0; // Náº¿u sá»• khÃ´ng cÃ³, coi nhÆ° lÃ  0
                    }

                    if (blogTotalPosts === 0) {
                        blogLoadingState.classList.add('hidden');
                        blogEmptyState.classList.remove('hidden');
                        isLoadingBlog = false;
                        return;
                    }
                    // 2. TÃ­nh toÃ¡n
                    blogTotalPages = Math.ceil(blogTotalPosts / blogPageSize);
                    blogCurrentPage = 1;
                    blogPageMocks = [null]; // Reset máº£ng "má»‘c"
                    // 3. Táº£i trang Ä‘áº§u tiÃªn
                    await fetchBlogPage(); // Táº£i trang 1
                } catch (error) {
                    console.error("Lá»—i khi láº­t 'Sá»• Káº¿ toÃ¡n':", error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = "<p class='text-center text-red-500'>\"KhÃ´ng thá»ƒ Ä‘á»c 'Sá»• Káº¿ toÃ¡n'. ÄÃ£ cÃ³ lá»—i.\"</p>";
                } finally {
                    isLoadingBlog = false;
                }
            }

            // --- HÃ€M "Cá»T LÃ•I" 1: Táº¢I BÃ€I VIáº¾T THEO TRANG ---
            async function fetchBlogPage() {
                blogLoadingState.classList.remove('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden');
                try {
                    const startAfterMoc = blogPageMocks[blogCurrentPage - 1];
                    let query = blogPostsRef.orderBy("createdAt", "desc");
                    if (startAfterMoc) {
                        query = query.startAfter(startAfterMoc);
                    }
                    query = query.limit(blogPageSize);
                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden');
                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        return;
                    }
                    // "Váº½" 5 bÃ i viáº¿t
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'BÃ i viáº¿t khÃ´ng cÃ³ tiÃªu Ä‘á»';
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);
                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN');
                        postCard.appendChild(dateEl);
                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(BÃ i viáº¿t nÃ y chÆ°a cÃ³ tÃ³m táº¯t...)';
                        postCard.appendChild(summaryEl);
                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "Bá»C MÃ€U HÃ€NG HIá»†U" Cá»¦A Má» !
                                const colorClasses = getTagColorClasses(tag);
                                // "MÆ°á»£n" thÃªm máº¥y cÃ¡i class cÆ¡ báº£n
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trá»™n" láº¡i!
                                return `<span class="${baseClasses} ${colorClasses}">
        ${tag}
    </span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }
                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                            <div class="mt-4 flex gap-2">
                                <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sá»­a]</button>
                                <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[XÃ³a]</button>
                            </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });
                    // LÆ¯U "Má»C" (dáº¥u trang)
                    const lastDoc = querySnapshot.docs[querySnapshot.docs.length - 1];
                    blogPageMocks[blogCurrentPage] = lastDoc;
                    updatePaginationUI();
                } catch (error) {
                    console.error("Lá»—i khi táº£i trang " + blogCurrentPage, error);
                    blogLoadingState.classList.add('hidden');
                    blogPostsList.innerHTML = '<p class="text-center text-red-500">Táº£i trang tháº¥t báº¡i.</p>';
                } finally {
                    blogPaginationControls.classList.remove('hidden');
                }
            }

            // --- HÃ€M "Cá»T LÃ•I" 2: Cáº¬P NHáº¬T NÃšT Báº¤M (UI) ---
            function updatePaginationUI() {
                blogPageIndicator.textContent = `Trang ${blogCurrentPage} / ${blogTotalPages}`;
                blogPrevBtn.disabled = (blogCurrentPage === 1);
                blogNextBtn.disabled = (blogCurrentPage === blogTotalPages);
            }

            // --- HÃ€M Má» "PHÃ’NG SOáº N THáº¢O" (TinyMCE) ---
            function openBlogEditor(postData = null) {
                blogEditorTitle.value = '';
                blogEditorTags.value = '';
                blogEditorPostId.value = '';
                if (tinymce.get('blog-editor-textarea')) {
                    tinymce.get('blog-editor-textarea').destroy();
                }
                tinymce.init({
                    selector: '#blog-editor-textarea',
                    license_key: 'gpl',
                    plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount fullscreen',
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat | fullscreen',
                    // === MÃƒ Má»šI: Ã‰P THEME KINDLE E-INK ===
                    skin: 'oxide', // 1. Ã‰p giao diá»‡n (toolbar) luÃ´n lÃ  SÃ¡ng
                    content_css: false, // 2. VÃ´ hiá»‡u hÃ³a CSS "dark"/"default" cá»§a TinyMCE
                    content_style: `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* 3. Táº£i Google Font (giá»‘ng há»‡t file index.html) */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* 4. Ãp dá»¥ng ná»n giáº¥y vÃ  chá»¯ xÃ¡m Ä‘en */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  background-color: #FBF8F0 !important; /* Ná»n giáº¥y E-Ink */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: #333333 !important; /* Chá»¯ xÃ¡m Ä‘en má»m */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif !important; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  line-height: 1.8 !important; /* DÃ£n dÃ²ng 1.8 cho dá»… viáº¿t */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* 5. Sá»­a mÃ u link cho Ä‘á»“ng bá»™ */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: #0056b3 !important;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text-decoration: underline !important;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `,
                    // === Háº¾T MÃƒ Má»šI ===
                    height: 400,
                    file_picker_types: 'image media',
                    file_picker_callback: (cb, value, meta) => {
                        const input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        if (meta.filetype === 'image') { input.setAttribute('accept', 'image/*'); }
                        else if (meta.filetype === 'media') { input.setAttribute('accept', 'audio/*,video/*'); }
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const storageRef = storage.ref();
                            const fileName = `blog_assets/${new Date().getTime()}_${file.name}`;
                            const fileRef = storageRef.child(fileName);
                            const uploadTask = fileRef.put(file);
                            uploadTask.on('state_changed',
                                (snapshot) => { console.log('Äang táº£i lÃªn: ' + snapshot.bytesTransferred + ' / ' + snapshot.totalBytes); },
                                (error) => { console.error("Lá»—i táº£i file lÃªn Storage:", error); alert("Táº£i file tháº¥t báº¡i: " + error.message); },
                                () => {
                                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                        console.log('Táº£i file thÃ nh cÃ´ng:', downloadURL);
                                        cb(downloadURL, { title: file.name });
                                    });
                                }
                            );
                        });
                        input.click();
                    }
                }).then(() => {
                    if (postData) {
                        blogEditorTitle.value = postData.title;
                        blogEditorTags.value = postData.tags ? postData.tags.join(', ') : '';
                        tinymce.get('blog-editor-textarea').setContent(postData.content);
                        blogEditorPostId.value = postData.id;
                    } else {
                        tinymce.get('blog-editor-textarea').setContent('<p>Ba gÃµ ná»™i dung vÃ o Ä‘Ã¢y...</p>');
                    }
                });
                blogEditorModal.classList.remove('hidden');
            }

            // --- HÃ€M LÆ¯U BÃ€I (GHI VÃ€O "Sá»” Káº¾ TOÃN") ---
            async function saveBlogPost() {
                const title = blogEditorTitle.value.trim();
                const content = tinymce.get('blog-editor-textarea').getContent();
                const tagsString = blogEditorTags.value.trim();
                const postId = blogEditorPostId.value;
                if (!title || !content) {
                    alert("Ba Æ¡i, ba pháº£i gÃµ TiÃªu Ä‘á» vÃ  Ná»™i dung chá»©!");
                    return;
                }
                // Táº¡o TÃ³m táº¯t
                let summary = tinymce.get('blog-editor-textarea').getContent({ format: 'text' });
                summary = summary.replace(/\s+/g, ' ').trim();
                if (summary.length > 200) {
                    summary = summary.substring(0, 200) + '...';
                } else if (summary.length === 0 && content.length > 0) {
                    summary = '[BÃ i viáº¿t chá»©a ná»™i dung Ä‘a phÆ°Æ¡ng tiá»‡n...]';
                }
                const tagsArray = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                blogEditorSaveBtn.disabled = true;
                blogEditorSaveBtn.textContent = 'Äang lÆ°u...';
                try {
                    const postData = {
                        title: title,
                        content: content,
                        summary: summary,
                        tags: tagsArray,
                    };

                    // Báº¯t Ä‘áº§u "Giao dá»‹ch" (batch)
                    const batch = db.batch();

                    if (postId) {
                        // Sá»¬A BÃ€I (KhÃ´ng Ä‘á»¥ng tá»›i sá»• Káº¿ toÃ¡n)
                        postData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        const postRef = blogPostsRef.doc(postId);
                        batch.update(postRef, postData);
                        console.log("ÄÃ£ cáº­p nháº­t bÃ i viáº¿t:", postId);
                    } else {
                        // Táº O BÃ€I Má»šI (Pháº£i +1 vÃ´ sá»•)
                        postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        postData.authorId = auth.currentUser.uid;
                        const newPostRef = blogPostsRef.doc(); // Táº¡o 1 ref má»›i
                        batch.set(newPostRef, postData); // 1. LÆ°u bÃ i viáº¿t
                        // 2. "Ghi sá»•" (+1)
                        batch.set(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                        console.log("ÄÃ£ táº¡o bÃ i viáº¿t má»›i!");
                    }

                    await batch.commit(); // Cháº¡y "Giao dá»‹ch"

                    blogEditorModal.classList.add('hidden');
                    tinymce.get('blog-editor-textarea').destroy();
                    loadBlogPosts(); // Táº£i láº¡i (Reset)
                } catch (error) {
                    console.error("Lá»—i khi lÆ°u bÃ i viáº¿t:", error);
                    alert("LÆ°u bÃ i tháº¥t báº¡i: " + error.message);
                } finally {
                    blogEditorSaveBtn.disabled = false;
                    blogEditorSaveBtn.textContent = 'LÆ°u bÃ i viáº¿t';
                }
            }

            // --- HÃ€M XÃ“A BÃ€I (TRá»ª "Sá»” Káº¾ TOÃN") ---
            async function deleteBlogPost(postId, postTitle) {
                if (!confirm(`Ba cÃ³ cháº¯c cháº¯n muá»‘n XÃ“A bÃ i viáº¿t "${postTitle}" khÃ´ng?`)) {
                    return;
                }
                try {
                    // Báº¯t Ä‘áº§u "Giao dá»‹ch"
                    const batch = db.batch();
                    // 1. XÃ³a bÃ i
                    const postRef = blogPostsRef.doc(postId);
                    batch.delete(postRef);
                    // 2. "Ghi sá»•" (-1)
                    batch.update(blogMetadataRef, { totalPosts: firebase.firestore.FieldValue.increment(-1) });

                    await batch.commit(); // Cháº¡y "Giao dá»‹ch"

                    console.log("ÄÃ£ xÃ³a bÃ i viáº¿t vÃ  cáº­p nháº­t sá»•:", postId);
                    loadBlogPosts(); // Táº£i láº¡i (Reset)
                } catch (error) {
                    console.error("Lá»—i khi xÃ³a bÃ i viáº¿t:", error);
                    alert("XÃ³a bÃ i tháº¥t báº¡i: " + error.message);
                }
            }

            // === HÃ€M "Äáº I PHáºªU THUáº¬T" V5 ("Máº®T THáº¦N") ===
            function openReaderModal(postData) {
                if (!blogReaderModal || !blogReaderBody || !blogReaderArticle) {
                    console.error("Lá»—i: Máº¥t bá»™ pháº­n Cá»­a sá»• Ä‘á»c (V5)!");
                    return;
                }

                // 1. "Gá»˜P" TiÃªu Ä‘á» vÃ  Tags (Giá»¯ nguyÃªn)
                let tagsHTML = '';
                if (postData.tags && postData.tags.length > 0) {
                    tagsHTML = postData.tags.map(tag => {
                        // "Bá»C MÃ€U HÃ€NG HIá»†U" Cá»¦A Má» !
                        const colorClasses = getTagColorClasses(tag);
                        // "MÆ°á»£n" thÃªm máº¥y cÃ¡i class cÆ¡ báº£n
                        const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                        // "Trá»™n" láº¡i!
                        return `<span class="${baseClasses} ${colorClasses}">
                ${tag}
            </span>`;
                    }).join(' ');
                }
                const headerHTML = `
        <div class="in-article-header">
            <h2 class="in-article-title">${postData.title || 'BÃ i viáº¿t khÃ´ng cÃ³ tiÃªu Ä‘á»'}</h2>
            <div class="in-article-tags">
                ${tagsHTML || 'ChÆ°a gáº¯n tag'}
            </div>
        </div>
    `;

                // 2. "BÆ M" (Gá»™p header + ná»™i dung + "Máº®T THáº¦N")
                blogReaderBody.innerHTML = headerHTML +
                    (postData.content || '<p>Ná»™i dung Ä‘ang cáº­p nháº­t...</p>') +
                    '<div class="article-end-sentinel"></div>'; // Gáº¯n "Máº¯t tháº§n" á»Ÿ Ä‘Ã¡y

                // 3. Táº O NÃšT "ÄÃ“NG" (Chá»‰ 1 láº§n duy nháº¥t)
                if (!stickyCloseButton) {
                    console.log("Táº¡o nÃºt 'ÄÃ³ng' lÆ¡ lá»­ng (1 láº§n)");
                    stickyCloseButton = document.createElement('button');
                    stickyCloseButton.className = 'sticky-close-btn-injected'; // Gá»i CSS "V5"
                    stickyCloseButton.textContent = 'ÄÃ³ng';

                    // "Gáº¯n" nÃºt "ÄÃ³ng" vÃ o khu vá»±c cuá»™n (Article)
                    blogReaderArticle.appendChild(stickyCloseButton);

                    // Gáº¯n "dÃ¢y Ä‘iá»‡n" Há»¦Y DIá»†T cho nÃºt
                    stickyCloseButton.addEventListener('click', () => {
                        blogReaderModal.classList.add('hidden'); // ÄÃ³ng cá»­a sá»•
                        stickyCloseButton.classList.remove('show'); // Tá»± "tÃ ng hÃ¬nh"
                        if (blogObserver) blogObserver.disconnect(); // Táº¯t "máº¯t tháº§n"
                        blogReaderBody.innerHTML = ''; // XÃ³a bÃ i viáº¿t
                    });
                }

                // 4. RESET (Báº¯t buá»™c pháº£i reset)
                // DÃ¹ng setTimeout(..., 0) Ä‘á»ƒ "Ã©p" lá»‡nh cuá»™n cháº¡y SAU KHI
                // trÃ¬nh duyá»‡t Ä‘Ã£ "váº½" xong ná»™i dung bÃ i viáº¿t má»›i.
                setTimeout(() => {
                    blogReaderArticle.scrollTop = 0;
                }, 0);

                stickyCloseButton.classList.remove('show'); // áº¨n nÃºt "ÄÃ³ng"

                // 5. Gáº®N DÃ‚Y ÄIá»†N "Máº®T THáº¦N" (Chá»‰ 1 láº§n)
                if (!blogObserver) {
                    console.log("Khá»Ÿi Ä‘á»™ng 'Máº¯t tháº§n' (1 láº§n)");
                    const options = {
                        root: blogReaderArticle, // "Máº¯t tháº§n" nhÃ¬n bÃªn trong khu "Article"
                        rootMargin: '0px 0px 0px 0px',
                        threshold: 0.1 // Tháº¥y 10% lÃ  "la lÃ ng"
                    };
                    blogObserver = new IntersectionObserver(handleObserver, options);
                }
                // (Báº¯t "Máº¯t tháº§n" "canh" cÃ¡i Ä‘Ã¡y bÃ i)
                const sentinel = blogReaderBody.querySelector('.article-end-sentinel');
                if (sentinel) blogObserver.observe(sentinel);

                // 6. Gáº®N DÃ‚Y ÄIá»†N TAG (Giá»¯ nguyÃªn)
                if (!blogReaderBody.hasTagListener) {
                    blogReaderBody.addEventListener('click', (e) => {
                        if (e.target.classList.contains('blog-tag-link')) {
                            const tagName = e.target.textContent.trim();
                            blogReaderModal.classList.add('hidden');
                            stickyCloseButton.classList.remove('show');
                            if (blogObserver) blogObserver.disconnect();
                            fetchBlogPostsByTag(tagName); // Lá»c
                        }
                    });
                    blogReaderBody.hasTagListener = true;
                }

                // 7. Má»Ÿ Cá»­a sá»•!
                blogReaderModal.classList.remove('hidden');
            }




            // === HÃ€M Má»šI (Lá»ŒC THEO TAG - Cáº¦N INDEX!) ===
            async function fetchBlogPostsByTag(tagName) {
                console.log(`Äang lá»c bÃ i viáº¿t theo tag: "${tagName}"...`);

                // 1. Dá»n dáº¹p giao diá»‡n
                blogLoadingState.classList.remove('hidden'); // Báº­t "Äang táº£i..."
                blogEmptyState.classList.add('hidden');
                blogPostsList.innerHTML = '';
                blogPaginationControls.classList.add('hidden'); // áº¨n phÃ¢n trang

                // 2. Táº¡o giao diá»‡n "Äang lá»c"
                const filterStatusEl = document.createElement('div');
                filterStatusEl.id = 'blog-filter-status'; // (Má»¡ thÃªm ID Ä‘á»ƒ xÃ³a)
                filterStatusEl.className = 'p-4 bg-amber-100 dark:bg-amber-900/50 rounded-lg mb-6 flex justify-between items-center';
                filterStatusEl.innerHTML = `
        <span class="font-medium text-amber-800 dark:text-amber-200">
            Äang lá»c theo tag: <strong class="text-lg">${tagName}</strong>
        </span>
        <button id="blog-clear-filter-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg">
            &times; XÃ³a bá»™ lá»c
        </button>
    `;
                // ChÃ¨n vÃ o *trÆ°á»›c* danh sÃ¡ch bÃ i viáº¿t
                blogPostsList.before(filterStatusEl);

                // Gáº¯n sá»± kiá»‡n cho nÃºt "XÃ³a bá»™ lá»c"
                document.getElementById('blog-clear-filter-btn').addEventListener('click', () => {
                    filterStatusEl.remove(); // XÃ³a cÃ¡i thanh "Äang lá»c"
                    blogEmptyState.textContent = 'ChÆ°a cÃ³ bÃ i viáº¿t nÃ o.'; // (Tráº£ láº¡i chá»¯ cÅ©)
                    loadBlogPosts(); // Táº£i láº¡i nhÆ° cÅ©
                });

                // 3. Truy váº¥n Firestore (Cáº§n Index!)
                try {
                    const query = blogPostsRef
                        .where("tags", "array-contains", tagName) // <-- CHIÃŠU "PRO" LÃ€ ÄÃ‚Y!
                        .orderBy("createdAt", "desc");

                    const querySnapshot = await query.get();
                    blogLoadingState.classList.add('hidden'); // Táº¯t "Äang táº£i..."

                    if (querySnapshot.empty) {
                        blogEmptyState.classList.remove('hidden');
                        // (Äá»•i chá»¯ cho ba dá»… biáº¿t)
                        blogEmptyState.textContent = `KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t nÃ o cÃ³ tag "${tagName}".`;
                        return;
                    }

                    // 4. "Váº½" káº¿t quáº£ (Copy y chang hÃ m fetchBlogPage)
                    querySnapshot.forEach((doc) => {
                        const postData = doc.data();
                        const postId = doc.id;
                        const postCard = document.createElement('div');
                        postCard.className = 'blog-post-card glass-effect p-6 rounded-xl';


                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-xl font-bold text-gray-800 dark:text-gray-100 cursor-pointer hover:text-amber-500 transition-colors';
                        titleEl.textContent = postData.title || 'BÃ i viáº¿t khÃ´ng cÃ³ tiÃªu Ä‘á»';
                        // (Gá»i hÃ m Ä‘Ã£ thá»‘ng nháº¥t)
                        titleEl.addEventListener('click', () => { openReaderModal({ id: postId, ...postData }); });
                        postCard.appendChild(titleEl);

                        const dateEl = document.createElement('p');
                        dateEl.className = 'text-xs text-gray-500 dark:text-gray-400 mb-4';
                        dateEl.textContent = postData.createdAt ? new Date(postData.createdAt.seconds * 1000).toLocaleString('vi-VN') : '...';
                        postCard.appendChild(dateEl);

                        const summaryEl = document.createElement('p');
                        summaryEl.className = 'text-gray-700 dark:text-gray-200 mt-4';
                        summaryEl.textContent = postData.summary || '(BÃ i viáº¿t nÃ y chÆ°a cÃ³ tÃ³m táº¯t...)';
                        postCard.appendChild(summaryEl);

                        if (postData.tags && postData.tags.length > 0) {
                            const tagsHTML = postData.tags.map(tag => {
                                // "Bá»C MÃ€U HÃ€NG HIá»†U" Cá»¦A Má» !
                                const colorClasses = getTagColorClasses(tag);
                                // "MÆ°á»£n" thÃªm máº¥y cÃ¡i class cÆ¡ báº£n
                                const baseClasses = "blog-tag-link text-xs font-medium py-1 px-2 rounded-full cursor-pointer";
                                // "Trá»™n" láº¡i!
                                return `<span class="${baseClasses} ${colorClasses}">${tag}</span>`;
                            }).join(' ');
                            const tagsDiv = document.createElement('div');
                            tagsDiv.className = 'mt-4 flex flex-wrap gap-2';
                            tagsDiv.innerHTML = tagsHTML;
                            postCard.appendChild(tagsDiv);
                        }

                        if (window.isAdmin) {
                            const adminButtonsHTML = `
                <div class="mt-4 flex gap-2">
                    <button class="blog-edit-btn text-sm text-blue-400 hover:text-blue-300" data-id="${postId}">[Sá»­a]</button>
                    <button class="blog-delete-btn text-sm text-red-400 hover:text-red-300" data-id="${postId}">[XÃ³a]</button>
                </div>`;
                            const adminDiv = document.createElement('div');
                            adminDiv.innerHTML = adminButtonsHTML;
                            postCard.appendChild(adminDiv);
                        }
                        blogPostsList.appendChild(postCard);
                    });

                } catch (error) {
                    console.error("Lá»—i khi lá»c tag:", error);
                    blogLoadingState.classList.add('hidden');

                    // ÄÃ‚Y LÃ€ "THáº¦N CHÃš" BÃO Lá»–I INDEX
                    if (error.code === 'failed-precondition') {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500 p-4 bg-red-100 dark:bg-red-900/50 rounded-lg">
                <b>Lá»—i "Ä‘á»¥ng nÃ³c" Firestore!</b><br>
                Ba Æ¡i, ba cáº§n táº¡o "Chá»‰ má»¥c" (Index) thÃ¬ má»›i lá»c tag Ä‘Æ°á»£c! <br>
                <span class="text-xs">(Lá»—i: ${error.message})</span>
            </p>`;
                    } else {
                        blogPostsList.innerHTML = `<p class="text-center text-red-500">Lá»c tag tháº¥t báº¡i.</p>`;
                    }
                }
            }


            // === HÃ€M "Máº®T THáº¦N" (V5) ===
            function handleObserver(entries) {
                if (!stickyCloseButton) return; // Náº¿u chÆ°a cÃ³ nÃºt thÃ¬ thÃ´i

                const entry = entries[0];
                if (entry.isIntersecting) {
                    // "Máº¯t tháº§n" THáº¤Y Ä‘Ã¡y bÃ i -> Hiá»‡n nÃºt
                    stickyCloseButton.classList.add('show');
                } else {
                    // "Máº¯t tháº§n" Máº¤T Dáº¤U Ä‘Ã¡y bÃ i -> áº¨n nÃºt
                    stickyCloseButton.classList.remove('show');
                }
            }

            // === HÃ€M "Máº¤T TÃCH" Má»  VIáº¾T BÃ™ CHO BA ===
            // (Gáº¯n dÃ¢y Ä‘iá»‡n cho cÃ¡c nÃºt cá»§a Admin)
            function initializeAdminBlogFeatures() {
                console.log("KÃ­ch hoáº¡t tÃ­nh nÄƒng Admin Blog (Táº¡o/Sá»­a/XÃ³a)...");

                // 1. Hiá»‡n nÃºt "Táº¡o bÃ i viáº¿t má»›i"
                if (blogAdminControls) {
                    blogAdminControls.classList.remove('hidden');
                }

                // 2. Gáº¯n sá»± kiá»‡n cho nÃºt "Táº¡o bÃ i viáº¿t má»›i"
                // (Con thÃªm .hasListener Ä‘á»ƒ nÃ³ khÃ´ng bá»‹ gáº¯n 2 láº§n)
                if (blogCreateNewBtn && !blogCreateNewBtn.hasListener) {
                    blogCreateNewBtn.addEventListener('click', () => {
                        openBlogEditor(null); // Má»Ÿ editor rá»—ng
                    });
                    blogCreateNewBtn.hasListener = true;
                }

                // 3. Gáº¯n sá»± kiá»‡n "cha" cho Sá»­a/XÃ³a (Event Delegation)
                if (blogPostsList && !blogPostsList.hasAdminListener) {
                    blogPostsList.addEventListener('click', async (e) => {
                        const target = e.target;
                        const postId = target.dataset.id;

                        // === Má»  THÃŠM "DÃ‚Y ÄIá»†N TAG" VÃ€O ÄÃ‚Y ===
                        if (target.classList.contains('blog-tag-link')) {
                            e.preventDefault(); // NgÄƒn hÃ nh vi láº¡
                            const tagName = target.textContent.trim();
                            console.log("Ba click vÃ o tag:", tagName);

                            // XÃ³a cÃ¡c thanh "Äang lá»c" cÅ© náº¿u cÃ³
                            document.querySelectorAll('#blog-filter-status').forEach(el => el.remove());

                            fetchBlogPostsByTag(tagName); // Gá»i hÃ m lá»c má»›i
                            return; // Click tag thÃ¬ thÃ´i, khÃ´ng lÃ m gÃ¬ ná»¯a
                        }
                        // === Háº¾T DÃ‚Y ÄIá»†N TAG ===

                        // Báº¥m nÃºt [Sá»­a]
                        if (target.classList.contains('blog-edit-btn') && postId) {
                            try {
                                const postDoc = await blogPostsRef.doc(postId).get();
                                if (postDoc.exists) {
                                    const postData = { id: postDoc.id, ...postDoc.data() };
                                    openBlogEditor(postData); // Má»Ÿ editor vá»›i data
                                } else {
                                    alert("Lá»—i: KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t nÃ y!");
                                }
                            } catch (error) {
                                console.error("Lá»—i khi láº¥y bÃ i viáº¿t Ä‘á»ƒ sá»­a:", error);
                                alert("Lá»—i khi táº£i bÃ i viáº¿t!");
                            }
                        }

                        // Báº¥m nÃºt [XÃ³a]
                        if (target.classList.contains('blog-delete-btn') && postId) {
                            const postCard = target.closest('.blog-post-card');
                            const titleEl = postCard ? postCard.querySelector('h3') : null;
                            const title = titleEl ? titleEl.textContent : 'bÃ i viáº¿t nÃ y';
                            deleteBlogPost(postId, title);
                        }
                    });
                    blogPostsList.hasAdminListener = true;
                }
            }

            /* ============================================================
            === Bá»˜ NÃƒO BADMINTON SCHEDULER (Báº¢N NÃ‚NG Cáº¤P AUTONUMERIC) ===
            ============================================================
            */
            // --- 1. Khai bÃ¡o biáº¿n toÃ n cá»¥c cho lá»‹ch ---
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('calendar-prev-month');
            const nextMonthBtn = document.getElementById('calendar-next-month');
            const totalDepositedEl = document.getElementById('badminton-total-deposited');
            const addDepositInput = document.getElementById('badminton-add-deposit');
            const submitDepositBtn = document.getElementById('badminton-submit-deposit');
            const totalDaysEl = document.getElementById('badminton-total-days');
            const totalCostEl = document.getElementById('badminton-total-cost');
            const remainingBalanceEl = document.getElementById('badminton-remaining-balance');
            let currentDate = new Date();
            let currentMonthData = {};
            let currentFund = {
                totalDeposited: 0,
                totalCostEver: 0,
                totalDaysEver: 0
            };
            // --- 2. HÃ m "Váº½ Lá»‹ch" (NÃ‚NG Cáº¤P AUTONUMERIC) ---
            // --- 2. HÃ m "Váº½ Lá»‹ch" (Báº¢N VÃ Lá»–I CRASH CUá»I CÃ™NG) ---
            async function renderCalendar(month, year) {
                console.log(`Äang váº½ lá»‹ch cho: ${month + 1}/${year}`);

                // === BÆ¯á»šC 1: Táº¢I DATA TRÆ¯á»šC ===
                await loadMonthData(month, year);

                monthYearHeader.textContent = `ThÃ¡ng ${month + 1} / ${year}`;

                let firstDayOfMonth = new Date(year, month, 1).getDay();
                let startDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                let daysInMonth = new Date(year, month + 1, 0).getDate();

                // === BÆ¯á»šC 2: Táº O CHUá»–I HTML (Táº O 1 Láº¦N) ===
                let calendarHtml = ''; // Táº¡o 1 chuá»—i rá»—ng

                // A. Váº½ cÃ¡c Ã´ "má»" cá»§a thÃ¡ng trÆ°á»›c
                for (let i = 0; i < startDay; i++) {
                    calendarHtml += `<div class="calendar-day not-in-month"></div>`; // Ná»‘i vÃ o chuá»—i
                }

                // B. Váº½ cÃ¡c Ã´ ngÃ y cá»§a thÃ¡ng nÃ y
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = currentMonthData[dateString] || {};
                    const isPresent = dayData.present || false;
                    const cost = dayData.cost || '';

                    // (ÄÃ£ xÃ³a placeholder="_" á»Ÿ Ä‘Ã¢y)
                    calendarHtml += `
<div class="calendar-day">
<span class="day-number">${day}</span>
<button 
class="day-toggle ${isPresent ? 'active' : ''}" 
data-date="${dateString}"
data-old-present="${isPresent}">
â—
</button>
<input 
type="text"  
class="day-cost-input" 
placeholder="_" 
value="${cost}"
data-date="${dateString}"
data-old-cost="${cost || 0}">
</div>
`; // Ná»‘i vÃ o chuá»—i
                }

                // === BÆ¯á»šC 3: "BÆ M" HTML VÃ€O Lá»ŠCH (CHá»ˆ 1 Láº¦N) ===
                calendarGrid.innerHTML = calendarHtml;

                // === BÆ¯á»šC 4: "Há»’I Sá»¨C" (setTimeout) TRÆ¯á»šC KHI Gá»ŒI AUTONUMERIC ===
                // ChiÃªu nÃ y Ä‘áº£m báº£o DOM Ä‘Ã£ "thá»Ÿ" xong
                setTimeout(() => {
                    try {
                        // C. Khá»Ÿi Ä‘á»™ng "HÃ ng hiá»‡u"
                        const anInputs = new AutoNumeric.multiple('.day-cost-input', {
                            decimalCharacter: ',',
                            digitGroupSeparator: '.',
                            decimalPlaces: 0,
                            minimumValue: '-999999999',
                            maximumValue: '999999999'
                        });

                        // LÆ°u instance vÃ o tá»«ng input
                        const inputs = calendarGrid.querySelectorAll('.day-cost-input');
                        inputs.forEach(input => {
                            input.autoNumericInstance = AutoNumeric.getAutoNumericElement(input);

                        });

                        // === BÆ¯á»šC 5: SAU KHI KHá»I Táº O XONG, Má»šI KHÃ“A/Má» ===
                        setCalendarInputsReadOnly(!window.isAdmin);

                        // === BÆ¯á»šC 6: TÃNH TOÃN Láº I TIá»€N (VÃŒ HÃ€M NÃ€Y Náº°M CUá»I CÃ™NG) ===
                        calculateThisMonthCost();


                    } catch (e) {
                        console.error("Lá»–I AUTONUMERIC NGHIÃŠM TRá»ŒNG:", e);
                        calendarGrid.innerHTML = `<p class="text-red-500 text-center">Lá»—i nghiÃªm trá»ng khi khá»Ÿi táº¡o AutoNumeric. KhÃ´ng thá»ƒ váº½ lá»‹ch.</p>`;
                    }
                }, 0); // Chá»‰ cáº§n 0ms Ä‘á»ƒ Ä‘áº©y nÃ³ ra sau
            }
            // --- 3. HÃ m "TÃ­nh toÃ¡n" ---
            function calculateThisMonthCost() {
                let thisMonthCost = 0;
                Object.values(currentMonthData).forEach(data => {
                    thisMonthCost += Number(data.cost || 0);
                });
                totalCostEl.textContent = `${thisMonthCost.toLocaleString('vi-VN')} Ä‘`;
            }
            function updateSummaryUI() {
                const remaining = currentFund.totalDeposited - currentFund.totalCostEver;
                totalDepositedEl.textContent = `${currentFund.totalDeposited.toLocaleString('vi-VN')} Ä‘`;
                totalDaysEl.textContent = `${currentFund.totalDaysEver} ngÃ y`;
                remainingBalanceEl.textContent = `${remaining.toLocaleString('vi-VN')} Ä‘`;
            }
            // --- 4. HÃ m "NÃ³i chuyá»‡n vá»›i Firestore" ---
            function loadFundData() {
                const fundRef = db.collection("badminton_fund").doc("global");
                fundRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        currentFund = doc.data();
                        console.log("ÄÃ£ táº£i Quá»¹:", currentFund);
                    } else {
                        console.log("ChÆ°a cÃ³ Quá»¹, Ä‘ang táº¡o má»›i...");
                        fundRef.set(currentFund);
                    }
                    updateSummaryUI();
                }, (error) => {
                    console.error("Lá»—i khi táº£i Quá»¹:", error);
                });
            }
            async function loadMonthData(month, year) {
                const monthString = String(month + 1).padStart(2, '0');
                const queryKey = `${year}-${monthString}`;
                const scheduleRef = db.collection("badminton_schedule");
                const snapshot = await scheduleRef
                    .where(firebase.firestore.FieldPath.documentId(), '>=', queryKey)
                    .where(firebase.firestore.FieldPath.documentId(), '<', `${queryKey}-32`)
                    .get();
                currentMonthData = {};
                snapshot.forEach(doc => {
                    currentMonthData[doc.id] = doc.data();
                });
                console.log(`ÄÃ£ táº£i data cho ${queryKey}:`, currentMonthData);
            }
            // HÃ m LÆ°u data (Báº¢N Sá»¬A Lá»–I LOGIC "Láº C QUAN" CUá»I CÃ™NG)
            // HÃ m LÆ°u data (Báº¢N Sá»¬A Lá»–I LOGIC "Láº C QUAN" CUá»I CÃ™NG)
            async function saveData(dateString, isPresent, newCost, oldIsPresent, oldCost) { // <<< Sá»¬A 1: Nháº­n newCost (dáº¡ng Sá»)
                const dayRef = db.collection("badminton_schedule").doc(dateString);
                const fundRef = db.collection("badminton_fund").doc("global");
                // === BÆ¯á»šC 1: TÃNH TOÃN TRÆ¯á»šC ===
                // const newCost = AutoNumeric.getNumber(costString); // <<< Sá»¬A 2: Bá» dÃ²ng lá»—i nÃ y Ä‘i
                const costDiff = newCost - Number(oldCost || 0);
                let dayDiff = 0;
                if (isPresent && !oldIsPresent) {
                    dayDiff = 1;
                } else if (!isPresent && oldIsPresent) {
                    dayDiff = -1;
                }
                // === BÆ¯á»šC 2: Cáº¬P NHáº¬T GIAO DIá»†N "Láº C QUAN" ===
                // (Pháº§n nÃ y Ä‘Ã£ Ä‘Ãºng, nÃ³ gá»i updateSummaryUI)
                if (costDiff !== 0 || dayDiff !== 0) {
                    // 1. Cáº­p nháº­t "bá»™ nhá»› Ä‘á»‡m" (cache)
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                    currentFund.totalCostEver += costDiff;
                    currentFund.totalDaysEver += dayDiff;
                    // 2. "Váº½" láº¡i UI NGAY Láº¬P Tá»¨C
                    updateSummaryUI();
                    calculateThisMonthCost(); // <<< THÃŠM DÃ’NG NÃ€Y Äá»‚ ADMIN Cáº¬P NHáº¬T
                } else {
                    // Náº¿u k sá»­a gÃ¬, chá»‰ cáº­p nháº­t cache
                    currentMonthData[dateString] = { present: isPresent, cost: newCost };
                }
                // === BÆ¯á»šC 3: Gá»¬I Lá»†NH LÆ¯U LÃŠN FIREBASE (CHáº Y NGáº¦M) ===
                const batch = db.batch();
                batch.set(dayRef, { present: isPresent, cost: newCost }, { merge: true });
                if (costDiff !== 0 || dayDiff !== 0) {
                    batch.update(fundRef, {
                        totalCostEver: firebase.firestore.FieldValue.increment(costDiff),
                        totalDaysEver: firebase.firestore.FieldValue.increment(dayDiff)
                    });
                }
                try {
                    await batch.commit();
                    console.log(`ÄÃ£ lÆ°u data (cháº¡y ngáº§m) ngÃ y ${dateString} vÃ  cáº­p nháº­t Quá»¹!`);
                } catch (error) {
                    console.error("Lá»—i khi lÆ°u data (cháº¡y ngáº§m):", error);
                }
            }
            // HÃ m Ná»™p Quá»¹ (Báº¢N "Láº C QUAN" CHUáº¨N + Sá» Ã‚M)
            // HÃ m Ná»™p Quá»¹ (Báº¢N "Láº C QUAN" CHUáº¨N + Sá» Ã‚M)
            async function submitDeposit() {
                const amount = addDepositInput.autoNumericInstance.getNumber();
                if (isNaN(amount) || amount === 0) {
                    alert("Ba gÃµ sá»‘ tiá»n (Ã¢m hoáº·c dÆ°Æ¡ng) vÃ o Ä‘i áº¡!");
                    return;
                }
                // === BÆ¯á»šC 1: Cáº¬P NHáº¬T GIAO DIá»†N "Láº C QUAN" ===
                currentFund.totalDeposited += amount;
                updateSummaryUI(); // DÃ’NG NÃ€Y Cáº¬P NHáº¬T 4 Ã” Tá»”NG Káº¾T
                // === BÆ¯á»šC 2: XÃ³a Ã´ input ===
                addDepositInput.autoNumericInstance.clear();
                // === BÆ¯á»šC 3: Gá»¬I Lá»†NH LÆ¯U LÃŠN FIREBASE (CHáº Y NGáº¦M) ===
                const fundRef = db.collection("badminton_fund").doc("global");
                try {
                    await fundRef.update({
                        totalDeposited: firebase.firestore.FieldValue.increment(amount)
                    });
                    if (amount > 0) {
                        console.log(`Ná»™p quá»¹ (cháº¡y ngáº§m) thÃ nh cÃ´ng: ${amount}`);
                    } else {
                        console.log(`RÃºt quá»¹ (cháº¡y ngáº§m) thÃ nh cÃ´ng: ${amount}`);
                    }
                } catch (error) {
                    console.error("Lá»—i khi ná»™p quá»¹ (cháº¡y ngáº§m):", error);
                }
            }
            // --- 5. GÃ¡n Sá»± kiá»‡n (Event Listeners) ---
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(currentDate.getMonth(), currentDate.getFullYear());
            });
            submitDepositBtn.addEventListener('click', submitDeposit);
            // DÃ‚Y ÄIá»†N NÃ‚NG Cáº¤P 1 (CLICK â—)
            // DÃ‚Y ÄIá»†N NÃ‚NG Cáº¤P 1 (CLICK â—)
            calendarGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('day-toggle')) {
                    if (!window.isAdmin) return; // <<< Báº¢O Vá»† CHá»NG GUEST
                    const button = e.target;
                    const dateString = button.dataset.date;
                    const input = document.querySelector(`.day-cost-input[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    button.classList.toggle('active');
                    const newIsPresent = button.classList.contains('active');
                    // === Sá»¬A Lá»–I Náº°M á» ÄÃ‚Y ===
                    // Pháº£i láº¥y Sá» tá»« instance AutoNumeric, khÃ´ng láº¥y CHá»® (string)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    button.dataset.oldPresent = newIsPresent;
                    // Truyá»n con Sá» (newCostNumber) vÃ o hÃ m saveData
                    saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                }
            });
            // DÃ‚Y ÄIá»†N NÃ‚NG Cáº¤P 2 (GÃ• TIá»€N)
            calendarGrid.addEventListener('focusout', (e) => {

                if (e.target.classList.contains('day-cost-input')) {
                    if (!window.isAdmin) return;
                    const input = e.target;
                    const dateString = input.dataset.date;
                    const button = document.querySelector(`.day-toggle[data-date="${dateString}"]`);
                    const oldIsPresent = (button.dataset.oldPresent === 'true');
                    const oldCost = Number(input.dataset.oldCost || 0);
                    const newIsPresent = button.classList.contains('active');
                    // === Sá»¬A Lá»–I Náº°M á» ÄÃ‚Y ===
                    // Láº¥y Sá» (giá»‘ng nhÆ° hÃ m trÃªn)
                    const newCostNumber = input.autoNumericInstance.getNumber();
                    if (newCostNumber !== oldCost) {
                        input.dataset.oldCost = newCostNumber;
                        // Truyá»n con Sá» (newCostNumber) vÃ o hÃ m saveData
                        saveData(dateString, newIsPresent, newCostNumber, oldIsPresent, oldCost);
                    }
                }
            });
            /* ============================================================
            === Háº¾T Bá»˜ NÃƒO BADMINTON ===
            ============================================================
            */
            // === CODE CÅ¨ Cá»¦A BA (Má»  Gá»˜P VÃ€O ÄÃ‚Y) ===
            // --- Bá»˜ Äáº¾M TRUY Cáº¬P (CÅ¨ Cá»¦A BA) ---
            async function updateVisitCount() {
                const counterElement = document.getElementById('visit-counter');
                if (!counterElement) return;
                const docRef = db.collection("stats").doc("global");
                docRef.update({
                    visits: firebase.firestore.FieldValue.increment(1)
                }).catch(error => {
                    if (error.code === 'not-found') {
                        docRef.set({ visits: 1 }).catch(err => console.error("Lá»—i táº¡o Document láº§n Ä‘áº§u:", err));
                    } else {
                        console.error("Lá»—i tÄƒng lÆ°á»£t truy cáº­p:", error);
                    }
                });
                docRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const count = doc.data().visits;
                        counterElement.innerHTML = `LÆ°á»£t truy cáº­p: <strong>${count.toLocaleString('vi-VN')}</strong>`;
                    }
                }, (error) => {
                    console.error("Lá»—i Ä‘á»c lÆ°á»£t truy cáº­p (listener):", error);
                    counterElement.textContent = 'LÆ°á»£t truy cáº­p: KhÃ´ng thá»ƒ táº£i.';
                });
            }
            updateVisitCount();
            // --- Theme Toggle Logic (CÅ¨ Cá»¦A BA) ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
            } else {
                darkIcon.classList.remove('hidden');
            }
            themeToggleBtn.addEventListener('click', () => {
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });
            // --- Navigation Logic (CÅ¨ Cá»¦A BA) ---
            const navLinks = document.querySelectorAll('.nav-link');
            const toolContents = document.querySelectorAll('.tool-content');
            function showTool(toolId) {
                navLinks.forEach(nav => nav.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-tool="${toolId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                let targetFound = false;
                toolContents.forEach(content => {
                    if (content.id === `tool-${toolId}`) {
                        targetFound = true;
                        content.classList.remove('hidden');
                        setTimeout(() => content.classList.remove('opacity-0'), 10);
                        // === THáº¦N CHÃš Cá»¦A Má»  (Gá»ŒI HÃ€M BLOG) ===
                        // (MÃ¬nh chá»‰ táº£i 1 láº§n Ä‘áº§u tiÃªn thÃ´i nha ba)
                        if (toolId === 'my-research' && !window.isBlogInitialized) {
                            console.log("Láº§n Ä‘áº§u vÃ o 'My Research', táº£i blog...");
                            loadBlogPosts(); // Táº£i blog láº§n Ä‘áº§u
                            window.isBlogInitialized = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ táº£i
                        }
                        // === Háº¾T THáº¦N CHÃš ===

                        // === Má»  THÃŠM: CHO GUEST XEM Lá»ŠCH ===
                        if (toolId === 'badminton-scheduler' && !window.calendarInitialized) {
                            console.log("Láº§n Ä‘áº§u vÃ o 'B Scheduler', táº£i lá»‹ch (cho cáº£ Guest)...");
                            // Guest khÃ´ng cáº§n AutoNumeric cho Ã´ "Ná»™p thÃªm", chá»‰ cáº§n táº£i data
                            loadFundData(); // Táº£i Quá»¹
                            renderCalendar(currentDate.getMonth(), currentDate.getFullYear()); // Váº½ lá»‹ch
                            window.calendarInitialized = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ táº£i
                        }
                        // === Háº¾T PHáº¦N THÃŠM ===

                    } else {
                        content.classList.add('opacity-0');
                        setTimeout(() => {
                            content.classList.add('hidden');
                        }, 400);
                    }
                    if (toolId === 'admin-panel' && window.isAdmin) {
                        initializeAdminPanelToggles();
                    }
                });
                if (!targetFound && navLinks.length > 0) {
                    const defaultToolId = navLinks[0].dataset.tool;
                    if (toolId !== defaultToolId) {
                        showTool(defaultToolId);
                    }
                }
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const toolId = link.dataset.tool;
                    history.pushState({ toolId: toolId }, '', `#${toolId}`);
                    showTool(toolId);
                });
            });
            window.addEventListener('popstate', (e) => {
                if (e.state && e.state.toolId) {
                    showTool(e.state.toolId);
                } else {
                    showTool(navLinks[0].dataset.tool);
                }
            });
            const initialToolId = window.location.hash.substring(1) || navLinks[0].dataset.tool;
            showTool(initialToolId);
            // --- BG Removal Logic (CÅ¨ Cá»¦A BA) ---
            const bgRemoveInput = document.getElementById('bg-remove-input');
            const bgRemoveFilename = document.getElementById('bg-remove-filename');
            const bgRemovePreviews = document.getElementById('bg-remove-previews');
            const bgRemoveOriginal = document.getElementById('bg-remove-original');
            const bgRemoveResult = document.getElementById('bg-remove-result');
            const bgRemoveLoader = document.getElementById('bg-remove-loader');
            const bgRemoveProcessBtn = document.getElementById('bg-remove-process-btn');
            const bgRemoveDownloadBtn = document.getElementById('bg-remove-download-btn');
            const bgRemoveStatus = document.getElementById('bg-remove-status');
            let resultBlob = null;
            if (bgRemoveInput) {
                bgRemoveInput.addEventListener('change', () => {
                    const file = bgRemoveInput.files[0];
                    if (file) {
                        bgRemoveFilename.textContent = file.name;
                        resultBlob = null;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            bgRemoveOriginal.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        bgRemovePreviews.classList.remove('hidden');
                        bgRemoveResult.classList.add('hidden');
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveDownloadBtn.disabled = true;
                        bgRemoveStatus.textContent = 'Sáºµn sÃ ng Ä‘á»ƒ tÃ¡ch ná»n.';
                        bgRemoveProcessBtn.disabled = false;
                    } else {
                        bgRemoveFilename.textContent = 'ChÆ°a chá»n tá»‡p nÃ o.';
                    }
                });
                bgRemoveProcessBtn.addEventListener('click', async () => {
                    const file = bgRemoveInput.files[0];
                    if (!file) return;
                    bgRemoveLoader.classList.remove('hidden');
                    bgRemoveResult.classList.add('hidden');
                    bgRemoveStatus.textContent = 'Äang táº£i áº£nh lÃªn vÃ  xá»­ lÃ½...';
                    bgRemoveProcessBtn.disabled = true;
                    bgRemoveDownloadBtn.disabled = true;
                    const formData = new FormData();
                    formData.append('image_file', file);
                    try {
                        const response = await fetch('/api/photoroom', {
                            method: 'POST',
                            body: formData,
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail || `Lá»—i HTTP: ${response.status}`);
                        }
                        // === MÃƒ Má»šI Báº®T Äáº¦U ===
                        // 1. Äá»c sá»‘ lÆ°á»£t cÃ²n láº¡i tá»« header mÃ  server gá»­i vá»
                        const quotaRemaining = response.headers.get('X-My-Quota-Remaining');
                        // === MÃƒ Má»šI Káº¾T THÃšC ===

                        resultBlob = await response.blob();
                        const url = URL.createObjectURL(resultBlob);
                        bgRemoveResult.src = url;
                        bgRemoveResult.classList.remove('hidden');

                        // === MÃƒ Má»šI Báº®T Äáº¦U ===
                        // 2. Hiá»ƒn thá»‹ thÃ´ng bÃ¡o kÃ¨m sá»‘ lÆ°á»£t
                        if (quotaRemaining) {
                            bgRemoveStatus.textContent = `TÃ¡ch ná»n thÃ nh cÃ´ng! (Sá»‘ lÆ°á»£t API cÃ²n láº¡i: ${quotaRemaining})`;
                        } else {
                            bgRemoveStatus.textContent = 'TÃ¡ch ná»n thÃ nh cÃ´ng!';
                        }
                        // === MÃƒ Má»šI Káº¾T THÃšC ===

                        bgRemoveDownloadBtn.disabled = false;
                    } catch (error) {
                        console.error("Photoroom API error:", error);
                        bgRemoveStatus.textContent = `Lá»—i: ${error.message}`;
                    } finally {
                        bgRemoveLoader.classList.add('hidden');
                        bgRemoveProcessBtn.disabled = false;
                    }
                });
                bgRemoveDownloadBtn.addEventListener('click', () => {
                    if (resultBlob) {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(resultBlob);
                        const originalFileName = bgRemoveInput.files[0].name.split('.').slice(0, -1).join('.');
                        link.download = `${originalFileName}-removed-bg.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
            }
            // --- PNG to ICO Logic (CÅ¨ Cá»¦A BA) ---
            const pngFileInput = document.getElementById('png-file-input');
            const pngFilename = document.getElementById('png-filename');
            const convertBtn = document.getElementById('convert-to-ico-btn');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const icoStatus = document.getElementById('ico-status');
            const icoSizeSelect = document.getElementById('ico-size-select');
            if (pngFileInput) {
                pngFileInput.addEventListener('change', () => {
                    const file = pngFileInput.files[0];
                    if (file) {
                        pngFilename.textContent = file.name;
                        convertBtn.disabled = false;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        pngFilename.textContent = 'ChÆ°a chá»n tá»‡p nÃ o.';
                        convertBtn.disabled = true;
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
                convertBtn.addEventListener('click', () => {
                    const file = pngFileInput.files[0];
                    if (!file) return;
                    const size = parseInt(icoSizeSelect.value, 10);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, size, size);
                            const icoData = createIco(ctx, size);
                            const blob = new Blob([icoData], { type: 'image/x-icon' });
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'favicon.ico';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            icoStatus.textContent = `Tá»‡p favicon.ico (${size}x${size}) Ä‘Ã£ Ä‘Æ°á»£c táº£i xuá»‘ng!`;
                            setTimeout(() => { icoStatus.textContent = '' }, 3000);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                function createIco(ctx, size) {
                    const imageData = ctx.getImageData(0, 0, size, size).data;
                    const buffer = new ArrayBuffer(22 + 40 + (size * size * 4));
                    const view = new DataView(buffer);
                    view.setUint16(0, 0, true); view.setUint16(2, 1, true); view.setUint16(4, 1, true);
                    view.setUint8(6, size); view.setUint8(7, size); view.setUint8(8, 0); view.setUint8(9, 0);
                    view.setUint16(10, 1, true); view.setUint16(12, 32, true);
                    view.setUint32(14, 40 + (size * size * 4), true); view.setUint32(18, 22, true);
                    let offset = 22;
                    view.setUint32(offset, 40, true); offset += 4;
                    view.setUint32(offset, size, true); offset += 4;
                    view.setUint32(offset, size * 2, true); offset += 4;
                    view.setUint16(offset, 1, true); offset += 2;
                    view.setUint16(offset, 32, true); offset += 2;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, size * size * 4, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    view.setUint32(offset, 0, true); offset += 4;
                    for (let y = size - 1; y >= 0; y--) {
                        for (let x = 0; x < size; x++) {
                            const i = (y * size + x) * 4;
                            view.setUint8(offset++, imageData[i + 2]); view.setUint8(offset++, imageData[i + 1]);
                            view.setUint8(offset++, imageData[i]); view.setUint8(offset++, imageData[i + 3]);
                        }
                    }
                    return new Uint8Array(buffer);
                }
            }
            // --- Base64 Logic (CÅ¨ Cá»¦A BA) ---
            const base64Input = document.getElementById('base64-input');
            const base64Output = document.getElementById('base64-output');
            const encodeBtn = document.getElementById('base64-encode-btn');
            const decodeBtn = document.getElementById('base64-decode-btn');
            const base64Status = document.getElementById('base64-status');
            if (base64Input) {
                function safeBtoa(str) { try { return btoa(unescape(encodeURIComponent(str))); } catch (e) { return null; } }
                function safeAtob(str) { try { return decodeURIComponent(escape(atob(str))); } catch (e) { return null; } }
                encodeBtn.addEventListener('click', () => {
                    const input = base64Input.value;
                    if (!input) { base64Output.value = ''; return; }
                    const encoded = safeBtoa(input);
                    base64Output.value = encoded ? encoded : 'Lá»—i: Dá»¯ liá»‡u Ä‘áº§u vÃ o khÃ´ng há»£p lá»‡.';
                    base64Status.textContent = encoded ? 'MÃ£ hÃ³a thÃ nh cÃ´ng!' : 'MÃ£ hÃ³a tháº¥t báº¡i.';
                    setTimeout(() => { base64Status.textContent = '' }, 3000);
                });
                decodeBtn.addEventListener('click', () => {
                    let currentString = base64Input.value;
                    if (!currentString) { base64Output.value = ''; return; }
                    let decodeCount = 0;
                    let lastValidString = currentString;
                    while (true) {
                        const decoded = safeAtob(currentString);
                        if (decoded !== null && decoded !== currentString) {
                            currentString = decoded;
                            lastValidString = decoded;
                            decodeCount++;
                        } else { break; }
                    }
                    base64Output.value = lastValidString;
                    base64Status.textContent = decodeCount > 0 ? `Giáº£i mÃ£ thÃ nh cÃ´ng qua ${decodeCount} lá»›p.` : 'KhÃ´ng thá»ƒ giáº£i mÃ£ thÃªm, chuá»—i khÃ´ng pháº£i lÃ  Base64 há»£p lá»‡.';
                    setTimeout(() => { base64Status.textContent = '' }, 4000);
                });
            }
            // --- My Apps Logic (CÅ¨ Cá»¦A BA) ---
            const appsListContainer = document.getElementById('apps-list');
            const appsLoader = document.getElementById('apps-loader');
            const appsEmptyState = document.getElementById('apps-empty-state');
            if (appsListContainer) {
                db.collection("my_apps").onSnapshot((querySnapshot) => {
                    appsLoader.classList.add('hidden');
                    const appCards = appsListContainer.querySelectorAll('.app-card');
                    appCards.forEach(card => card.remove());
                    if (querySnapshot.empty) {
                        appsEmptyState.classList.remove('hidden');
                    } else {
                        appsEmptyState.classList.add('hidden');
                        querySnapshot.forEach((doc) => {
                            const app = doc.data();
                            const appId = doc.id;
                            let iconHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`;
                            if (app.iconUrl && app.iconUrl.trim() !== '') {
                                iconHTML = `<img src="${app.iconUrl}" class="h-full w-full object-contain" alt="${app.appName || 'App'} icon">`;
                            }
                            const appCardHTML = `
<div class="app-card glass-effect p-6 rounded-xl shadow-md transition-all duration-300 flex flex-col sm:flex-row items-start sm:items-center gap-6">
<div class="flex-shrink-0 w-32 h-32 bg-white/70 dark:bg-white/10 rounded-lg flex items-center justify-center overflow-hidden">
${iconHTML}
</div>
<div class="flex-grow">
<h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${app.appName || 'KhÃ´ng cÃ³ tÃªn'}</h3>
<p class="text-gray-600 dark:text-gray-200 mt-1">${app.description || 'KhÃ´ng cÃ³ mÃ´ táº£.'}</p>
<div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
<span>Sá»‘ lÆ°á»£t táº£i: </span>
<span class="font-semibold" id="count-${appId}">${app.downloadCount || 0}</span>
</div>
</div>
<div class="w-full sm:w-auto flex-shrink-0">
<button class="download-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg hover:shadow-amber-500/40 flex items-center justify-center gap-2" data-doc-id="${appId}" data-url="${app.downloadUrl || '#'}">
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
<span>Táº£i vá»</span>
</button>
</div>
</div>`;
                            appsListContainer.insertAdjacentHTML('beforeend', appCardHTML);
                        });
                    }
                }, (error) => {
                    console.error("Error getting documents: ", error);
                    appsLoader.classList.add('hidden');
                    appsListContainer.innerHTML = '<p class="text-center text-red-500">ÄÃ£ xáº£y ra lá»—i khi táº£i danh sÃ¡ch á»©ng dá»¥ng.</p>';
                });
                appsListContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('.download-btn');
                    if (button) {
                        const docId = button.dataset.docId;
                        const url = button.dataset.url;
                        if (!docId || url === '#') {
                            console.error('Lá»—i: KhÃ´ng tÃ¬m tháº¥y Ä‘Æ°á»ng link táº£i vá» cho á»©ng dá»¥ng nÃ y.');
                            return;
                        }
                        const appRef = db.collection('my_apps').doc(docId);
                        appRef.update({
                            downloadCount: firebase.firestore.FieldValue.increment(1)
                        }).then(() => {
                            console.log("Download count updated!");
                            window.open(url, '_blank');
                        }).catch((error) => {
                            console.error("Error updating document: ", error);
                            window.open(url, '_blank');
                        });
                    }
                });
            }
            // === Má»  Gáº®N DÃ‚Y ÄIá»†N CHO CÃC NÃšT CHUNG (BLOG) ===

            // 1. NÃºt PhÃ¢n Trang (Pagination)
            if (blogPrevBtn) {
                blogPrevBtn.addEventListener('click', () => {
                    if (blogCurrentPage > 1) {
                        blogCurrentPage--;
                        fetchBlogPage();
                    }
                });
            }
            if (blogNextBtn) {
                blogNextBtn.addEventListener('click', () => {
                    if (blogCurrentPage < blogTotalPages) {
                        blogCurrentPage++;
                        fetchBlogPage();
                    }
                });
            }

            // 2. NÃºt trong Editor (LÆ°u / Há»§y)
            if (blogEditorSaveBtn) {
                blogEditorSaveBtn.addEventListener('click', saveBlogPost);
            }
            if (blogEditorCancelBtn) {
                blogEditorCancelBtn.addEventListener('click', () => {
                    blogEditorModal.classList.add('hidden');
                    if (tinymce.get('blog-editor-textarea')) {
                        tinymce.get('blog-editor-textarea').destroy();
                    }
                });
            }



        }); // Háº¿t DOMContentLoaded
    </script>
    <script>
        let daPhatNhacLanDau = false;
        document.addEventListener('click', function () {
            if (!daPhatNhacLanDau) {
                let fileNhac = document.getElementById('nhac-nen-cua-ba');
                if (fileNhac) {
                    fileNhac.volume = 0.15;
                    fileNhac.play().catch(error => {
                        console.log("TrÃ¬nh duyá»‡t cháº·n tá»± Ä‘á»™ng phÃ¡t nháº¡c:", error);
                    });
                    daPhatNhacLanDau = true;
                }
            }
        });
    </script>
</body>

</html>